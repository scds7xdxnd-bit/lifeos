# LifeOS Nightly Pipeline
# Purpose: Slow tests, ML model validation, dependency updates
# Trigger: Scheduled (2 AM UTC daily)

name: Nightly - Full Validation

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  APP_ENV: ci

jobs:
  full-test-suite:
    name: Full Test Suite (All Markers)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: lifeos
          POSTGRES_PASSWORD: lifeos
          POSTGRES_DB: lifeos_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: lifeos/requirements.txt
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r lifeos/requirements.txt
          pip install pytest pytest-cov pytest-timeout pytest-xdist
      
      - name: Run migrations
        env:
          DATABASE_URL: postgresql://lifeos:lifeos@localhost/lifeos_test
          FLASK_APP: lifeos.wsgi
          PYTHONPATH: ${{ github.workspace }}
        run: cd lifeos && flask db upgrade head
      
      - name: Run full test suite
        env:
          PYTHONPATH: ${{ github.workspace }}
          DATABASE_URL: postgresql://lifeos:lifeos@localhost/lifeos_test
          REDIS_URL: redis://localhost:6379/0
          APP_ENV: ci
          ENABLE_ML: true
        run: |
          pytest lifeos/tests/ \
            --tb=short \
            --cov=lifeos \
            --cov-report=xml:coverage-nightly.xml \
            --cov-report=html:htmlcov \
            --junitxml=test-results-nightly.xml \
            -v \
            --timeout=300
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-nightly
          path: |
            coverage-nightly.xml
            htmlcov/
          retention-days: 30
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-nightly
          path: test-results-nightly.xml
          retention-days: 30

  ml-model-validation:
    name: ML Model Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    continue-on-error: true  # Don't fail nightly on ML issues
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: lifeos/requirements.txt
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r lifeos/requirements.txt
          pip install pytest pytest-timeout
      
      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: lifeos/ml_assets
          key: ml-models-${{ hashFiles('lifeos/ml_assets/**') }}
          restore-keys: |
            ml-models-
      
      - name: Run ML tests
        env:
          PYTHONPATH: ${{ github.workspace }}
          ENABLE_ML: true
        run: |
          pytest lifeos/tests/ \
            -m "ml" \
            --tb=short \
            --junitxml=test-results-ml.xml \
            -v \
            --timeout=300
      
      - name: Validate model performance
        run: |
          echo "Validating ML model performance metrics..."
          # Add model performance validation here
          # e.g., check accuracy thresholds, inference time

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install audit tools
        run: pip install pip-audit safety
      
      - name: Check for vulnerabilities
        run: |
          echo "=== Running pip-audit ==="
          pip-audit -r lifeos/requirements.txt --format json --output pip-audit-report.json || true
          pip-audit -r lifeos/requirements.txt || true
          
          echo ""
          echo "=== Running safety check ==="
          safety check --file lifeos/requirements.txt --output json > safety-report.json || true
          safety check --file lifeos/requirements.txt || true
      
      - name: Check for outdated packages
        run: |
          echo "=== Checking for outdated packages ==="
          pip install pip-tools
          pip list --outdated --format json > outdated-packages.json || true
          pip list --outdated || true
      
      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit
          path: |
            pip-audit-report.json
            safety-report.json
            outdated-packages.json
          retention-days: 30

  coverage-report:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: full-test-suite
    steps:
      - uses: actions/checkout@v4
      
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-nightly
      
      - name: Coverage summary
        run: |
          echo "=== Coverage Summary ==="
          # Add coverage threshold check
          # coverage report --fail-under=80
      
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage-nightly.xml
          flags: nightly
          fail_ci_if_error: false

  notify-results:
    name: Notify Nightly Results
    runs-on: ubuntu-latest
    needs: [full-test-suite, ml-model-validation, dependency-audit]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "=== Nightly Build Summary ==="
          echo "Full Test Suite: ${{ needs.full-test-suite.result }}"
          echo "ML Validation: ${{ needs.ml-model-validation.result }}"
          echo "Dependency Audit: ${{ needs.dependency-audit.result }}"
          
          if [ "${{ needs.full-test-suite.result }}" == "failure" ]; then
            echo "❌ Nightly tests failed - investigation required"
            # Add Slack/email notification for failures
          else
            echo "✅ Nightly tests passed"
          fi

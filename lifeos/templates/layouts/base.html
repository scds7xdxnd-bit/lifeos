<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>LifeOS</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%232c5aa0'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-family='Arial, sans-serif' font-size='28' fill='white'%3EL%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script>
      const LIFEOS_TOKEN_KEY = "lifeos_tokens";
      function getTokens() {
        try { return JSON.parse(localStorage.getItem(LIFEOS_TOKEN_KEY) || "{}"); } catch (_) { return {}; }
      }
      function setTokens(tokens) {
        localStorage.setItem(LIFEOS_TOKEN_KEY, JSON.stringify(tokens || {}));
      }
      function clearTokens() { localStorage.removeItem(LIFEOS_TOKEN_KEY); }
      function authHeaders(extra = {}) {
        const t = getTokens();
        const headers = Object.assign({}, extra);
        if (t.access_token) headers["Authorization"] = "Bearer " + t.access_token;
        if (t.csrf_token) headers["X-CSRF-Token"] = t.csrf_token;
        return headers;
      }
      const lifeosTelemetry = (() => {
        const track = (eventType, payload = {}) => {
          const detail = { event_type: eventType, payload, emitted_at: new Date().toISOString() };
          window.dispatchEvent(new CustomEvent("lifeos:telemetry", { detail }));
          const endpoint = window.LIFEOS_TELEMETRY_ENDPOINT;
          if (endpoint && typeof navigator?.sendBeacon === "function") {
            try {
              navigator.sendBeacon(endpoint, JSON.stringify(detail));
            } catch (_) {
              /* ignore client telemetry failures */
            }
          }
        };
        return { track };
      })();
      window.lifeosAuth = { getTokens, setTokens, clearTokens, authHeaders };
      window.lifeosTelemetry = lifeosTelemetry;
    </script>
  </head>
  <body>
    <header class="app-header">
      <div class="nav-shell">
        <div class="nav-brand">
          <div class="brand-mark">LifeOS</div>
          <div class="brand-sub">Calm accountability OS</div>
        </div>
        <nav class="top-nav">
          <a href="/calendar/" class="nav-link-strong">Calendar</a>
          <div class="nav-group" id="nav-finance">
            <a href="#" class="nav-group-toggle" aria-haspopup="true" aria-expanded="false">Finance</a>
            <div class="nav-group-menu" role="menu">
              <a href="/finance/" role="menuitem">Dashboard</a>
              <a href="/finance/journal" role="menuitem">Journal</a>
              <a href="/finance/trial-balance" role="menuitem">Trial balance</a>
              <a href="/finance/receivables" role="menuitem">Receivables</a>
              <a href="/finance/forecast" role="menuitem">Forecast</a>
              <a href="/finance/import" role="menuitem">Import</a>
            </div>
          </div>
          <a href="/habits/">Habits</a>
          <a href="/skills/">Skills</a>
          <a href="/health/">Health</a>
          <a href="/journal/">Journal</a>
          <a href="/relationships/">Relationships</a>
          <a href="/projects/">Projects</a>
          <a href="/users/profile">Profile</a>
        </nav>
        <div class="nav-actions">
          <div id="auth-logged-in" class="auth-logged auth-hidden" aria-live="polite">
            <span id="auth-user-label"></span>
            <button type="button" id="auth-logout-btn" class="btn btn-secondary btn-ghost">Logout</button>
          </div>
          <button type="button" class="btn btn-ghost" id="auth-login-link" onclick="window.location.href='/login'">Sign in</button>
        </div>
      </div>
      <div class="nav-demo-credentials">Demo: admin@example.com / admin12345 or demo@lifeos.test / demo12345</div>
    </header>
    <main>
      {% block content %}{% endblock %}
    </main>
    <script>
      const loggedInRow = document.getElementById('auth-logged-in');
      const authUserLabel = document.getElementById('auth-user-label');
      const authLoginLink = document.getElementById('auth-login-link');
      const logoutBtn = document.getElementById('auth-logout-btn');
      const financeGroup = document.getElementById('nav-finance');
      const financeToggle = financeGroup?.querySelector('.nav-group-toggle');

      const emitAuthChange = () => {
        const tokens = getTokens();
        const loggedIn = !!(tokens && tokens.user && tokens.access_token);
        window.dispatchEvent(new CustomEvent('lifeos:auth-changed', { detail: { loggedIn, user: tokens?.user || null } }));
      };

      const updateAuthUI = () => {
        const tokens = getTokens();
        const loggedIn = tokens && tokens.user && tokens.access_token;
        if (loggedIn) {
          loggedInRow?.classList.remove('auth-hidden');
          authLoginLink?.classList.add('auth-hidden');
          if (authUserLabel) authUserLabel.textContent = '';
        } else {
          loggedInRow?.classList.add('auth-hidden');
          authLoginLink?.classList.remove('auth-hidden');
          if (authUserLabel) authUserLabel.textContent = '';
        }
        emitAuthChange();
      };

      const ensureServerSession = async () => {
        const tokens = getTokens();
        if (!tokens?.access_token) {
          updateAuthUI();
          return;
        }
        try {
          const res = await fetch('/auth/me', { headers: lifeosAuth.authHeaders() });
          if (!res.ok) throw new Error('unauthorized');
          const body = await res.json().catch(() => ({}));
          if (body?.ok && body.user) {
            setTokens({ ...tokens, user: body.user });
            updateAuthUI();
            return;
          }
        } catch (_) {
          /* noop */
        }
        clearTokens();
        updateAuthUI();
      };

      // Global 401 handler to keep UI in sync with server
      // Note: 403 is NOT handled here as it may indicate permission issues, not invalid auth
      const originalFetch = window.fetch.bind(window);
      window.fetch = async (...args) => {
        const res = await originalFetch(...args);
        if (res && res.status === 401) {
          // Only clear tokens on 401 (unauthorized) - token is invalid/expired
          clearTokens();
          updateAuthUI();
          if (window.location.pathname !== '/login') {
            window.location.href = '/login';
          }
        }
        return res;
      };

      logoutBtn?.addEventListener('click', () => {
        clearTokens();
        lifeosTelemetry.track('auth.user.logout', { source: 'ui' });
        updateAuthUI();
        window.location.href = '/login';
      });

      // Finance dropdown toggle with outside click close
      const closeFinance = () => {
        financeGroup?.classList.remove('open');
        if (financeToggle) financeToggle.setAttribute('aria-expanded', 'false');
      };
      financeToggle?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = financeGroup.classList.toggle('open');
        financeToggle.setAttribute('aria-expanded', String(isOpen));
      });
      document.addEventListener('click', (e) => {
        if (!financeGroup?.contains(e.target)) {
          closeFinance();
        }
      });

      // Expose a promise that resolves after the initial server session check.
      // Page-level scripts can await this to avoid firing API calls with stale/invalid tokens.
      const authReady = Promise.resolve().then(() => ensureServerSession()).catch(() => {});
      window.lifeosAuthReady = authReady;
      authReady.finally(() => window.dispatchEvent(new CustomEvent('lifeos:auth-ready')));
    </script>
    <!-- Finance domain scripts -->
    <script src="{{ url_for('static', filename='js/finance-account-subtypes.js') }}"></script>
    <script src="{{ url_for('static', filename='js/finance-account-search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/finance-account-categories.js') }}"></script>
    <!-- Calendar domain scripts -->
    <script src="{{ url_for('static', filename='js/calendar-api.js') }}"></script>
    <script>
      // Ensure modules are available globally with timeout protection
      (function ensureModules(attempts = 0) {
        const maxAttempts = 100; // ~5 seconds with 50ms intervals
        const allLoaded = window.lifeosAccountSearch && window.lifeosAccountSubtypes && window.lifeosAccountCategories && window.lifeosCalendar;
        if (!allLoaded) {
          if (attempts < maxAttempts) {
            setTimeout(() => ensureModules(attempts + 1), 50);
          } else {
            console.error('[LifeOS] Modules failed to load after timeout', {
              hasAccountSearch: !!window.lifeosAccountSearch,
              hasAccountSubtypes: !!window.lifeosAccountSubtypes,
              hasAccountCategories: !!window.lifeosAccountCategories,
              hasCalendar: !!window.lifeosCalendar,
            });
          }
        } else if (attempts > 0) {
          // Log successful load on retry (helps debug load timing issues)
          console.debug('[LifeOS] Modules loaded after retry', { attempts });
        }
      })();
    </script>
  </body>
</html>

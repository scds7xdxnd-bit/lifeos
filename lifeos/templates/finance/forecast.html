{% extends "layouts/base.html" %}
{% block content %}
<div class="container" style="max-width: 1000px; margin: 0 auto; padding: 1rem 0; display:grid; gap:1rem;">
  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items:center; gap:0.75rem; flex-wrap:wrap;">
      <div>
        <h2 style="margin:0;">Schedule & Forecast</h2>
        <p style="margin:0; color:#5b6470;">Add scheduled events, update/delete, and view forecast rollups.</p>
      </div>
      <button type="button" class="btn btn-secondary" id="sched-reload">Reload</button>
    </div>
    <div id="sched-login-hint" style="margin-top:0.5rem; color:#b3352f; display:none;">Please log in to manage schedule.</div>
    <form id="sched-form" style="display:grid; gap:0.5rem; margin-top:0.75rem;">
      <div class="field">
        <label for="sched-account">Account</label>
        <div class="account-search-wrapper" id="sched-account-wrapper" style="position: relative;">
          <input
            type="hidden"
            id="sched-account-id"
            name="account_id"
            required
          >
          <input
            type="text"
            class="account-search-input"
            id="sched-account-input"
            placeholder="Search or create account..."
            autocomplete="off"
            style="width: 100%;"
          >
          <div
            class="account-search-dropdown"
            id="sched-account-dropdown"
            role="listbox"
            style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;"
          >
            <div id="sched-account-loading" style="display: none; padding: 0.5rem; color: #5b6470; text-align: center;">
              <span>Searching...</span>
            </div>
            <div id="sched-account-results" style="max-height: 250px; overflow-y: auto;"></div>
            <div id="sched-account-empty" style="padding: 0.5rem; color: #5b6470; text-align: center; display: none;">
              No accounts found
            </div>
          </div>
        </div>
      </div>
      <div style="display:grid; gap:0.5rem; grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
        <div class="field">
          <label for="sched-date">Event date</label>
          <input id="sched-date" name="event_date" type="date" required>
        </div>
        <div class="field">
          <label for="sched-amount">Amount</label>
          <input id="sched-amount" name="amount" type="number" step="0.01" required>
        </div>
      </div>
      <div class="field">
        <label for="sched-memo">Memo</label>
        <input id="sched-memo" name="memo" type="text" placeholder="Optional">
      </div>
      <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
        <button type="submit" class="btn" id="sched-create">Add schedule row</button>
        <div id="sched-status" class="auth-status"></div>
      </div>
    </form>
  </div>

  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items:center; gap:0.5rem;">
      <h3 style="margin:0;">Scheduled events</h3>
      <span style="font-size:0.9rem; color:#5b6470;" id="sched-count"></span>
    </div>
    <div id="sched-empty" style="color:#5b6470; margin-top:0.5rem;">No scheduled events.</div>
    <div style="overflow-x:auto; margin-top:0.5rem;">
      <table>
        <thead><tr><th>Date</th><th>Account</th><th>Amount</th><th>Memo</th><th>Actions</th></tr></thead>
        <tbody id="sched-body"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content: space-between; align-items:center; gap:0.5rem;">
      <div>
        <h3 style="margin:0;">Forecast</h3>
        <p style="margin:0; color:#5b6470;">Projected daily balances.</p>
      </div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <input type="number" id="forecast-days" min="1" max="365" value="30" style="width:80px;">
        <button type="button" class="btn btn-secondary" id="forecast-refresh">Refresh</button>
        <button type="button" class="btn btn-secondary" id="schedule-recompute">Recompute schedule</button>
      </div>
    </div>
    <div id="forecast-status" class="auth-status" style="margin-top:0.25rem;"></div>
    <div style="overflow-x:auto; margin-top:0.5rem;">
      <table>
        <thead><tr><th>Date</th><th>Projected balance</th><th>Memo</th></tr></thead>
        <tbody id="forecast-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  (() => {
    const form = document.getElementById('sched-form');
    const createBtn = document.getElementById('sched-create');
    const statusEl = document.getElementById('sched-status');
    const loginHint = document.getElementById('sched-login-hint');
    const reloadBtn = document.getElementById('sched-reload');
    const accountInput = document.getElementById('sched-account-input');
    const accountIdInput = document.getElementById('sched-account-id');
    const accountDropdown = document.getElementById('sched-account-dropdown');
    const accountResults = document.getElementById('sched-account-results');
    const accountEmpty = document.getElementById('sched-account-empty');
    const accountLoading = document.getElementById('sched-account-loading');
    const listEl = document.getElementById('sched-body');
    const emptyEl = document.getElementById('sched-empty');
    const countEl = document.getElementById('sched-count');
    const forecastBody = document.getElementById('forecast-body');
    const forecastStatus = document.getElementById('forecast-status');
    const daysInput = document.getElementById('forecast-days');
    const forecastBtn = document.getElementById('forecast-refresh');
    const recomputeBtn = document.getElementById('schedule-recompute');
    let scheduleRows = [];

    const authHeaders = (extra = {}) => {
      const metaCsrf = document.querySelector('meta[name="csrf-token"]')?.content;
      const base = Object.assign({'Content-Type': 'application/json'}, extra);
      if (metaCsrf) base['X-CSRF-Token'] = metaCsrf;
      return lifeosAuth.authHeaders(base);
    };

    const setStatus = (node, msg, tone = '') => {
      if (!node) return;
      node.textContent = msg || '';
      if (tone) node.dataset.tone = tone; else node.removeAttribute('data-tone');
    };

    const ensureAuth = () => {
      const authed = !!lifeosAuth.getTokens().access_token;
      if (authed && debouncedSearch && accountInput) {
        accountInput.disabled = false;
        debouncedSearch(accountInput.value);
      }
      Array.from(form?.querySelectorAll('input, button, select') || []).forEach((node) => node.disabled = !authed);
      [forecastBtn, recomputeBtn, reloadBtn].forEach((btn) => { if (btn) btn.disabled = !authed; });
      if (daysInput) daysInput.disabled = !authed;
      loginHint.style.display = authed ? 'none' : 'block';
      return authed;
    };

    const cleanLabel = (text) => String(text ?? '').replace(/\s*\([^)]*\)\s*$/, '').trim();

    const renderAccountResults = (query, results) => {
      accountLoading.style.display = 'none';
      accountResults.innerHTML = '';

      // Filter to current user if user_id present
      const userId = lifeosAuth.getTokens()?.user?.id || lifeosAuth.getTokens()?.user?.user_id;
      const filtered = Array.isArray(results)
        ? results.filter((r) => !r.user_id || !userId || Number(r.user_id) === Number(userId))
        : [];

      if (!filtered.length) {
        accountEmpty.style.display = 'block';
        accountResults.style.display = 'block';
      } else {
        accountEmpty.style.display = 'none';
        accountResults.style.display = 'block';
      }

      filtered.forEach((result) => {
        const row = document.createElement('div');
        row.className = 'account-search-result';
        row.role = 'option';
        row.tabIndex = 0;
        const displayName = window.lifeosAccountSearch?.formatResultDisplay?.(result) || result.name;
        const highlight = window.lifeosAccountSearch?.highlightMatch?.(displayName, query) || displayName;
        row.innerHTML = `
          <div style="font-weight: 500;">${highlight}</div>
          ${result.account_type ? `<div style="font-size: 0.85rem; color: #5b6470;">${result.account_type}${result.account_subtype ? ' • ' + result.account_subtype : ''}</div>` : ''}
        `;
        const selectAccount = () => {
          accountIdInput.value = result.id;
          accountInput.value = result.name;
          accountDropdown.style.display = 'none';
        };
        row.addEventListener('click', selectAccount);
        row.addEventListener('keydown', (e) => { if (e.key === 'Enter') selectAccount(); });
        accountResults.appendChild(row);
      });

      // Create new account option
      if (query && query.trim().length) {
        const createRow = document.createElement('div');
        createRow.className = 'account-search-create-new';
        createRow.style.cssText = 'padding: 0.5rem 0.75rem; border-top: 1px solid #e0e5ec; cursor: pointer; color: #0b4f9c; background: #f7f8fa;';
        createRow.textContent = '+ Create new account';
        const openCreateModal = async () => {
          await openInlineCreateModal(query.trim());
        };
        createRow.addEventListener('click', openCreateModal);
        createRow.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCreateModal(); });
        accountResults.appendChild(createRow);
      }
    };

    const openInlineCreateModal = async (prefillName) => {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
      `;

      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        z-index: 9999;
      `;

      modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #1f2430;">Create New Account</h3>
          <p style="margin: 0; color: #5b6470; font-size: 0.9rem;">Configure "<strong>${prefillName}</strong>"</p>
        </div>
        <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
          ${['asset','liability','equity','income','expense'].map((t, i) => `
            <label style="display:flex; align-items:flex-start; gap:0.75rem; cursor:pointer; padding:0.75rem; border-radius:8px; border:2px solid transparent;">
              <input type="radio" name="account-type" value="${t}" ${i === 0 ? 'checked' : ''} style="margin-top:0.25rem;">
              <span>
                <div style="font-weight:600; color:#1f2430; text-transform:capitalize;">${t}</div>
              </span>
            </label>
          `).join('')}
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display:block; margin-bottom:0.35rem; font-weight:600; font-size:0.9rem; color:#1f2430;">Subtype (optional)</label>
          <select id="inline-subtype-select" style="width: 100%; padding: 0.5rem; border: 1px solid #e0e5ec; border-radius: 6px; font-size: 0.9rem;">
            <option value="">Loading subtypes…</option>
          </select>
          <small id="inline-subtype-hint" style="color: #5b6470; font-size: 0.8rem; display: block; margin-top: 0.25rem;"></small>
        </div>
        <div style="margin-bottom: 1.5rem;">
          <label style="display:block; margin-bottom:0.35rem; font-weight:600; font-size:0.9rem; color:#1f2430;">Category (optional)</label>
          <select id="inline-category-select" style="width: 100%; padding: 0.5rem; border: 1px solid #e0e5ec; border-radius: 6px; font-size: 0.9rem;">
            <option value="">Use default category</option>
          </select>
          <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
            <input type="text" id="inline-category-new" placeholder="Or create new category..." style="flex: 1; padding: 0.5rem; border: 1px solid #e0e5ec; border-radius: 6px; font-size: 0.9rem;">
          </div>
        </div>
        <div style="display:flex; gap:0.75rem;">
          <button type="button" class="create-account-submit" style="flex:1; padding:0.75rem; background:#0b4f9c; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Create Account</button>
          <button type="button" class="create-account-cancel" style="flex:1; padding:0.75rem; background:#e0e5ec; color:#1f2430; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
        </div>
        <div id="inline-create-error" style="margin-top: 0.5rem; color: #b3352f; font-size: 0.85rem;"></div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(modal);

      const categorySelect = modal.querySelector('#inline-category-select');
      const categoryNewInput = modal.querySelector('#inline-category-new');
      const subtypeSelect = modal.querySelector('#inline-subtype-select');
      const subtypeHint = modal.querySelector('#inline-subtype-hint');
      const typeRadios = modal.querySelectorAll('input[name="account-type"]');
      const createBtn = modal.querySelector('.create-account-submit');
      const cancelBtn = modal.querySelector('.create-account-cancel');
      const errorEl = modal.querySelector('#inline-create-error');

      const closeModal = () => {
        overlay.remove();
        modal.remove();
      };

      cancelBtn?.addEventListener('click', closeModal);
      overlay.addEventListener('click', closeModal);

      const populateSubtypes = async (baseType) => {
        if (!subtypeSelect) return;
        subtypeSelect.innerHTML = '<option value="">— None / other —</option>';
        subtypeSelect.disabled = true;
        if (subtypeHint) subtypeHint.textContent = 'Loading subtypes...';
        try {
          const subs = await window.lifeosAccountSubtypes?.getSubtypes?.(baseType);
          if (Array.isArray(subs) && subs.length) {
            subs.forEach((sub) => {
              const opt = document.createElement('option');
              opt.value = sub;
              opt.textContent = sub.replace(/_/g, ' ');
              subtypeSelect.appendChild(opt);
            });
            subtypeSelect.disabled = false;
            if (subtypeHint) subtypeHint.textContent = `${subs.length} subtype option(s) for ${baseType}`;
          } else if (subtypeHint) {
            subtypeHint.textContent = 'No subtype suggestions.';
          }
        } catch (err) {
          if (subtypeHint) subtypeHint.textContent = 'Unable to load subtypes.';
        }
      };

      const populateCategories = async (baseType) => {
        if (!categorySelect) return;
        categorySelect.innerHTML = '<option value="">Use default category</option>';
        try {
          const categories = await window.lifeosAccountCategories?.getCategoriesByType?.(baseType);
          if (Array.isArray(categories) && categories.length) {
            categories.forEach((cat) => {
              const opt = document.createElement('option');
              opt.value = cat.id;
              opt.textContent = cat.name;
              categorySelect.appendChild(opt);
            });
          }
        } catch (_) {
          /* noop */
        }
      };

      const getSelectedType = () => {
        const checked = Array.from(typeRadios).find((r) => r.checked);
        return checked?.value || 'asset';
      };

      const onTypeChange = () => {
        const t = getSelectedType();
        populateSubtypes(t);
        populateCategories(t);
      };

      typeRadios.forEach((r) => r.addEventListener('change', onTypeChange));
      onTypeChange();

      createBtn?.addEventListener('click', async () => {
        if (errorEl) errorEl.textContent = '';
        const baseType = getSelectedType();
        try {
          const account = await window.lifeosAccountSearch?.createAccountInline?.(
            prefillName,
            baseType,
            subtypeSelect?.value || null,
            categorySelect?.value ? Number(categorySelect.value) : null,
            categoryNewInput?.value || null
          );
          if (account) {
            accountIdInput.value = account.id;
            accountInput.value = account.name;
            accountDropdown.style.display = 'none';
            closeModal();
          }
        } catch (err) {
          if (errorEl) errorEl.textContent = err?.message || 'Unable to create account.';
        }
      });
    };

    let debouncedSearch = null;

    const initAccountSearch = (attempt = 0) => {
      if (window.lifeosAccountSearch?.createDebouncedSearch) {
        debouncedSearch = window.lifeosAccountSearch.createDebouncedSearch((results) => {
          const q = accountInput.value;
          renderAccountResults(q, results);
        });
        return;
      }
      if (attempt < 20) {
        setTimeout(() => initAccountSearch(attempt + 1), 150);
      } else {
        console.warn('[Forecast] account search module unavailable');
      }
    };

    const performSearch = () => {
      if (!accountInput || !debouncedSearch) return;
      accountDropdown.style.display = 'block';
      accountLoading.style.display = 'block';
      accountResults.innerHTML = '';
      accountEmpty.style.display = 'none';
      debouncedSearch(accountInput.value);
    };

    accountInput?.addEventListener('input', () => {
      accountIdInput.value = '';
      performSearch();
    });

    accountInput?.addEventListener('focus', () => {
      performSearch();
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById('sched-account-wrapper')?.contains(e.target)) {
        accountDropdown.style.display = 'none';
      }
    });

    const accountLabel = (accountId) => {
      const fromInput = cleanLabel(accountInput?.value || '');
      if (fromInput) return fromInput;
      const found = scheduleRows.find((r) => r.account_id === accountId && r.account_name);
      if (found) return cleanLabel(found.account_name);
      return cleanLabel(accountId) || '';
    };

    const renderRows = () => {
      const items = scheduleRows || [];
      listEl.innerHTML = '';
      countEl.textContent = items.length ? `${items.length} rows` : '';
      if (!items.length) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';
      items.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:center;"><input type="date" value="${row.event_date || ''}" data-field="event_date" data-id="${row.id}" style="width:130px;"></td>
          <td style="text-align:center;">${cleanLabel(row.account_name || accountLabel(row.account_id) || row.account_id)}</td>
          <td style="text-align:center;"><input type="number" step="0.01" value="${row.amount ?? ''}" data-field="amount" data-id="${row.id}" style="width:120px;"></td>
          <td style="text-align:center;"><input type="text" value="${row.memo || ''}" data-field="memo" data-id="${row.id}" style="width:180px;"></td>
          <td style="text-align:center;">
            <button class="btn btn-secondary" data-action="update" data-id="${row.id}">Update</button>
            <button class="btn btn-secondary" data-action="delete" data-id="${row.id}">Delete</button>
          </td>
        `;
        listEl.appendChild(tr);
      });
    };

    const fetchSchedule = async () => {
      if (!ensureAuth()) return;
      setStatus(statusEl, 'Loading schedule...');
      const res = await fetch('/api/finance/dashboard', { headers: lifeosAuth.authHeaders() });
      const body = await res.json().catch(() => ({}));
      if (res.ok && body.ok !== false) {
        scheduleRows = (body.upcoming_schedule || []).map((r) => ({
          id: r.id,
          account_id: r.account_id,
          account_name: r.account_name,
          event_date: r.event_date,
          amount: r.amount,
          memo: r.memo,
        }));
        renderRows();
        setStatus(statusEl, '');
      } else {
        const reason = body.error || res.status;
        setStatus(statusEl, reason === 401 ? 'Please log in.' : 'Unable to load schedule.', 'error');
      }
    };

    const fetchForecast = async () => {
      if (!ensureAuth()) return;
      forecastBody.innerHTML = '';
      setStatus(forecastStatus, 'Loading...');
      const days = parseInt(daysInput.value, 10) || 30;
      const params = new URLSearchParams({ days: days.toString() });
      const res = await fetch(`/api/finance/forecast?${params.toString()}`, { headers: lifeosAuth.authHeaders() });
      const body = await res.json().catch(() => ({}));
      if (res.ok && body.ok !== false) {
        (body.forecast || []).forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.date}</td><td>${Number(row.projected_balance ?? 0).toFixed(2)}</td><td>${row.memo || ''}</td>`;
          forecastBody.appendChild(tr);
        });
        setStatus(forecastStatus, '');
      } else {
        const reason = body.error || res.status;
        setStatus(forecastStatus, reason === 401 ? 'Please log in.' : 'Unable to load forecast.', 'error');
      }
    };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!ensureAuth()) return setStatus(statusEl, 'Please log in.', 'error');
      const data = Object.fromEntries(new FormData(form).entries());
      const accountDisplay = cleanLabel(accountInput?.value || '');
      const payload = {
        account_id: data.account_id ? Number(data.account_id) : null,
        event_date: data.event_date || null,
        amount: data.amount ? Number(data.amount) : 0,
        memo: data.memo || null,
      };
      if (!payload.account_id || !payload.event_date) {
        setStatus(statusEl, 'Account and date required.', 'error');
        return;
      }
      setStatus(statusEl, 'Saving...');
      createBtn.disabled = true;
      const res = await fetch('/api/finance/schedule', { method: 'POST', headers: authHeaders(), body: JSON.stringify(payload) });
      const body = await res.json().catch(() => ({}));
      createBtn.disabled = false;
      if (res.ok && body.ok !== false) {
        setStatus(statusEl, 'Added.', 'success');
        form.reset();
        scheduleRows.push({
          id: body.row_id,
          account_id: payload.account_id,
          account_name: accountDisplay,
          event_date: payload.event_date,
          amount: payload.amount,
          memo: payload.memo || '',
        });
        renderRows();
        fetchForecast();
      } else {
        const reason = body.error || res.status;
        setStatus(statusEl, reason === 401 ? 'Please log in.' : 'Unable to add.', 'error');
      }
    });

    listEl.addEventListener('click', async (e) => {
      const action = e.target?.dataset?.action;
      if (!action) return;
      const rowId = Number(e.target.dataset.id);
      if (!rowId) return;
      if (action === 'delete') {
        setStatus(statusEl, 'Deleting...');
        const res = await fetch(`/api/finance/schedule/${rowId}`, { method: 'DELETE', headers: lifeosAuth.authHeaders() });
        const reason = (await res.json().catch(() => ({}))).error || res.status;
        if (res.ok) {
          setStatus(statusEl, 'Deleted.', 'success');
          scheduleRows = scheduleRows.filter((r) => r.id !== rowId);
          renderRows();
          fetchForecast();
        } else {
          setStatus(statusEl, reason === 401 ? 'Please log in.' : 'Unable to delete.', 'error');
        }
      }
      if (action === 'update') {
        const row = e.target.closest('tr');
        const event_date = row.querySelector('[data-field="event_date"]')?.value || null;
        const amount = row.querySelector('[data-field="amount"]')?.value || null;
        const memo = row.querySelector('[data-field="memo"]')?.value || null;
        setStatus(statusEl, 'Updating...');
        const res = await fetch(`/api/finance/schedule/${rowId}`, {
          method: 'PATCH',
          headers: authHeaders(),
          body: JSON.stringify({
            event_date: event_date || undefined,
            amount: amount ? Number(amount) : null,
            memo: memo || null,
          }),
        });
        const reason = (await res.json().catch(() => ({}))).error || res.status;
        if (res.ok) {
          setStatus(statusEl, 'Updated.', 'success');
          scheduleRows = scheduleRows.map((r) => r.id === rowId ? {
            ...r,
            event_date: event_date || r.event_date,
            amount: amount ? Number(amount) : r.amount,
            memo: memo ?? r.memo,
          } : r);
          renderRows();
          fetchForecast();
        } else {
          setStatus(statusEl, reason === 401 ? 'Please log in.' : 'Unable to update.', 'error');
        }
      }
    });

    forecastBtn?.addEventListener('click', fetchForecast);
    recomputeBtn?.addEventListener('click', async () => {
      setStatus(forecastStatus, 'Recomputing...');
      const res = await fetch('/api/finance/schedule/recompute', { method: 'POST', headers: lifeosAuth.authHeaders() });
      setStatus(forecastStatus, res.ok ? 'Recomputed.' : 'Failed.', res.ok ? 'success' : 'error');
      if (res.ok) fetchForecast();
    });

    reloadBtn?.addEventListener('click', () => { fetchSchedule(); fetchForecast(); });
    window.addEventListener('lifeos:auth-changed', (e) => {
      ensureAuth();
      if (e.detail?.loggedIn) {
        if (debouncedSearch && accountInput) debouncedSearch(accountInput.value);
        fetchSchedule();
        fetchForecast();
      } else {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        forecastBody.innerHTML = '';
      }
    });
    const start = () => {
      ensureAuth();
      initAccountSearch();
      // Kick an initial search once module is ready
      setTimeout(() => {
        if (debouncedSearch && accountInput) debouncedSearch('');
      }, 250);
      fetchSchedule();
      fetchForecast();
    };
    if (window.lifeosAuthReady?.then) {
      window.lifeosAuthReady.finally(start);
    } else {
      start();
    }
  })();
</script>
{% endblock %}

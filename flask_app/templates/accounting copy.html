{% extends 'base.html' %}

{% block title %}Accounting - Finance App{% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accounting.css') }}">
  <style>
    /* Journal entries smaller font for compact display */
    .journal-table, .journal-table * {
      font-size:10pt !important;
    }
    /* align with shared base layout */
    .profile-cover { display: none !important; }
    .profile-main { background: transparent; box-shadow: none; padding: 0; max-width: none; top: 0; }
    body {
      background: var(--surface-muted);
      font-family: "Inter","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color: var(--text-strong);
      margin: 0;
    }
  </style>
{% endblock %}

{% block content %}
  <script>
    // Data helpers injected from server
    const categoryMap = {
      {% for c in categories %}
        {{ c.id }}: {{ (c.name|tojson) }},
      {% endfor %}
    };
    const folderColorMap = {}; // id -> color

    // Helper to post JSON
    async function postJSON(url, payload) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' }, body: JSON.stringify(payload) });
      if (!res.ok) { throw new Error('Request failed'); }
      return res.json().catch(() => ({}));
    }

    // Toggle between views
    function showView(view) {
      const foldersBtn = document.getElementById('btn-view-folders');
      const accountsBtn = document.getElementById('btn-view-accounts');
      const journalBtn = document.getElementById('btn-view-journal');
      if (journalBtn) journalBtn.addEventListener('click', () => showView('journal'));
      const trialBtn = document.getElementById('btn-view-trial');
      const receivablesBtn = document.getElementById('btn-view-receivables');
      const balanceBtn = document.getElementById('btn-view-balance');
      const foldersView = document.getElementById('folders-view');
      const accountsView = document.getElementById('accounts-view');
      const journalView = document.getElementById('journal-view');
      const trialView = document.getElementById('trial-view');
      const receivablesView = document.getElementById('receivables-view');
      const balanceView = document.getElementById('balance-view');
      const isFolders = view === 'folders';
      const isAccounts = view === 'accounts';
      const isJournal = view === 'journal';
      const isTrial = view === 'trial';
      const isReceivables = view === 'receivables';
      const isBalance = view === 'balance';
      if (foldersBtn) foldersBtn.classList.toggle('active', isFolders);
      if (accountsBtn) accountsBtn.classList.toggle('active', isAccounts);
      if (journalBtn) journalBtn.classList.toggle('active', isJournal);
      if (trialBtn) trialBtn.classList.toggle('active', isTrial);
      if (receivablesBtn) receivablesBtn.classList.toggle('active', isReceivables);
      if (balanceBtn) balanceBtn.classList.toggle('active', isBalance);
      if (foldersView) foldersView.style.display = isFolders ? 'grid' : 'none';
      if (accountsView) accountsView.style.display = isAccounts ? 'grid' : 'none';
      if (journalView) journalView.style.display = isJournal ? 'grid' : 'none';
      if (trialView) trialView.style.display = isTrial ? 'block' : 'none';
      if (receivablesView) receivablesView.style.display = isReceivables ? 'block' : 'none';
      if (balanceView) balanceView.style.display = isBalance ? 'block' : 'none';
      if (!isReceivables && typeof closeReceivableContactModal === 'function') {
        closeReceivableContactModal();
      }
      const viewLabelEl = document.getElementById('acc-current-view');
      if (viewLabelEl) {
        const labels = {
          folders: 'Folders',
          accounts: 'Accounts',
          journal: 'Journal Entries',
          trial: 'Trial Balance',
          receivables: 'Receivables & Debt',
          balance: 'Balance Sheet'
        };
        viewLabelEl.textContent = labels[view] || 'Folders';
      }
      localStorage.setItem('accountingView', view);
      if (isReceivables && typeof window.initReceivableDebtUI === 'function') {
        window.initReceivableDebtUI();
      }
    }

    // Add a new folder (only from folder list pane and modal)
    async function addCategory(where='sidebar') {
      const input = document.querySelector(where === 'sidebar' ? '#add-cat' : '#modal-add-cat');
      const name = (input.value || '').trim();
      if (!name) return;
      const data = await postJSON('/accounting/category/add', { name });
      if (data && data.ok) { window.location.reload(); }
    }

    // Folder selection logic
    let selectedFolderId = null;
    function selectFolder(id) {
      selectedFolderId = id;
      try { localStorage.setItem('lastFolderId', String(id)); } catch (_) {}
      // highlight in list
      document.querySelectorAll('.folder-item').forEach(el => el.classList.toggle('active', parseInt(el.dataset.id,10)===id));
      // center: show selected folder accounts panel
      document.querySelectorAll('.in-folder-panel').forEach(p => p.style.display = (parseInt(p.dataset.folderId,10)===id) ? 'block' : 'none');
      // header title
      const h = document.getElementById('in-folder-title');
      if (h) { h.textContent = 'In Folder: ' + (categoryMap[id] || ''); }
      const status = document.getElementById('folders-status');
      if (status) { status.textContent = categoryMap[id] || 'Folder selected'; }
      // right: filter accounts not in this folder
      filterNotInFolderList();
      // show panes once a folder is chosen
      const paneMid = document.getElementById('pane-in-folder');
      const paneRight = document.getElementById('pane-notin');
      if (paneMid) paneMid.style.display = 'block';
      if (paneRight) paneRight.style.display = 'block';
    }

    function filterNotInFolderList() {
      const q = (document.getElementById('notin-search').value || '').toLowerCase();
      const list = document.getElementById('notin-list');
      const items = list.querySelectorAll('.account-row');
      items.forEach(it => {
        const name = (it.dataset.name || '').toLowerCase();
        const cat = it.dataset.catId ? parseInt(it.dataset.catId,10) : null;
        const hide = (selectedFolderId!=null && cat===selectedFolderId) || (q && !name.includes(q));
        it.style.display = hide ? 'none' : '';
        // update badge text and color
        const badge = it.querySelector('.folder-badge');
        if (badge) {
          if (cat) {
            badge.textContent = categoryMap[cat] || 'Folder';
            badge.style.background = folderColorMap[cat] || '#4dabf7';
          } else {
            badge.textContent = 'Unassigned';
            badge.style.background = '#adb5bd';
          }
        }
      });
    }

    function applyBadgeColorFor(el, catId) {
      const badge = el.querySelector('.folder-badge');
      if (!badge) return;
      if (catId) {
        badge.textContent = categoryMap[catId] || 'Folder';
        badge.style.background = folderColorMap[catId] || '#4dabf7';
      } else {
        badge.textContent = 'Unassigned';
        badge.style.background = '#adb5bd';
      }
    }

    // Natural sort helpers: numeric code first, then numeric-aware name
    function naturalKey(row) {
      const code = (row.dataset.code || '').trim();
      if (code && /^\d+$/.test(code)) return ['0', parseInt(code, 10), ''];
      const name = (row.dataset.name || '').trim().toLowerCase();
      const parts = name.match(/\d+|\D+/g) || [];
      return parts.map(p => (/^\d+$/.test(p) ? parseInt(p,10) : p));
    }
    function resortNodeList(container) {
      const rows = Array.from(container.querySelectorAll('.account-row'));
      rows.sort((a,b) => {
        const ka = naturalKey(a), kb = naturalKey(b);
        const len = Math.max(ka.length, kb.length);
        for (let i=0;i<len;i++) {
          const va = ka[i], vb = kb[i];
          if (va === undefined) return -1;
          if (vb === undefined) return 1;
          if (typeof va === 'number' && typeof vb === 'number') {
            if (va !== vb) return va - vb;
          } else {
            const sa = String(va), sb = String(vb);
            if (sa !== sb) return sa < sb ? -1 : 1;
          }
        }
        return 0;
      });
      rows.forEach(r => container.appendChild(r));
    }

    function afterMoveUpdate(accId, newCatId) {
      // Update right-panel list item (notin list)
      const rightItem = document.querySelector(`#notin-list .account-row[data-id='${accId}']`);
      if (rightItem) {
        rightItem.dataset.catId = newCatId ? String(newCatId) : '';
        applyBadgeColorFor(rightItem, newCatId);
        filterNotInFolderList();
      }
      // Update accounts view list item
      const accItem = document.querySelector(`#acc-list .account-row[data-id='${accId}']`);
      if (accItem) {
        accItem.dataset.catId = newCatId ? String(newCatId) : '';
        applyBadgeColorFor(accItem, newCatId);
      }
      // Remove from center panel if it no longer belongs
      if (selectedFolderId && (!newCatId || parseInt(newCatId,10) !== selectedFolderId)) {
        const row = document.querySelector(`.in-folder-panel[data-folder-id='${selectedFolderId}'] .account-row[data-id='${accId}']`);
        if (row && row.parentElement) row.parentElement.removeChild(row);
      }
      // Add to center panel if visible and matches selected
      if (selectedFolderId && newCatId && parseInt(newCatId,10) === selectedFolderId) {
        const panel = document.querySelector(`.in-folder-panel[data-folder-id='${selectedFolderId}']`);
        if (panel) {
          // If not already in list, append a simple row
          if (!panel.querySelector(`.account-row[data-id='${accId}']`)) {
            // Try to get name/code from any existing row
            const src = rightItem || accItem;
            const name = src ? (src.dataset.name || src.querySelector('strong')?.textContent || '') : '';
            const code = src ? (src.dataset.code || '') : '';
            const row = document.createElement('div');
            row.className = 'account-row';
            row.setAttribute('draggable', 'true');
            row.dataset.id = String(accId);
            row.dataset.name = name;
            if (code) row.dataset.code = code;
            row.innerHTML = '<div class="row-main"><strong>' + name + '</strong>' + (code ? ' <span class="badge muted">' + code + '</span>' : '') + '</div>' +
                            '<div class="row-actions"><button class="button" onclick="renameAccountFromButton(this)"><i class="fa fa-pen"></i> Rename</button> ' +
                            '<button class="button" onclick="openMoveModalFromButton(this)"><i class="fa fa-right-left"></i> Move</button> ' +
                            '<button class="button btn-danger-ghost" onclick="unassignAccount(' + accId + ')"><i class="fa fa-unlink"></i> Unassign</button></div>';
            panel.appendChild(row);
            row.addEventListener('dragstart', onDragStart);
            row.addEventListener('dragend', onDragEnd);
          }
          // Keep panel sorted numerically after any change
          resortNodeList(panel);
        }
      }
    }

    // Move account via button to selected folder
    async function moveToSelectedFolder(accId) {
      if (selectedFolderId == null) return;
      try {
        await postJSON('/accounting/account/move', { account_id: accId, category_id: selectedFolderId, order: 9999 });
        afterMoveUpdate(accId, selectedFolderId);
      } catch (e) { console.error(e); }
    }

    function unassignAccount(accId) {
      postJSON('/accounting/account/move', { account_id: accId, category_id: null, order: 9999 })
        .then(() => afterMoveUpdate(accId, null))
        .catch(err => console.error(err));
    }

    function updateAllBadges() {
      document.querySelectorAll('.account-row .folder-badge').forEach(badge => {
        const row = badge.closest('.account-row');
        const catIdStr = row ? row.dataset.catId : '';
        const catId = catIdStr ? parseInt(catIdStr,10) : null;
        if (catId) {
          badge.textContent = categoryMap[catId] || 'Folder';
          badge.style.background = folderColorMap[catId] || '#4dabf7';
        } else {
          badge.textContent = 'Unassigned';
          badge.style.background = '#adb5bd';
        }
      });
    }

    function deselectFolder() {
      selectedFolderId = null;
      try { localStorage.removeItem('lastFolderId'); } catch (_) {}
      document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('active'));
      const paneMid = document.getElementById('pane-in-folder');
      const paneRight = document.getElementById('pane-notin');
      if (paneMid) paneMid.style.display = 'none';
      if (paneRight) paneRight.style.display = 'none';
      const s = document.getElementById('notin-search');
      if (s) s.value = '';
      const status = document.getElementById('folders-status');
      if (status) status.textContent = 'No folder selected';
      filterNotInFolderList();
    }

    // Drag and drop accounts into selected folder (center panel lists are droppable already)
    let dragItem = null;
    function onDragStart(e) {
      const el = e.currentTarget;
      dragItem = { type: 'account', id: parseInt(el.dataset.id, 10) };
      el.classList.add('ghost');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify(dragItem));
    }
    function onDragEnd(e) { e.currentTarget.classList.remove('ghost'); }
    function onDragOverList(e) { e.preventDefault(); e.currentTarget.classList.add('drop-target'); }
    function onDragLeaveList(e) { e.currentTarget.classList.remove('drop-target'); }
    async function onDropToList(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drop-target');
      let data; try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch (_) { return; }
      if (!data || data.type !== 'account') return;
      const catId = parseInt(e.currentTarget.dataset.categoryId, 10);
      const order = e.currentTarget.querySelectorAll('.account-row').length;
      try { await postJSON('/accounting/account/move', { account_id: data.id, category_id: catId, order }); afterMoveUpdate(data.id, catId); } catch (e) { console.error(e); }
    }

    // Accounts view filtering
    function filterAccountsView() {
      const q = (document.getElementById('acc-search').value || '').toLowerCase();
      const onlyUncat = document.getElementById('acc-only-uncat').checked;
      const folderFilter = document.getElementById('acc-folder-filter').value;
      const list = document.getElementById('acc-list');
      list.querySelectorAll('.account-row').forEach(it => {
        const name = (it.dataset.name || '').toLowerCase();
        const cat = it.dataset.catId || '';
        let show = (!q || name.includes(q));
        if (folderFilter) {
          show = show && (cat === folderFilter);
        } else if (onlyUncat) {
          show = show && (!cat);
        }
        it.style.display = show ? '' : 'none';
      });
    }

    // Modal move
    let modalAccId = null;
    function openMoveModal(accId, accName) {
      modalAccId = accId;
      document.getElementById('modal-acc-name').textContent = accName;
      document.getElementById('modal').style.display = 'flex';
    }
    function closeMoveModal() { document.getElementById('modal').style.display = 'none'; modalAccId = null; }
    async function modalAddFolder() { await addCategory('modal'); }
    async function modalMoveTo(catId) {
      if (!modalAccId) return;
      try { await postJSON('/accounting/account/move', { account_id: modalAccId, category_id: catId, order: 9999 }); afterMoveUpdate(modalAccId, catId); closeMoveModal(); } catch (e) { console.error(e); }
    }

    function openMoveModalFromButton(btn) {
      const row = btn.closest('.account-row');
      const id = parseInt(row?.dataset.id || '0', 10);
      const name = row?.dataset.name || row?.querySelector('strong')?.textContent || '';
      if (id) openMoveModal(id, name);
    }

    async function renameAccountFromButton(btn) {
      const row = btn.closest('.account-row');
      const id = parseInt(row?.dataset.id || '0', 10);
      const current = row?.dataset.name || row?.querySelector('strong')?.textContent || '';
      const newName = prompt('Rename account to:', current);
      if (!newName || newName.trim() === '' || newName.trim() === current) return;
      try {
        const res = await postJSON(`/accounting/account/rename/${id}`, { name: newName.trim() });
        if (res && res.ok) {
          // Update all rows with this id across views
          document.querySelectorAll(`.account-row[data-id='${id}']`).forEach(el => {
            el.dataset.name = newName.trim();
            const strong = el.querySelector('strong');
            if (strong) strong.textContent = newName.trim();
          });
          // Resort lists to reflect new name
          document.querySelectorAll('.in-folder-panel').forEach(panel => resortNodeList(panel));
          const notin = document.getElementById('notin-list'); if (notin) resortNodeList(notin);
          const accl = document.getElementById('acc-list'); if (accl) resortNodeList(accl);
        }
      } catch (err) { console.error(err); }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Restore last selected view if available
      const storedView = localStorage.getItem('accountingView') || 'folders';
      showView(storedView);
      document.getElementById('btn-view-folders').addEventListener('click', () => showView('folders'));
      document.getElementById('btn-view-accounts').addEventListener('click', () => showView('accounts'));
      const trialBtn = document.getElementById('btn-view-trial');
      if (trialBtn) trialBtn.addEventListener('click', () => showView('trial'));
      const receivablesBtn = document.getElementById('btn-view-receivables');
      if (receivablesBtn) receivablesBtn.addEventListener('click', () => showView('receivables'));
      const balanceBtn = document.getElementById('btn-view-balance');
      if (balanceBtn) balanceBtn.addEventListener('click', () => { showView('balance'); initBalanceSheetUI(); });
      if (storedView === 'balance') { initBalanceSheetUI(); }
      if (storedView === 'receivables' && typeof window.initReceivableDebtUI === 'function') {
        window.initReceivableDebtUI();
      }
      const clearBtn = document.getElementById('btn-clear-selection');
      if (clearBtn) clearBtn.addEventListener('click', () => deselectFolder());

      // Folder interactions
      const colors = ['#ff6b6b','#4dabf7','#51cf66','#845ef7','#ffa94d','#f06595','#20c997','#ffd43b'];
      const icons = ['fa-wallet','fa-piggy-bank','fa-building-columns','fa-credit-card','fa-coins','fa-chart-line','fa-sack-dollar','fa-box-archive'];
      document.querySelectorAll('.folder-list.sidebar .folder-item').forEach((el, idx) => {
        el.addEventListener('click', (ev) => {
          if (ev.target.closest('.folder-actions') || ev.target.closest('.icon-btn')) return;
          const id = parseInt(el.dataset.id,10);
          if (selectedFolderId === id) { deselectFolder(); } else { selectFolder(id); }
        });
        const color = colors[idx % colors.length];
        el.style.setProperty('--folder-color', color);
        const iconEl = el.querySelector('.folder-icon i');
        if (iconEl) { iconEl.classList.add(icons[idx % icons.length]); }
        const id = parseInt(el.dataset.id,10);
        folderColorMap[id] = color;
        // Wire rename and delete
        const renameBtn = el.querySelector('.folder-rename');
        const deleteBtn = el.querySelector('.folder-delete');
        const nameLabel = el.querySelector('.folder-name[data-label]');
        const input = el.querySelector('.rename-input');
        if (renameBtn && input && nameLabel) {
          renameBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            input.style.display = 'block';
            nameLabel.style.display = 'none';
            input.value = nameLabel.textContent.trim();
            input.focus();
          });
          input.addEventListener('keydown', async (ke) => {
            if (ke.key === 'Enter') {
              const newName = input.value.trim();
              if (!newName) return;
              if (!confirm('Rename folder to "' + newName + '"?')) return;
              try {
                const res = await postJSON(`/accounting/category/rename/${id}`, { name: newName });
                if (res && res.ok) {
                  nameLabel.textContent = newName;
                  categoryMap[id] = newName;
                  input.style.display = 'none';
                  nameLabel.style.display = '';
                  if (selectedFolderId === id) {
                    const h = document.getElementById('in-folder-title');
                    if (h) h.textContent = 'In Folder: ' + newName;
                  }
                  updateAllBadges();
                  try { if (window.sortSidebarFoldersAlpha) window.sortSidebarFoldersAlpha(); } catch(e){}
                }
              } catch (err) { console.error(err); }
            } else if (ke.key === 'Escape') {
              input.style.display = 'none'; nameLabel.style.display = '';
            }
          });
          input.addEventListener('blur', () => { input.style.display = 'none'; nameLabel.style.display = ''; });
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!confirm('Delete folder? Accounts inside will move to Unassigned.')) return;
            try {
              const res = await fetch(`/accounting/category/delete/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' }, body: JSON.stringify({}) });
              if (res.ok) {
                // Remove from sidebar
                el.remove();
                // Remove option in Accounts filter
                const opt = document.querySelector(`#acc-folder-filter option[value='${id}']`);
                if (opt) opt.remove();
                // Remove from modal list
                const modalItem = document.querySelector(`#modal .folder-list .folder-item[data-id='${id}']`);
                if (modalItem) modalItem.remove();
                // Remove in-folder panel
                const panel = document.querySelector(`.in-folder-panel[data-folder-id='${id}']`);
                if (panel) panel.remove();
                // Cleanup maps
                delete categoryMap[id];
                delete folderColorMap[id];
                filterNotInFolderList();
                if (selectedFolderId === id) deselectFolder();
              }
            } catch (err) { console.error(err); }
          });
        }
      });
      // Also style icons/colors inside modal
      document.querySelectorAll('#modal .folder-list .folder-item').forEach((el, idx) => {
        el.style.setProperty('--folder-color', colors[idx % colors.length]);
        const iconEl = el.querySelector('.folder-icon i');
        if (iconEl) { iconEl.classList.add(icons[idx % icons.length]); }
      });
      // default select first folder if any
      const lf = localStorage.getItem('lastFolderId');
      if (lf) {
        const exists = document.querySelector(`.folder-item[data-id='${lf}']`);
        if (exists) selectFolder(parseInt(lf,10));
      }

      // DnD for account items in both views
      document.querySelectorAll('.account-row[draggable="true"]').forEach(el => {
        el.addEventListener('dragstart', onDragStart);
        el.addEventListener('dragend', onDragEnd);
      });
      document.querySelectorAll('.account-list.dropzone').forEach(list => {
        list.addEventListener('dragover', onDragOverList);
        list.addEventListener('dragleave', onDragLeaveList);
        list.addEventListener('drop', onDropToList);
      });

      // Sort lists initially (numerical-aware)
      document.querySelectorAll('.in-folder-panel').forEach(panel => resortNodeList(panel));
      const notin = document.getElementById('notin-list'); if (notin) resortNodeList(notin);
      const accl = document.getElementById('acc-list'); if (accl) resortNodeList(accl);

      // Filters & search
      document.getElementById('notin-search').addEventListener('input', filterNotInFolderList);
      document.getElementById('acc-search').addEventListener('input', filterAccountsView);
      document.getElementById('acc-only-uncat').addEventListener('change', filterAccountsView);
      document.getElementById('acc-folder-filter').addEventListener('change', filterAccountsView);

      // Modal close
      document.getElementById('modal-close').addEventListener('click', closeMoveModal);

      // Initially hide center and right panes until a folder is selected
      const paneMid = document.getElementById('pane-in-folder');
      const paneRight = document.getElementById('pane-notin');
      if (paneMid) paneMid.style.display = 'none';
      if (paneRight) paneRight.style.display = 'none';
      updateAllBadges();
    });
  </script>
  <script>
    async function refreshCodes(){
      try{
        const res = await fetch('/accounting/codes/refresh', { method:'POST', headers:{ 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' } });
        if (res.ok){ location.reload(); }
      }catch(e){ console.error(e); }
    }
  </script>
  <script>
    window.ACC_BOOT = {
      categoryMap: {
        {% for c in categories %}
          {{ c.id }}: {{ (c.name|tojson) }},
        {% endfor %}
      },
      csrfToken: {{ (csrf_token or '')|tojson }},
      categoriesData: [
        {% for c in categories %}
          { id: {{ c.id }}, name: {{ (c.name|tojson) }}, tb_group: {{ (c.tb_group or '')|tojson }} },
        {% endfor %}
      ],
      accountsByCategory: {
        {% for c in categories %}
          {{ c.id }}: [
            {% for a in accounts_by_category.get(c.id, []) %}
              { id: {{ a.id }}, name: {{ (a.name|tojson) }}, currency_code: {{ ((a.currency_code or 'KRW')|upper|tojson) }} },
            {% endfor %}
          ],
        {% endfor %}
      },
      openingBalances: {
        {% for acc_id, amt in (opening_balances or {}).items() %}
          {{ acc_id }}: {{ amt }},
        {% endfor %}
      },
      openingBalanceDates: {
        {% for acc_id, dt in (opening_balance_dates or {}).items() %}
          {{ acc_id }}: {{ (dt or '')|tojson }},
        {% endfor %}
      },
      allAccounts: [
        {% for acc in all_accounts %}
          { id: {{ acc.id }}, name: {{ (acc.name|tojson) }}, code: {{ (acc.code or '')|tojson }}, currency_code: {{ ((acc.currency_code or 'KRW')|upper|tojson) }} },
        {% endfor %}
      ],
      receivableAccounts: [
        {% for acc in receivable_accounts or [] %}
          { id: {{ acc.id }}, name: {{ (acc.name|tojson) }}, currency_code: {{ ((acc.currency_code or 'KRW')|upper|tojson) }} },
        {% endfor %}
      ],
      debtAccounts: [
        {% for acc in debt_accounts or [] %}
          { id: {{ acc.id }}, name: {{ (acc.name|tojson) }}, currency_code: {{ ((acc.currency_code or 'KRW')|upper|tojson) }} },
        {% endfor %}
      ],
      tbFirstMonth: {{ (tb_first_month.strftime('%Y-%m') if tb_first_month else '')|tojson }},
      tbInitializedOn: {{ (tb_initialized_on.isoformat() if tb_initialized_on else '')|tojson }}
    };
  </script>
  <script src="{{ url_for('static', filename='js/accounting.js') }}"></script>
  <div class="acc-shell">
    <header class="acc-hero">
      <div>
        <div class="acc-eyebrow">General ledger</div>
        <h1>Accounting</h1>
        <p class="acc-hero-lede">Manage folders, accounts, journals, receivables, and balance sheets in one workspace.</p>
      </div>
      <div class="acc-hero-meta">
        <span>Current view</span>
        <strong id="acc-current-view">Folders</strong>
        <small style="color:var(--text-muted);">Switch tabs to see more</small>
      </div>
    </header>
    <div class="acc-card acc-card-pad">
      <div class="view-toggle acc-pill-toggle">
        <button id="btn-view-folders" class="acc-pill-btn toggle-btn active"><i class="fa fa-bookmark"></i> Folders</button>
        <button id="btn-view-accounts" class="acc-pill-btn toggle-btn"><i class="fa fa-list"></i> Accounts</button>
        <button id="btn-view-journal" class="acc-pill-btn toggle-btn"><i class="fa fa-book"></i> Journal Entries</button>
        <button id="btn-view-trial" class="acc-pill-btn toggle-btn"><i class="fa fa-scale-balanced"></i> Trial Balance</button>
        <button id="btn-view-receivables" class="acc-pill-btn toggle-btn"><i class="fa fa-hand-holding-dollar"></i> Receivables & Debt</button>
        <button id="btn-view-balance" class="acc-pill-btn toggle-btn"><i class="fa fa-chart-pie"></i> Balance Sheet</button>
      </div>

    <!-- Folders View -->
    <div id="folders-view" class="tb-shell" style="display:block;">
      <div class="tb-hero">
        <div class="accounts-head-copy">
          <div class="tb-chip">Chart setup</div>
          <h3 class="tb-title">Folders workspace</h3>
          <p class="acc-note-muted">Add folders, pick one, and move accounts with the same tidy flow as Trial Balance.</p>
          <div class="tb-steps-row">
            <div class="tb-steps">
              <span class="tb-step-pill"><i class="fa fa-folder-plus"></i> Add folders</span>
              <span class="tb-step-pill"><i class="fa fa-hand-pointer"></i> Select folder</span>
              <span class="tb-step-pill"><i class="fa fa-share"></i> Move accounts</span>
            </div>
          </div>
        </div>
        <div class="tb-hero-meta">
          <div class="tb-status-card">
            <div class="tb-status-label">Selection</div>
            <div class="tb-status-value" id="folders-status">No folder selected</div>
            <div class="tb-status-sub">Use Clear to reset selection at any time.</div>
            <button id="btn-clear-selection" class="icon-btn tb-summary-toggle" title="Clear selection"><i class="fa fa-xmark"></i> Clear</button>
          </div>
        </div>
      </div>

      <div class="tb-step-card">
        <div class="tb-step-header">
          <div>
            <div class="tb-step-label">Step 1 · Manage folders</div>
            <div class="tb-step-title">Add and pick a folder</div>
            <p class="acc-note-muted">Folders group accounts for Trial Balance and Balance Sheet mapping.</p>
          </div>
        </div>
      </div>
        <div class="folders-grid">
          <!-- Left: Folder bookmarks -->
          <div class="acc-card acc-card-pad">
            <h3 class="acc-heading"><span><i class="fa fa-book-bookmark"></i> Folders</span></h3>
            <div class="add-folder">
              <input id="add-cat" type="text" placeholder="Add folder (e.g., Cash)">
              <button onclick="addCategory()"><i class="fa fa-folder-plus"></i> Add</button>
            </div>
            <ul class="folder-list sidebar">
              {% for cat in categories %}
                <li class="folder-item" data-id="{{ cat.id }}" onclick="modalMoveTo({{ cat.id }});" style="--folder-color: #{{ cat.color }};">
                  <div class="folder-icon"><i class="fa"></i></div>
                  <div class="folder-name" data-label>{{ cat.name }}</div>
                  <input class="rename-input" type="text" value="{{ cat.name }}">
                  <div class="folder-actions">
                    <div class="kebab">
                      <button class="kebab-btn" title="More" onclick="toggleFolderMenu(this)"><i class="fa fa-ellipsis-vertical"></i></button>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>

          <!-- Middle: Accounts inside selected folder -->
          <div id="pane-in-folder" class="acc-card acc-card-pad" style="display:none;">
            <h3 id="in-folder-title" class="acc-heading"><span><i class="fa fa-folder-open"></i> In Folder</span></h3>
            {% for cat in categories %}
              <div class="account-list dropzone in-folder-panel" data-folder-id="{{ cat.id }}" data-category-id="{{ cat.id }}" style="display:none;">
                {% for acc in accounts_by_category.get(cat.id, []) %}
                  <div class="account-row" draggable="true" data-id="{{ acc.id }}" data-name="{{ acc.name }}" data-code="{{ acc.code or '' }}" data-currency="{{ (acc.currency_code or 'KRW')|upper }}">
                    <div class="row-main"><span class="badge currency-badge" data-ccy="{{ (acc.currency_code or 'KRW')|upper }}">{{ (acc.currency_code or 'KRW')|upper }}</span> <strong>{{ acc.name }}</strong></div>
                    <div class="row-actions">
                      <button class="icon-btn" title="Move" onclick="openMoveModal({{ acc.id }}, '{{ acc.name|e }}')"><i class="fa fa-right-left"></i></button>
                      <div class="kebab">
                        <button class="kebab-btn" title="More" onclick="toggleRowMenu(this)"><i class="fa fa-ellipsis-vertical"></i></button>
                        <div class="dropdown">
                          <button class="menu-item" onclick="renameAccountFromButton(this)"><i class="fa fa-pen"></i> Rename</button>
                          <button class="menu-item" style="color:#b22222;" onclick="unassignAccount({{ acc.id }})"><i class="fa fa-unlink"></i> Unassign</button>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
            {% if not categories %}
              <div class="acc-note-muted">No folders yet. Add one on the left to get started.</div>
            {% endif %}
          </div>

          <!-- Right: Accounts not in the selected folder -->
          <div id="pane-notin" class="acc-card acc-card-pad" style="display:none;">
            <h3 class="acc-heading"><span><i class="fa fa-magnifying-glass"></i> Find Accounts</span></h3>
            <div class="search-bar acc-search-bar">
              <input id="notin-search" type="text" placeholder="Search accounts">
            </div>
            <div id="notin-list" class="account-list">
              {% for acc in all_accounts %}
                <div class="account-row" draggable="true" data-id="{{ acc.id }}" data-name="{{ acc.name }}" data-code="{{ acc.code or '' }}" data-cat-id="{{ acc.category_id or '' }}" data-currency="{{ (acc.currency_code or 'KRW')|upper }}">
                  <div class="row-main">
                    <span class="badge folder-badge">{% if acc.category %}{{ acc.category.name }}{% else %}Unassigned{% endif %}</span>
                    <span class="badge currency-badge" data-ccy="{{ (acc.currency_code or 'KRW')|upper }}">{{ (acc.currency_code or 'KRW')|upper }}</span>
                    <strong>{{ acc.name }}</strong>
                  </div>
                  <div class="row-actions">
                    <button class="icon-btn" title="Move to selected" onclick="moveToSelectedFolder({{ acc.id }})"><i class="fa fa-share"></i></button>
                    <div class="kebab">
                      <button class="kebab-btn" title="More" onclick="toggleRowMenu(this)"><i class="fa fa-ellipsis-vertical"></i></button>
                      <div class="dropdown">
                        <button class="menu-item" onclick="renameAccountFromButton(this)"><i class="fa fa-pen"></i> Rename</button>
                        <button class="menu-item" style="color:#b22222;" onclick="unassignAccount({{ acc.id }})"><i class="fa fa-unlink"></i> Unassign</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
    </div>

    <!-- Accounts View -->
    <div id="accounts-view" class="tb-shell" style="display:none;">
      <div class="journals-shell tb-shell">
        <div class="tb-hero">
          <div class="accounts-head-copy">
            <div class="tb-chip">Chart of accounts</div>
            <h3 class="tb-title">Accounts workspace</h3>
            <p class="acc-note-muted">Filter, select, and tidy every account with the same clean flow as Trial Balance.</p>
            <div class="tb-steps-row">
              <div class="tb-steps">
                <span class="tb-step-pill"><i class="fa fa-filter"></i> Filter</span>
                <span class="tb-step-pill"><i class="fa fa-square-check"></i> Select</span>
                <span class="tb-step-pill"><i class="fa fa-broom"></i> Tidy</span>
              </div>
            </div>
          </div>
          <div class="tb-hero-meta">
            <div class="tb-status-card">
              <div class="tb-status-label">Snapshot</div>
              <div class="tb-status-value">{{ all_accounts|length }} accounts</div>
              <div class="tb-status-sub">Unassigned: {{ all_accounts|selectattr('category_id', 'equalto', None)|list|length }} · Codes: Fxx-ppp-Aid</div>
              {% if user and user.is_admin %}
                <button class="icon-btn tb-summary-toggle" title="Refresh codes" onclick="refreshCodes()"><i class="fa fa-rotate"></i> Refresh codes</button>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1 · Filter</div>
              <div class="tb-step-title">Focus the chart quickly</div>
              <p class="acc-note-muted">Inline filters keep the chart lean while you bounce between folders.</p>
            </div>
            <div class="tb-toolbar acc-filter-toolbar">
              <div class="tb-toolbar-fields">
                <label class="tb-filter-field">
                  <i class="fa fa-magnifying-glass"></i>
                  <input id="acc-search" type="text" class="tb-input" placeholder="Find account or keyword">
                </label>
                <label class="tb-filter-field">
                  <i class="fa fa-folder-open"></i>
                  <select id="acc-folder-filter" class="tb-select">
                    <option value="">All folders</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </label>
                <label class="tb-filter-field tb-filter-toggle">
                  <input id="acc-only-uncat" type="checkbox">
                  <span>Only show uncategorized</span>
                </label>
              </div>
            </div>
          </div>
          <div class="tb-inline-note">Filters apply instantly across the accounts table and selections.</div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 2 · Select & tidy</div>
              <div class="tb-step-title">Move, unassign, or rename accounts</div>
              <p class="acc-note-muted">Quick actions and inline stats keep this workspace lean.</p>
            </div>
          </div>
          <div class="accounts-manage">
            <div class="acc-stat-row">
              <div class="acc-stat-chip"><i class="fa fa-database"></i> {{ all_accounts|length }} total</div>
              <div class="acc-stat-chip"><i class="fa fa-circle-exclamation"></i> {{ all_accounts|selectattr('category_id', 'equalto', None)|list|length }} unassigned</div>
              <div class="acc-stat-chip"><i class="fa fa-globe"></i> KRW · MYR · CNY</div>
              <div class="acc-stat-chip muted">Folders: {{ categories|length }}</div>
            </div>
            <div class="">
              <section class="accounts-panel-main">
                <div class="accounts-quick-actions compact">
                  <div class="quick-row">
                    <label class="quick-select-all">
                      <input type="checkbox" id="acc-select-all">
                      <span>Select all in view</span>
                    </label>
                    <span id="acc-selected-count" class="control-count">0 selected</span>
                    <div class="quick-row-actions">
                      <button class="icon-btn" id="acc-bulk-move" title="Move selected"><i class="fa fa-right-left"></i> Move</button>
                      <button class="icon-btn" id="acc-bulk-unassign" title="Unassign selected"><i class="fa fa-unlink"></i> Unassign</button>
                    </div>
                  </div>
                  <div class="quick-row quick-row-currency">
                    <div class="currency-label">
                      <span>Assign currency</span>
                      <small>Apply instantly to every selected account</small>
                    </div>
                    <div class="currency-field">
                      <select id="acc-bulk-ccy-select" class="acc-select">
                        <option value="KRW">KRW</option>
                        <option value="MYR">MYR</option>
                        <option value="CNY">CNY</option>
                      </select>
                      <button class="icon-btn" id="acc-bulk-ccy-apply" title="Assign currency"><i class="fa fa-coins"></i> Apply</button>
                    </div>
                  </div>
                </div>

                <div class="accounts-table-card">
                  <div class="acc-table-head">
                    <div>Select</div>
                    <div>Account</div>
                    <div style="text-align:right;">Actions</div>
                  </div>
                  <div id="acc-list" class="account-list modern-account-list">
                    {% for acc in all_accounts %}
                      <div class="acc-table-row account-row" draggable="false" data-id="{{ acc.id }}" data-name="{{ acc.name }}" data-code="{{ acc.code or '' }}" data-cat-id="{{ acc.category_id or '' }}" data-currency="{{ (acc.currency_code or 'KRW')|upper }}">
                        <div class="acc-col acc-col-select">
                          <input type="checkbox" class="acc-select" data-id="{{ acc.id }}">
                        </div>
                        <div class="acc-col acc-col-main row-main">
                          <div class="acc-name-line">
                            <strong>{{ acc.name }}</strong>
                            {% if acc.code %}
                              <span class="badge code-badge">{{ acc.code }}</span>
                            {% endif %}
                          </div>
                          <div class="acc-subline">
                            <span class="badge folder-badge">{% if acc.category %}{{ acc.category.name }}{% else %}Unassigned{% endif %}</span>
                            <span class="badge currency-badge" data-ccy="{{ (acc.currency_code or 'KRW')|upper }}">{{ (acc.currency_code or 'KRW')|upper }}</span>
                          </div>
                        </div>
                        <div class="acc-col acc-col-actions row-actions">
                          <button class="icon-btn" title="Move" onclick="openMoveModal({{ acc.id }}, '{{ acc.name|e }}')"><i class="fa fa-arrow-right-arrow-left"></i></button>
                          <div class="kebab">
                            <button class="kebab-btn" title="More" onclick="toggleRowMenu(this)"><i class="fa fa-ellipsis-vertical"></i></button>
                            <div class="dropdown">
                              <button class="menu-item" onclick="renameAccountFromButton(this)"><i class="fa fa-pen"></i> Rename</button>
                              <button class="menu-item" style="color:#b22222;" onclick="deleteAccountFromButton(this)"><i class="fa fa-trash"></i> Delete</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Journal Entries View -->
    <div id="journal-view" style="display:none;">
      <div class=" tb-shell journal-shell">
        <div class="tb-hero">
          <div class="accounts-head-copy">
            <div class="tb-chip">Ledger</div>
            <h3 class="tb-title">Journal Entries</h3>
            <p class="acc-note-muted">Filter, review, and edit entries with the same tidy flow as Trial Balance.</p>
            <div class="tb-steps-row">
              <div class="tb-steps">
                <span class="tb-step-pill"><i class="fa fa-filter"></i> Filter</span>
                <span class="tb-step-pill"><i class="fa fa-list"></i> Review</span>
                <span class="tb-step-pill"><i class="fa fa-pen"></i> Edit</span>
              </div>
            </div>
          </div>
          <div class="tb-hero-meta">
            <div class="tb-status-card">
              <div class="tb-status-label">Status</div>
              <div id="journal-status" class="tb-status-value">Select filters to load journal entries.</div>
              <div class="tb-status-sub">Filters persist while you navigate other tabs.</div>
            </div>
          </div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1 · Filter</div>
              <div class="tb-step-title">Narrow down journal entries</div>
              <p class="acc-note-muted">Search by text, date range, or account to load a focused list.</p>
            </div>
            <div class="tb-toolbar">
              <div class="tb-toolbar-fields">
                <label class="tb-filter-field">
                  <i class="fa fa-magnifying-glass"></i>
                  <input id="journal-search" type="text" class="tb-input" placeholder="Search description or reference" autocomplete="off">
                </label>
                <label class="tb-filter-field">
                  <i class="fa fa-calendar-day"></i>
                  <input id="journal-start" type="date" title="Start date" class="tb-input">
                </label>
                <label class="tb-filter-field">
                  <i class="fa fa-calendar-day"></i>
                  <input id="journal-end" type="date" title="End date" class="tb-input">
                </label>
                <label class="tb-filter-field">
                  <i class="fa fa-folder-open"></i>
                  <select id="journal-account" title="Filter by account" class="tb-select">
                    <option value="">All accounts</option>
                    {% for acc in all_accounts %}
                      <option value="{{ acc.id }}">{{ acc.name }}</option>
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div class="tb-toolbar-fields">
                <button id="journal-apply" class="icon-btn tb-summary-toggle"><i class="fa fa-rotate"></i> Apply</button>
                <button id="journal-reset" class="icon-btn btn-danger-ghost"><i class="fa fa-eraser"></i> Reset</button>
              </div>
            </div>
          </div>
          <div id="journal-feedback" class="journal-feedback" style="display:none;"></div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 2 · Review & edit</div>
              <div class="tb-step-title">Browse the list and open an entry</div>
              <p class="acc-note-muted">Click any row to inspect details; edits stay in sync with filters.</p>
            </div>
          </div>
        </div>
          <div class="journal-split">
            <div>
              <div class="journal-list" id="journal-list">
                <div id="journal-table" class="journal-table">
                  <div class="journal-placeholder">Select filters and click Apply to load journal entries.</div>
                </div>
                <div id="journal-pagination" class="journal-pagination"></div>
              </div>
            </div>
            <div class="journal-editor" id="journal-editor">
              <div class="journal-editor-empty"><i class="fa fa-circle-info"></i> Select a journal entry to review or edit.</div>
            </div>
          </div>
      </div>
    </div>

    <!-- Receivables & Debt View -->
    <div id="receivables-view" style="display:none;">
      <div class="tb-shell journals-shell">
        <div class="tb-hero">
          <div class="accounts-head-copy">
            <div class="tb-chip">Receivables</div>
            <h3 class="tb-title">Accounts Receivable & Short-Term Debt</h3>
            <p class="acc-note-muted">Track open balances, add contact and due dates, and keep multi-currency threads tidy.</p>
            <div class="tb-steps-row">
              <div class="tb-steps">
                <span class="tb-step-pill"><i class="fa fa-filter"></i> Filter</span>
                <span class="tb-step-pill"><i class="fa fa-list"></i> Review</span>
                <span class="tb-step-pill"><i class="fa fa-pen"></i> Update</span>
              </div>
            </div>
          </div>
          <div class="tb-hero-meta">
            <div class="tb-status-card">
              <div class="tb-status-label">Status</div>
              <div id="rd-status" class="tb-status-value">Loading receivables…</div>
              <div class="tb-status-sub">Filters persist while you jump between tabs.</div>
            </div>
          </div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1 · Filter</div>
              <div class="tb-step-title">Focus receivables & debt</div>
              <p class="acc-note-muted">Choose type, currency, and tab to view saved or needs-info threads.</p>
            </div>
            <div class="tb-toolbar">
              <div class="tb-toolbar-fields">
                <label class="tb-filter-field">
                  <span style="font-weight:600;color:#1a4d2e;">Type</span>
                  <select id="rd-type-filter" class="tb-select">
                    <option value="all">All</option>
                    <option value="receivable">Receivable</option>
                    <option value="debt">Short-Term Debt</option>
                  </select>
                </label>
                <label class="tb-filter-field">
                  <span style="font-weight:600;color:#1a4d2e;">Currency</span>
                  <select id="rd-currency-filter" class="tb-select">
                    <option value="">All</option>
                  </select>
                </label>
                <div class="rd-tabs">
                  <button id="rd-tab-saved" class="rd-tab-btn active"><i class="fa fa-circle-check"></i> Saved <span id="rd-count-saved" class="rd-tab-count">0</span></button>
                  <button id="rd-tab-unsaved" class="rd-tab-btn"><i class="fa fa-pen"></i> Needs Info <span id="rd-count-unsaved" class="rd-tab-count">0</span></button>
                </div>
              </div>
              <div class="tb-toolbar-fields">
                <button id="rd-refresh-btn" class="icon-btn tb-summary-toggle"><i class="fa fa-rotate"></i> Refresh</button>
                <button id="rd-add-entry-btn" class="icon-btn rd-primary-btn"><i class="fa fa-plus"></i> Add Receivable/Debt</button>
              </div>
            </div>
          </div>
          <div class="tb-inline-note">Transactions that touch receivable or short-term debt folders appear here automatically.</div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 2 · Review & update</div>
              <div class="tb-step-title">Manage balances and contacts</div>
              <p class="acc-note-muted">Open a row to add contact details, due dates, and payment progress.</p>
            </div>
          </div>
          <div id="rd-summary" style="display:flex;gap:12px;font-size:12px;color:#1a4d2e;opacity:.75;margin-bottom:8px;"></div>
          <div id="rd-pagination" class="rd-pagination"></div>
        </div>
          <div id="rd-list" class="rd-list">
            <div class="rd-empty">No receivable or short-term debt activity yet.</div>
          </div>
          <div id="rd-groups-title" class="rd-groups-title" style="display:none;">Balances by contact</div>
          <div id="rd-group-controls" class="rd-group-controls" style="display:none;">
            <div class="rd-group-view-toggle" role="group" aria-label="Contact display mode">
              <button type="button" id="rd-contact-view-cards" class="rd-view-btn active"><i class="fa fa-border-all"></i> Cards</button>
              <button type="button" id="rd-contact-view-list" class="rd-view-btn"><i class="fa fa-list"></i> List</button>
            </div>
            <div class="rd-group-sort">
              <label for="rd-group-sort-select">Sort by</label>
              <select id="rd-group-sort-select">
                <option value="alpha">Alphabetical</option>
                <option value="receivable">Receivable amount</option>
                <option value="debt">Payable amount</option>
              </select>
            </div>
          </div>
          <div id="rd-groups" class="rd-groups"></div>
          <div style="font-size:11px;color:#1a4d2e;opacity:.6;margin-top:8px;">Tip: link repayments to their related origin entries so the contact overview can summarise outstanding balances across currencies.</div>
      </div>
    </div>
    <div id="rd-create-modal" class="rd-modal" aria-hidden="true">
      <div class="rd-modal-backdrop"></div>
      <div class="rd-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="rd-create-title" tabindex="-1">
        <div class="rd-modal-header">
          <h3 id="rd-create-title">Add Receivable or Short-Term Debt</h3>
          <button type="button" class="rd-modal-close" id="rd-create-close" aria-label="Close dialog"><i class="fa fa-xmark"></i></button>
        </div>
        <form id="rd-create-form" class="rd-create-form">
          <div class="rd-create-grid">
            <label>
              <span>Type</span>
              <select id="rd-create-type" class="rd-input">
                <option value="receivable">Receivable</option>
                <option value="debt">Short-Term Debt</option>
              </select>
            </label>
            <label>
              <span>Primary account</span>
              <select id="rd-create-account" class="rd-input" required></select>
            </label>
            <label>
              <span>Date</span>
              <input type="date" id="rd-create-date" class="rd-input" required>
            </label>
            <label>
              <span>Currency</span>
              <input type="text" id="rd-create-currency" class="rd-input" maxlength="6" placeholder="KRW">
            </label>
            <label>
              <span>Amount</span>
              <input type="number" step="0.01" min="0.01" id="rd-create-amount" class="rd-input" required>
            </label>
            <label>
              <span>Description</span>
              <input type="text" id="rd-create-description" class="rd-input" placeholder="e.g., Invoice #1042" required>
            </label>
            <label>
              <span>Reference (optional)</span>
              <input type="text" id="rd-create-reference" class="rd-input" placeholder="Ref code">
            </label>
            <label>
              <span>Memo (optional)</span>
              <input type="text" id="rd-create-memo" class="rd-input" placeholder="Internal memo">
            </label>
            <label>
              <span>Contact name</span>
              <input type="text" id="rd-create-contact" class="rd-input" placeholder="Customer or vendor" required>
            </label>
            <label>
              <span>Due date</span>
              <input type="date" id="rd-create-due" class="rd-input">
            </label>
            <label>
              <span>Payment dates (one per line)</span>
              <textarea id="rd-create-payments" class="rd-input" rows="3" placeholder="2024-09-01&#10;2024-10-01"></textarea>
            </label>
            <label class="rd-create-notes">
              <span>Notes</span>
              <textarea id="rd-create-notes" class="rd-input" rows="3" placeholder="Any additional context"></textarea>
            </label>
          </div>
          <div id="rd-create-feedback" class="rd-create-feedback"></div>
          <div class="rd-create-actions">
            <button type="button" class="icon-btn" id="rd-create-cancel"><i class="fa fa-xmark"></i> Cancel</button>
            <button type="submit" class="icon-btn rd-primary-btn" id="rd-create-submit"><i class="fa fa-floppy-disk"></i> Save entry</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Balance Sheet View -->
    <div id="balance-view" style="display:none;">
      <div class="tb-shell journals-shell">
        <div class="tb-hero">
          <div class="accounts-head-copy">
            <div class="tb-chip">Month-close</div>
            <h3 class="tb-title">Balance Sheet</h3>
            <p class="acc-note-muted">Follow the same tidy flow as Trial Balance: pick your period, focus a currency, and inspect folders behind every total.</p>
            <div class="tb-steps-row">
              <div class="tb-steps">
                <span class="tb-step-pill"><i class="fa fa-calendar-days"></i> Choose month</span>
                <span class="tb-step-pill"><i class="fa fa-coins"></i> Focus currency</span>
                <span class="tb-step-pill"><i class="fa fa-rotate"></i> Refresh totals</span>
              </div>
              <button id="bs-refresh-btn" type="button" class="icon-btn tb-summary-toggle"><i class="fa fa-rotate"></i> Refresh</button>
            </div>
          </div>
          <div class="tb-hero-meta">
            <div class="tb-status-card">
              <div class="tb-status-label">Status</div>
              <div id="bs-status" class="tb-status-value">Select a month to view your balance sheet.</div>
              <div class="tb-status-sub">Filters persist while you jump between tabs.</div>
            </div>
          </div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1 · Filters</div>
              <div class="tb-step-title">Lock the review window</div>
              <p class="acc-note-muted">Pick the closing month and optionally zoom in on a reporting currency.</p>
            </div>
            <div class="tb-toolbar">
              <div class="tb-toolbar-fields">
                <select id="bs-month-select" class="tb-select">
                  <option value="">Select month…</option>
                </select>
                <select id="bs-ccy-select" class="tb-select">
                  <option value="">All CCY</option>
                  <option value="KRW">KRW</option>
                  <option value="MYR">MYR</option>
                  <option value="CNY">CNY</option>
                </select>
              </div>
            </div>
          </div>
          <div class="tb-inline-note">Use Refresh after journals change to pull the latest trial balance totals.</div>
        </div>

        <div class="tb-monthly-card bs-monthly-card">
          <div class="tb-toolbar">
            <div class="tb-toolbar-title"><i class="fa fa-scale-balanced"></i> Balance snapshot</div>
            <div class="tb-inline-note">Totals mirror the Trial Balance mapping.</div>
          </div>
          <div id="bs-summary-cards" class="bs-summary-grid"></div>
        </div>

        <div class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 2 · Breakdown</div>
              <div class="tb-step-title">Review folders behind each total</div>
              <p class="acc-note-muted">Expand assets or liabilities to see their accounts, then reconcile equity.</p>
            </div>
          </div>
          <div class="bs-layout">
            <section class="bs-main">
              <div id="bs-grid" class="bs-columns">
                <section class="bs-column">
                  <div class="bs-column-label"><i class="fa fa-vault"></i> Assets</div>
                  <div id="bs-assets" class="bs-group-list"></div>
                </section>
                <section class="bs-column">
                  <div class="bs-column-label"><i class="fa fa-file-invoice-dollar"></i> Liabilities</div>
                  <div id="bs-liabilities" class="bs-group-list"></div>
                </section>
              </div>
              <div id="bs-equity-note" class="bs-equity-note"></div>
            </section>
            <aside class="bs-secondary">
              <div class="bs-secondary-card">
                <h4>Close checklist</h4>
                <ul>
                  <li>Map folders in Trial Balance once and reuse monthly.</li>
                  <li>Reconcile Receivables &amp; Debt threads first.</li>
                  <li>Export supporting PDFs when equity ties out.</li>
                </ul>
              </div>
              <div class="bs-secondary-card">
                <h4>Keep tidy</h4>
                <p>Need to add, rename, or re-code an account? Handle it in Accounts; refresh pulls the latest automatically.</p>
              </div>
            </aside>
          </div>
        </div>
      </div>
      <script>
      window.BALANCE_STATE = window.BALANCE_STATE || {};

      function ensureBalanceState() {
        if (!window.BALANCE_STATE) { window.BALANCE_STATE = {}; }
        return window.BALANCE_STATE;
      }

      function buildBalanceMonths() {
        const months = [];
        const pad = (n) => (n < 10 ? '0' + n : '' + n);
        const now = new Date();
        now.setDate(1);
        let startDate = null;
        const initIso = (window.ACC_BOOT && window.ACC_BOOT.tbInitializedOn) ? window.ACC_BOOT.tbInitializedOn : '';
        if (initIso) {
          const dt = new Date(initIso);
          if (!isNaN(dt.getTime())) { dt.setDate(1); startDate = dt; }
        }
        if (!startDate || startDate > now) {
          startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);
        }
        const cursor = new Date(startDate.getTime());
        while (cursor <= now) {
          const ym = `${cursor.getFullYear()}-${pad(cursor.getMonth() + 1)}`;
          const label = cursor.toLocaleString(undefined, { month: 'long', year: 'numeric' });
          months.push({ value: ym, label });
          cursor.setMonth(cursor.getMonth() + 1);
        }
        return months;
      }

      function initBalanceSheetUI() {
        const state = ensureBalanceState();
        if (state.initialized) {
          if (state.pending) {
            renderBalanceSheetFromData(state.pending.data, state.pending.context);
            state.pending = null;
          }
          return;
        }
        const monthSelect = document.getElementById('bs-month-select');
        const status = document.getElementById('bs-status');
        if (!monthSelect) return;
        const months = buildBalanceMonths();
        const optionsHtml = months.map(m => `<option value="${m.value}">${m.label}</option>`).join('');
        monthSelect.innerHTML = '<option value="">Select month…</option>' + optionsHtml;
        if (months.length) {
          monthSelect.value = months[months.length - 1].value;
        }
        const render = () => { renderBalanceSheet(monthSelect.value); };
        monthSelect.addEventListener('change', render);
        const ccySelect = document.getElementById('bs-ccy-select');
        if (ccySelect) {
          ccySelect.addEventListener('change', () => renderBalanceSheet(monthSelect.value));
        }
        const refreshBtn = document.getElementById('bs-refresh-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => renderBalanceSheet(monthSelect.value));
        }
        state.initialized = true;
        if (state.pending) {
          renderBalanceSheetFromData(state.pending.data, state.pending.context);
          state.pending = null;
        } else if (months.length) {
          renderBalanceSheet(monthSelect.value);
        } else if (status) {
          status.textContent = 'No months available. Configure your trial balance to generate balance sheet data.';
        }
      }

      function renderBalanceSheet(monthStr) {
        const status = document.getElementById('bs-status');
        const summary = document.getElementById('bs-summary-cards');
        const assetsContainer = document.getElementById('bs-assets');
        const liabilitiesContainer = document.getElementById('bs-liabilities');
        const note = document.getElementById('bs-equity-note');
        if (!summary || !assetsContainer || !liabilitiesContainer) return;
        if (!monthStr) {
          summary.innerHTML = '';
          assetsContainer.innerHTML = '';
          liabilitiesContainer.innerHTML = '';
          if (status) status.textContent = 'Select a month to view your balance sheet.';
          if (note) note.textContent = '';
          return;
        }
        if (status) status.textContent = 'Loading balance sheet…';
        const ccySelect = document.getElementById('bs-ccy-select');
        const ccy = ccySelect ? (ccySelect.value || '') : '';
        const url = ccy ? `/accounting/tb/monthly?ym=${encodeURIComponent(monthStr)}&ccy=${encodeURIComponent(ccy)}`
                        : `/accounting/tb/monthly?ym=${encodeURIComponent(monthStr)}`;
        fetch(url)
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if (!ok || (data && data.ok === false)) {
              const errMsg = (data && data.error) || 'Unable to load balance sheet.';
              if (status) status.textContent = errMsg;
              summary.innerHTML = '';
              assetsContainer.innerHTML = '';
              liabilitiesContainer.innerHTML = '';
              if (note) note.textContent = '';
              return;
            }
            const [y, m] = monthStr.split('-');
            let monthName = monthStr;
            try {
              monthName = new Date(parseInt(y, 10), parseInt(m, 10) - 1, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
            } catch (_) {}
            const context = { month: monthStr, monthName, currency: ccy };
            const state = ensureBalanceState();
            state.latestFetch = { data, context };
            renderBalanceSheetFromData(data, context);
          })
          .catch(err => {
            console.error(err);
            if (status) status.textContent = 'Unable to load balance sheet.';
            summary.innerHTML = '';
            assetsContainer.innerHTML = '';
            liabilitiesContainer.innerHTML = '';
            if (note) note.textContent = '';
          });
      }

      function extractTotalValue(total) {
        if (!total || typeof total !== 'object') return 0;
        if (typeof total.balance === 'number') return total.balance;
        if (typeof total.total === 'number') return total.total;
        if (typeof total.sum === 'number') return total.sum;
        return 0;
      }

      function renderBalanceSheetFromData(data, context) {
        const status = document.getElementById('bs-status');
        const summary = document.getElementById('bs-summary-cards');
        const assetsContainer = document.getElementById('bs-assets');
        const liabilitiesContainer = document.getElementById('bs-liabilities');
        const note = document.getElementById('bs-equity-note');
        if (!summary || !assetsContainer || !liabilitiesContainer) return;
        if (!data || !data.totals) {
          summary.innerHTML = '';
          assetsContainer.innerHTML = '';
          liabilitiesContainer.innerHTML = '';
          if (status) status.textContent = 'No balance sheet data available yet.';
          if (note) note.textContent = '';
          return;
        }
        const assetItems = (data.groups && data.groups.asset) || [];
        const liabilityItems = (data.groups && data.groups.liability) || [];
        const assetTotal = extractTotalValue(data.totals.asset);
        const liabilityTotal = extractTotalValue(data.totals.liability);
        const equityValue = assetTotal - liabilityTotal;
        const monthLabel = context && (context.monthName || context.month) ? (context.monthName || context.month) : 'selected period';
        const ccyLabel = context && context.currency ? context.currency : 'All CCY';
        if (status) status.textContent = `Balance sheet for ${monthLabel} (${ccyLabel || 'All CCY'})`;
        const multiCurrency = !context || !context.currency;
        const assetCurrencyMap = multiCurrency ? aggregateGroupCurrencyTotals(assetItems) : null;
        const liabilityCurrencyMap = multiCurrency ? aggregateGroupCurrencyTotals(liabilityItems) : null;
        const equityCurrencyMap = multiCurrency ? mergeCurrencyMaps(cloneCurrencyMap(assetCurrencyMap), liabilityCurrencyMap, -1) : null;
        const assetDisplay = multiCurrency ? formatCurrencyByMap(assetCurrencyMap, 'balance', assetTotal) : formatCurrency(assetTotal);
        const liabilityDisplay = multiCurrency ? formatCurrencyByMap(liabilityCurrencyMap, 'balance', liabilityTotal) : formatCurrency(liabilityTotal);
        const equityDisplay = multiCurrency ? formatCurrencyByMap(equityCurrencyMap, 'balance', equityValue) : formatCurrency(equityValue);
        const cardTemplate = (title, valueLabel, icon, toneClass) => `
          <article class="bs-summary-card ${toneClass}">
            <div class="bs-summary-icon"><i class="fa ${icon}"></i></div>
            <div class="bs-summary-body">
              <span>${escapeHtml(title)}</span>
              <strong>${escapeHtml(valueLabel)}</strong>
            </div>
          </article>`;
        summary.innerHTML = [
          cardTemplate('Assets', assetDisplay, 'fa-vault', 'tone-assets'),
          cardTemplate('Liabilities', liabilityDisplay, 'fa-file-invoice-dollar', 'tone-liabilities'),
          cardTemplate('Equity (Assets - Liabilities)', equityDisplay, 'fa-scale-balanced', 'tone-equity')
        ].join('');
        renderBalanceGroup(assetsContainer, assetItems, 'No asset data available.');
        renderBalanceGroup(liabilitiesContainer, liabilityItems, 'No liability data available.');
        if (note) {
          const safeMonth = escapeHtml(monthLabel);
          const safeCcy = escapeHtml(ccyLabel || 'All CCY');
          const safeEquity = escapeHtml(equityDisplay);
          note.innerHTML = `<strong>Equity check:</strong> ${safeMonth} (${safeCcy}) closes at <span class="bs-note-value">${safeEquity}</span>. Reconcile with Trial Balance if something looks off.`;
        }
      }

      function renderBalanceGroup(container, items, emptyMessage) {
        container.innerHTML = '';
        if (!items || !items.length) {
          const empty = document.createElement('div');
          empty.className = 'bs-empty';
          empty.textContent = emptyMessage;
          container.appendChild(empty);
          return;
        }
        items.forEach(it => {
          const wrapper = document.createElement('article');
          wrapper.className = 'bs-group';
          const header = document.createElement('div');
          header.className = 'bs-group-head';
          const title = document.createElement('div');
          title.className = 'bs-group-title';
          title.innerHTML = `<i class="fa fa-folder-open"></i> ${escapeHtml(it.category_name || 'Folder')}`;
          const right = document.createElement('div');
          right.className = 'bs-group-right';
          const value = document.createElement('div');
          value.className = 'bs-group-value';
          value.textContent = formatCurrency(it.balance || 0);
          right.appendChild(value);
          const accounts = it.accounts || [];
          let details = null;
          if (accounts.length) {
            const caret = document.createElement('span');
            caret.className = 'bs-group-caret';
            caret.innerHTML = '<i class="fa fa-chevron-down"></i>';
            right.appendChild(caret);
            details = document.createElement('div');
            details.className = 'bs-group-body';
            accounts.forEach(acc => {
              const row = document.createElement('div');
              row.className = 'bs-group-row';
              row.innerHTML = `<span>${escapeHtml(acc.name || 'Account')}</span><span>${formatCurrency(acc.balance || 0)}</span>`;
              details.appendChild(row);
            });
            details.style.display = 'none';
            const setOpen = (open) => {
              wrapper.classList.toggle('open', open);
              details.style.display = open ? 'block' : 'none';
              header.setAttribute('aria-expanded', open ? 'true' : 'false');
            };
            const toggle = () => setOpen(!wrapper.classList.contains('open'));
            header.setAttribute('role', 'button');
            header.setAttribute('tabindex', '0');
            header.setAttribute('aria-expanded', 'false');
            header.addEventListener('click', toggle);
            header.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter' || ev.key === ' ') {
                ev.preventDefault();
                toggle();
              }
            });
          } else {
            header.classList.add('bs-group-static');
          }
          header.appendChild(title);
          header.appendChild(right);
          wrapper.appendChild(header);
          if (details) {
            wrapper.appendChild(details);
          }
          container.appendChild(wrapper);
        });
      }

      function renderBalanceSheetFromMonthly(data, context) {
        const state = ensureBalanceState();
        state.latestFetch = { data, context };
        if (state.initialized) {
          renderBalanceSheetFromData(data, context);
        } else {
          state.pending = { data, context };
        }
      }

      window.initBalanceSheetUI = initBalanceSheetUI;
      window.renderBalanceSheetFromMonthly = renderBalanceSheetFromMonthly;
    </script>
</div>

    <!-- Trial Balance View: First-time initializer + drag-and-drop grouping -->
    <div id="trial-view" style="display:none;">
      <div class="journals-shell tb-shell">
        <div class="tb-hero">
          <div class="accounts-head-copy">
            <div class="tb-chip">Month-close</div>
            <h3 class="tb-title">Trial Balance</h3>
            <p class="acc-note-muted">Move folders into balance groupings, capture opening balances, and review monthly totals in one guided flow.</p>
            <div class="tb-steps-row">
              <div class="tb-steps">
                <span class="tb-step-pill"><i class="fa fa-puzzle-piece"></i> Group folders</span>
                <span class="tb-step-pill"><i class="fa fa-clipboard-list"></i> Set opening balances</span>
                <span class="tb-step-pill"><i class="fa fa-calendar-days"></i> Review monthly view</span>
              </div>
              <button id="tb-summary-toggle" type="button" class="icon-btn tb-summary-toggle" aria-pressed="false"><i class="fa fa-eye"></i> Overview</button>
            </div>
          </div>
          <div class="tb-hero-meta">
            {% set tb_is_initialized = tb_initialized_on is not none %}
            {% set tb_has_first_month = tb_first_month is not none %}
            <div class="tb-status-card">
              <div class="tb-status-label">Status</div>
              <div class="tb-status-value">
                {% if tb_is_initialized %}
                  Initialized
                {% elif tb_has_first_month %}
                  Scheduled
                {% else %}
                  Not initialized
                {% endif %}
              </div>
              <div class="tb-status-sub">
                {% if tb_is_initialized %}
                  Initialized on {{ tb_initialized_on.strftime('%b %d, %Y') }}
                {% elif tb_has_first_month %}
                  First month locked to {{ tb_first_month.strftime('%b %Y') }}.
                {% else %}
                  Refreshes as soon as you set the initialization date.
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Step 1: Initial prompt and folder assignment -->
        <div id="tb-init-prompt" class="tb-step-card">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1</div>
              <div class="tb-step-title">Initialize your Trial Balance</div>
              <p class="acc-note-muted">Drag each folder into Asset, Liability, Equity, Expense, or Income. Click Start to organize.</p>
            </div>
            <button id="tb-start-btn" class="icon-btn tb-primary"><i class="fa fa-play"></i> Start</button>
          </div>
        </div>

        <div id="tb-assigner" class="tb-step-card" style="display:none;">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 1 · Folder grouping</div>
              <div class="tb-step-title">Drag folders into their natural buckets</div>
              <p class="acc-note-muted">Use the dropzones to map folders once. We will re-use this mapping for every close.</p>
            </div>
            <button id="tb-next-btn" class="button tb-primary" style="display:none;"><i class="fa fa-arrow-right"></i> Next</button>
          </div>
          <div class="tb-assigner-grid">
            <div class="tb-pool">
              <div class="tb-pool-head">Folders</div>
              <div id="tb-folder-list" class="dropzone tb-drop-pool" data-tb-target="unassigned">
                {% for cat in categories if not cat.tb_group %}
                  <div class="tb-folder" draggable="true" data-id="{{ cat.id }}" data-name="{{ cat.name }}" data-group="{{ cat.tb_group or '' }}">
                    <div class="tb-folder-icon"><i class="fa fa"></i></div>
                    <div class="folder-name" data-name>{{ cat.name }}</div>
                    <span class="badge muted">Unassigned</span>
                  </div>
                {% endfor %}
              </div>
              <div class="tb-pool-foot">Drag a folder back here to unassign.</div>
            </div>
            <div class="tb-box-grid">
              <div id="tb-box-asset" class="tb-box dropzone" data-tb-target="asset"></div>
              <div id="tb-box-liability" class="tb-box dropzone" data-tb-target="liability"></div>
              <div id="tb-box-equity" class="tb-box dropzone" data-tb-target="equity"></div>
              <div id="tb-box-expense" class="tb-box dropzone" data-tb-target="expense"></div>
              <div id="tb-box-income" class="tb-box dropzone" data-tb-target="income"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Initial balances -->
        <div id="tb-setup" class="tb-step-card" style="display:none;">
          <div class="tb-step-header">
            <div>
              <div class="tb-step-label">Step 2 · Opening balances</div>
              <div class="tb-step-title">Record the initialization date and balances</div>
            </div>
            <button id="tb-complete-btn" class="button tb-primary" style="display:none;"><i class="fa fa-check"></i> Finish</button>
          </div>
          <div class="tb-setup-grid">
            <div class="tb-setup-side">
              <div class="tb-subhead">Categories</div>
              <div id="tb-cat-list" class="tb-panel"></div>
            </div>
            <div class="tb-setup-main">
              <div id="tb-init-callout" class="tb-init-callout">
                <div class="tb-init-callout-head">
                  <i class="fa fa-circle-info"></i>
                  <div>
                    <div class="tb-init-title">Enter today's balances</div>
                    <p>Only transactions dated on or after this initialization date will appear in trial balance totals; older uploads stay in the system for reference only.</p>
                  </div>
                </div>
                <label for="tb-init-date" class="tb-init-date">
                  <span>Initialization date</span>
                  <input type="date" id="tb-init-date">
                </label>
              </div>
              <div class="tb-subhead" id="tb-cat-title">Select a category</div>
              <div id="tb-folder-accounts" class="tb-panel"></div>
            </div>
          </div>
        </div>
          <div id="tb-monthly" class="tb-monthly-card">
            <div class="tb-toolbar">
              <div class="tb-toolbar-title"><i class="fa fa-calendar-days"></i> Monthly Trial Balance</div>
              <div class="tb-toolbar-fields">
                <select id="tb-ccy-select" class="tb-select">
                  <option value="">All CCY</option>
                  <option value="KRW">KRW</option>
                  <option value="MYR">MYR</option>
                  <option value="CNY">CNY</option>
                </select>
                <select id="tb-month-select" class="tb-select"></select>
                <button id="tb-month-clear" class="icon-btn btn-danger-ghost"><i class="fa fa-eraser"></i> Clear</button>
                <select id="tb-report-scope" class="tb-select">
                  <option value="folders">Folder totals (half)</option>
                  <option value="full">Detailed (accounts)</option>
                </select>
                <button id="tb-month-pdf" class="icon-btn"><i class="fa fa-file-pdf"></i> Download PDF</button>
              </div>
            </div>
            <div id="tb-monthly-results" class="tb-monthly-results"></div>
          </div>
        <!-- Setup summary and monthly trial table -->
        <div id="tb-summary" class="tb-step-card" style="display:none;">
          <div id="tb-summary-header" class="tb-step-header">
            <div class="tb-summary-inline">
              <div class="tb-step-label">Overview</div>
              <div class="tb-step-title">Initialized Balance snapshots</div>
              <div class="tb-inline-note">Initialization date: <span id="tb-summary-init-date">Not set</span>. Only transactions on or after this day are included in calculations.</div>
            </div>
            <button id="tb-reset-btn" class="icon-btn btn-danger-ghost"><i class="fa fa-rotate-left"></i> Reset Trial Balance</button>
          </div>
          <div id="tb-summary-cards" class="tb-summary-cards"></div>
        </div>
        <script>
        // Trial Balance Setup Step Logic
        document.addEventListener('DOMContentLoaded', function() {
          const startBtn = document.getElementById('tb-start-btn');
          const assigner = document.getElementById('tb-assigner');
          const nextBtn = document.getElementById('tb-next-btn');
          const setupStep = document.getElementById('tb-setup');
          const completeBtn = document.getElementById('tb-complete-btn');
          const initPrompt = document.getElementById('tb-init-prompt');

          // Step 1: Show assigner after start
          if (startBtn) {
            startBtn.addEventListener('click', function() {
              initPrompt.style.display = 'none';
              assigner.style.display = 'grid';
            });
          }

          // Step 1: Show next button after all folders assigned
          function checkAllFoldersAssigned() {
            const unassigned = document.querySelectorAll('#tb-folder-list .tb-folder');
            if (unassigned.length === 0) {
              nextBtn.style.display = 'inline-block';
            } else {
              nextBtn.style.display = 'none';
            }
          }
          // Listen for folder assignment changes
          document.querySelectorAll('.tb-box.dropzone, #tb-folder-list').forEach(box => {
            box.addEventListener('drop', function() {
              setTimeout(checkAllFoldersAssigned, 100);
            });
          });

          // Step 2: Show setup after next
          if (nextBtn) {
            nextBtn.addEventListener('click', function() {
              assigner.style.display = 'none';
              setupStep.style.display = 'grid';
            });
          }

          // Step 2: Show finish after all initial balances filled
          function checkAllBalancesFilled() {
            const inputs = setupStep.querySelectorAll('input[type="number"]');
            let allFilled = true;
            inputs.forEach(input => {
              if (!input.value || isNaN(parseFloat(input.value))) {
                allFilled = false;
              }
            });
            completeBtn.style.display = allFilled ? 'inline-block' : 'none';
          }
          setupStep.addEventListener('input', function(e) {
            if (e.target.type === 'number') {
              checkAllBalancesFilled();
            }
          });

          // Step 2: Show summary after finish
          bindTrialCompleteButton();
          initInitializationDateUI();
          initSummaryToggle();

          // Show summary if DB already initialized (server can toggle this)
          const alreadyInitialized = !!(window.ACC_BOOT && (window.ACC_BOOT.tbFirstMonth || window.ACC_BOOT.tbInitializedOn));
          if (alreadyInitialized) {
            showTrialSummaryOnly();
            if (initPrompt) initPrompt.style.display = 'none';
            if (assigner) assigner.style.display = 'none';
            if (setupStep) setupStep.style.display = 'none';
            refreshSummaryInitializationDate();
            attachTrialResetHandler();
          }
        });
        </script>
    </div>

    <datalist id="journal-account-options">
      {% for acc in all_accounts %}
        <option value="{{ acc.name|e }}">
      {% endfor %}
    </datalist>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
          {% for message in messages %}
            <li style="color:#b22222;font-weight:500;">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    </div>
  </div>

  <!-- Move Modal -->
  <div id="modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 style="margin:0; color:#228b22;"><i class="fa fa-folder-open"></i> Move “<span id="modal-acc-name"></span>” to…</h3>
        <button id="modal-close" class="modal-close">×</button>
      </div>
      <div style="margin-top:10px;" class="add-folder">
        <input id="modal-add-cat" type="text" placeholder="Add new folder">
        <button onclick="modalAddFolder()"><i class="fa fa-folder-plus"></i></button>
      </div>
      <ul class="folder-list" style="margin-top:10px;">
        {% for cat in categories %}
          <li class="folder-item" data-id="{{ cat.id }}" onclick="(window.bulkMoveIds && window.bulkMoveIds.length) ? modalMoveToBulk({{ cat.id }}) : modalMoveTo({{ cat.id }})" style="--folder-color:#51cf66;">
            <div class="folder-icon"><i class="fa"></i></div>
            <div class="folder-name">{{ cat.name }}</div>
          </li>
        {% endfor %}
      </ul>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;">
        <button class="icon-btn" onclick="closeMoveModal()"><i class="fa fa-xmark"></i> Cancel</button>
      </div>
  </div>
  </div>

  <div class="journal-entry">
    
    {% if transaction is defined %}
      <span class="transaction-ref" title="Reference Code" style="font-weight: bold;">
          {{ transaction.reference_code|default('') }}
      </span>

      <button class="options-button" onclick="toggleDelete(this)">⋮</button>
      <button class="delete-button" style="display: none;" onclick="deleteTransaction('{{ transaction.id }}')">Delete</button>
    {% endif %}
  </div>

  <script>
  function toggleDelete(button) {
      // Find the closest journal entry container
      var entry = button.closest('.journal-entry');
      var deleteBtn = entry.querySelector('.delete-button');
      if (!deleteBtn) return;
      // Toggle display style
      if (deleteBtn.style.display === "none" || deleteBtn.style.display === "") {
          deleteBtn.style.display = "inline-block";
      } else {
          deleteBtn.style.display = "none";
      }
  }
  </script>
</body>
<script>
  // Trial Balance grouping UI
  const TB_GROUPS = [
    {key:'asset', icon:'fa-wallet', title:'Assets', hint:'Resources owned (cash, bank, receivables, inventory, fixed assets).', color:'#d3f9d8'},
    {key:'liability', icon:'fa-scale-balanced', title:'Liabilities', hint:'Obligations owed (payables, loans, taxes).', color:'#ffe3e3'},
    {key:'equity', icon:'fa-building-columns', title:'Equity', hint:"Owners’ capital, retained earnings.", color:'#e7f5ff'},
    {key:'expense', icon:'fa-receipt', title:'Expenses', hint:'Costs incurred (COGS, rent, utilities).', color:'#fff3bf'},
    {key:'income', icon:'fa-chart-line', title:'Income', hint:'Revenues (sales, interest income).', color:'#e6fcf5'}
  ];

  function tbBoxTemplate(g){
    return `<div class="tb-box-header" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <div style="width:30px;height:30px;border-radius:10px;background:${g.color};display:flex;align-items:center;justify-content:center;color:#1a4d2e;"><i class="fa ${g.icon}"></i></div>
              <div style="font-weight:700;color:#1a4d2e;">${g.title}</div>
            </div>
            <div class="tb-box-hint" style="font-size:12px;color:#1a4d2e;opacity:.75;margin:-2px 0 6px 0;">${g.hint}</div>
            <div class="tb-box-body" data-body style="display:flex;flex-wrap:wrap;gap:8px;min-height:56px;"></div>`
  }

  function renderTbBoxes(){
    TB_GROUPS.forEach(g => {
      const box = document.getElementById('tb-box-'+g.key);
      if (!box) return;
      box.style.border = '1px solid #e6e6e6';
      box.style.borderRadius = '12px';
      box.style.background = '#fff';
      box.style.padding = '10px';
      box.innerHTML = tbBoxTemplate(g);
    });
  }

  function createIcon(cat){
    const div = document.createElement('div');
    div.className = 'tb-icon';
    div.draggable = true;
    div.dataset.id = String(cat.id);
    div.dataset.name = cat.name || '';
    const bg = (window.folderColorMap && window.folderColorMap[cat.id]) ? window.folderColorMap[cat.id] : '#f7fff7';
    const iconClass = (function(){
      const el = document.querySelector(`.folder-item[data-id='${cat.id}'] .folder-icon i`);
      if (!el) return 'fa-folder';
      const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
      return cls[0] || 'fa-folder';
    })();
    // Icons in TB boxes use white icon on colored background
    div.style.cssText = `width:40px;height:40px;border-radius:12px;background:${bg};border:1px solid #d9f2d9;display:flex;align-items:center;justify-content:center;color:#FFFFFF;cursor:grab;`;
    div.innerHTML = `<i class="fa ${iconClass}"></i>`;
    attachDragHandlers(div);
    div.title = cat.name || '';
    return div;
  }

  function attachDragHandlers(el){
    el.addEventListener('dragstart', (e)=>{
      const id = el.dataset.id;
      e.dataTransfer.setData('text/plain', JSON.stringify({type:'cat', id}));
      el.classList.add('ghost');
    });
    el.addEventListener('dragend', ()=> el.classList.remove('ghost'));
  }

  function attachDropHandlers(zone){
    zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('drop-target'); });
    zone.addEventListener('dragleave', ()=> zone.classList.remove('drop-target'));
    zone.addEventListener('drop', async (e)=>{
      e.preventDefault(); zone.classList.remove('drop-target');
      let data; try{ data = JSON.parse(e.dataTransfer.getData('text/plain')); }catch(_){ return; }
      if (!data || data.type !== 'cat') return;
      const id = parseInt(data.id, 10);
      const target = zone.dataset.tbTarget;
      const tb_group = (target === 'unassigned') ? null : target;
      try{
        const res = await postJSON('/accounting/category/set_group', { category_id: id, tb_group });
        if (!res || res.ok !== true) return;
        // Move UI element: if dropped into a box body, show icon; if dropped to list, show full row
        moveCatUI(id, tb_group);
      }catch(err){ console.error(err); }
    });
  }

  function todayIso(){
    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${now.getFullYear()}-${month}-${day}`;
  }

  function formatDisplayDate(iso){
    if (!iso) return 'Not set';
    const parts = iso.split('-');
    if (parts.length !== 3) return iso;
    const y = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10) - 1;
    const d = parseInt(parts[2], 10);
    if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return iso;
    const dt = new Date(y, m, d);
    try {
      return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    } catch (_) {
      return iso;
    }
  }

  function ensureTbState(){
    if (!window.TB_STATE) {
      window.TB_STATE = { categoryGroups: {}, nameMap: {}, initialDate: null };
    }
    if (!window.TB_STATE.categoryGroups) {
      window.TB_STATE.categoryGroups = {};
    }
    if (!window.TB_STATE.nameMap) {
      window.TB_STATE.nameMap = {};
    }
    if (!window.TB_STATE.initialDate) {
      const fallback = (window.ACC_BOOT && window.ACC_BOOT.tbInitializedOn) || todayIso();
      window.TB_STATE.initialDate = fallback;
    }
    return window.TB_STATE;
  }

  function moveCatUI(catId, tb_group){
    // Find name BEFORE removing
    const rowSel = `.tb-folder[data-id='${catId}']`;
    const nameEl = document.querySelector(`${rowSel} [data-name]`);
    let name = (nameEl && nameEl.textContent ? nameEl.textContent.trim() : '')
            || ((window.ACC_BOOT && window.ACC_BOOT.categoryMap && window.ACC_BOOT.categoryMap[catId]) || '');
    // Remove any existing icon in boxes
    document.querySelectorAll(`.tb-icon[data-id='${catId}']`).forEach(n => n.remove());
    // Remove existing full row in list
    document.querySelectorAll(rowSel).forEach(n => n.remove());
    // Add to destination
    if (!tb_group){
      // Unassigned -> add back as a row in folder list
      const list = document.getElementById('tb-folder-list');
      if (!list) return;
      const row = document.createElement('div');
      row.className = 'tb-folder';
      row.draggable = true;
      row.dataset.id = String(catId);
      row.dataset.name = name;
      row.dataset.group = '';
      row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;margin:6px 4px;background:#f7fff7;border:1px solid #d9f2d9;cursor:grab;';
      const bg = (window.folderColorMap && window.folderColorMap[catId]) ? window.folderColorMap[catId] : '#e6f7e6';
      const iconClass = (function(){
        const el = document.querySelector(`.folder-item[data-id='${catId}'] .folder-icon i`);
        if (!el) return 'fa-folder';
        const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
        return cls[0] || 'fa-folder';
      })();
      row.innerHTML = `<div class="tb-folder-icon" style="width:28px;height:28px;border-radius:8px;background:${bg};display:flex;align-items:center;justify-content:center;color:#FFFFFF;"><i class="fa ${iconClass}"></i></div>
                       <div class="folder-name" data-name style="flex:1;">${name}</div>
                       <span class="badge muted" style="opacity:.6;">Unassigned</span>`;
      attachDragHandlers(row);
      list.appendChild(row);
      sortTbFolderListAlpha();
    } else {
      // Assigned -> add icon to box body
      const body = document.querySelector(`#tb-box-${tb_group} [data-body]`);
      if (!body) return;
      const icon = createIcon({id: catId, name});
      body.appendChild(icon);
    }
    const state = ensureTbState();
    state.categoryGroups[catId] = tb_group || null;
    if (name) state.nameMap[catId] = name;
  }

  function populateTbFromServer(){
    const state = ensureTbState();
    // Seed from unassigned rows currently rendered on the left
    const rows = Array.from(document.querySelectorAll('#tb-folder-list .tb-folder'));
    rows.forEach(r => {
      const id = parseInt(r.dataset.id, 10);
      const name = (r.dataset.name || '').trim();
      state.categoryGroups[id] = null;
      if (name) state.nameMap[id] = name;
    });
    // Render icons for pre-assigned categories from boot data
    const cats = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    cats.forEach(c => {
      const id = c.id; const nm = c.name || ''; const g = (c.tb_group || '').trim();
      if (nm) state.nameMap[id] = nm;
      if (g){
        state.categoryGroups[id] = g;
        const body = document.querySelector(`#tb-box-${g} [data-body]`);
        if (body){ body.appendChild(createIcon({id, name: nm})); }
      }
    });
    updateNextVisibility();
  }

  function updateNextVisibility(){
    const cats = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const map = (window.TB_STATE && window.TB_STATE.categoryGroups) || {};
    const allAssigned = cats.length > 0 && cats.every(c => (map[c.id] && map[c.id].length > 0));
    const btn = document.getElementById('tb-next-btn');
    if (btn) btn.style.display = allAssigned ? 'inline-flex' : 'none';
  }

  function initTrialBalanceUI(){
    const startBtn = document.getElementById('tb-start-btn');
    const prompt = document.getElementById('tb-init-prompt');
    const assigner = document.getElementById('tb-assigner');
    const setup = document.getElementById('tb-setup');
    const summary = document.getElementById('tb-summary');
    if (startBtn){
      startBtn.addEventListener('click', () => { if (prompt) prompt.style.display='none'; if (assigner) assigner.style.display='grid'; });
    }
    // Build boxes and attach DnD handlers
    renderTbBoxes();
    document.querySelectorAll('.dropzone').forEach(attachDropHandlers);
    // Existing rows & icons
    populateTbFromServer();
    updateNextVisibility();
    // Make rows draggable
    document.querySelectorAll('#tb-folder-list .tb-folder').forEach(el => attachDragHandlers(el));
    // Match icons in the left list to Folder tab icons/colors
    refreshTbFolderListIcons();
    // Next button toggles to setup step
    const nextBtn = document.getElementById('tb-next-btn');
    if (nextBtn){
      nextBtn.addEventListener('click', () => {
        const assigner = document.getElementById('tb-assigner');
        const setup = document.getElementById('tb-setup');
        if (assigner) assigner.style.display = 'none';
        if (setup) setup.style.display = 'grid';
        renderTrialSetup();
        updateCompleteVisibility();
        initInitializationDateUI();
        bindTrialCompleteButton();
      });
    }
    bindTrialCompleteButton();
    initInitializationDateUI();
    // Ensure user is prompted to initialize if not complete
    ensureTrialPromptState();
  }

  function refreshTbFolderListIcons(){
    const rows = document.querySelectorAll('#tb-folder-list .tb-folder');
    rows.forEach(r => {
      const id = parseInt(r.dataset.id, 10);
      const iconWrap = r.querySelector('.tb-folder-icon');
      if (!iconWrap) return;
      const bg = (window.folderColorMap && window.folderColorMap[id]) ? window.folderColorMap[id] : '#e6f7e6';
      iconWrap.style.background = bg;
      const ic = iconWrap.querySelector('i');
      if (!ic) return;
      const el = document.querySelector(`.folder-item[data-id='${id}'] .folder-icon i`);
      let iconClass = 'fa-folder';
      if (el){
        const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
        iconClass = cls[0] || iconClass;
      }
      ic.className = `fa ${iconClass}`;
    });
  }

  function renderTrialSetup(){
    const state = ensureTbState();
    // Left: categories list with icons of folders
    const list = document.getElementById('tb-cat-list');
    const title = document.getElementById('tb-cat-title');
    if (!list) return;
    list.innerHTML = '';
    list.scrollTop = 0;
    const cutoffDisplay = (() => {
      if (!state.initCutoff) return '';
      try {
        const dt = new Date(state.initCutoff);
        if (!Number.isNaN(dt.getTime())) {
          return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
      } catch (err) {}
      return state.initCutoff;
    })();
    list.scrollTop = 0;
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    // Build map group -> folder ids
    const groupMap = { asset:[], liability:[], equity:[], expense:[], income:[] };
    catsData.forEach(c => {
      const g = (window.TB_STATE && window.TB_STATE.categoryGroups && window.TB_STATE.categoryGroups[c.id]) || (c.tb_group || '');
      if (g && groupMap[g]) groupMap[g].push(c.id);
    });
    TB_GROUPS.forEach(g => {
      const item = document.createElement('div');
      item.className = 'tb-cat-item';
      item.style.cssText = 'padding:8px;border-radius:8px;margin:6px 4px;cursor:pointer;display:flex;align-items:center;gap:8px;';
      item.dataset.key = g.key;
      item.innerHTML = `<div style=\"width:28px;height:28px;border-radius:8px;background:${g.color};display:flex;align-items:center;justify-content:center;color:#1a4d2e;\"><i class=\"fa ${g.icon}\"></i></div>
                        <div style=\"flex:1;\">${g.title}</div>
                        <div class=\"tb-mini-icons\" style=\"display:flex;gap:4px;flex-wrap:wrap;\"></div>`;
      const mini = item.querySelector('.tb-mini-icons');
      (groupMap[g.key] || []).forEach(id => {
        const name = (window.ACC_BOOT && window.ACC_BOOT.categoryMap && window.ACC_BOOT.categoryMap[id]) || '';
        const m = document.createElement('div');
        const bg = (window.folderColorMap && window.folderColorMap[id]) ? window.folderColorMap[id] : '#f7fff7';
        const iconClass = (function(){
          const el = document.querySelector(`.folder-item[data-id='${id}'] .folder-icon i`);
          if (!el) return 'fa-folder';
          const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
          return cls[0] || 'fa-folder';
        })();
        m.title = name;
        m.style.cssText = `width:22px;height:22px;border-radius:6px;background:${bg};border:1px solid #d9f2d9;display:flex;align-items:center;justify-content:center;color:#FFFFFF;`;
        m.innerHTML = `<i class=\"fa ${iconClass}\" style=\"font-size:12px;\"></i>`;
        mini.appendChild(m);
      });
      item.addEventListener('click', () => {
        document.querySelectorAll('.tb-cat-item').forEach(el => el.style.background='');
        item.style.background = '#f8fff8';
        if (title) title.textContent = g.title;
        renderFolderAccounts(g.key);
      });
      list.appendChild(item);
    });
    initInitializationDateUI();
    bindTrialCompleteButton();
  }

  function renderFolderAccounts(groupKey){
    const box = document.getElementById('tb-folder-accounts');
    if (!box) return;
    box.innerHTML = '';
    const state = ensureTbState();
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const accsByCat = (window.ACC_BOOT && window.ACC_BOOT.accountsByCategory) || {};
    const balances = (window.ACC_BOOT && window.ACC_BOOT.openingBalances) || {};
    if (!window.ACC_BOOT.openingBalanceDates) window.ACC_BOOT.openingBalanceDates = {};
    const balanceDates = window.ACC_BOOT.openingBalanceDates;
    const initDate = state.initialDate || todayIso();
    const initDisplay = formatDisplayDate(initDate);
    const ids = catsData.filter(c => ((window.TB_STATE && window.TB_STATE.categoryGroups && window.TB_STATE.categoryGroups[c.id]) || (c.tb_group || '')) === groupKey).map(c => c.id);
    ids.forEach(cid => {
      const folderName = (window.ACC_BOOT.categoryMap && window.ACC_BOOT.categoryMap[cid]) || '';
      const header = document.createElement('div');
      header.className = 'tb-folder-head';
      header.style.cssText = 'padding:8px 6px;margin:6px 0;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px;cursor:pointer;';
      const bg = (window.folderColorMap && window.folderColorMap[cid]) ? window.folderColorMap[cid] : '#f7fff7';
      const iconClass = (function(){
        const el = document.querySelector(`.folder-item[data-id='${cid}'] .folder-icon i`);
        if (!el) return 'fa-folder';
        const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
        return cls[0] || 'fa-folder';
      })();
      header.innerHTML = `<div style=\"width:24px;height:24px;border-radius:6px;background:${bg};display:flex;align-items:center;justify-content:center;color:#FFFFFF;\"><i class=\"fa ${iconClass}\" style=\"font-size:12px;\"></i></div>
                          <div class=\"folder-name\" style=\"flex:1;">${folderName}</div>
                          <div class=\"tb-folder-status\" data-status></div>`;
      const content = document.createElement('div');
      content.style.cssText = 'padding:6px 8px 10px 32px;display:none;';
      const tip = document.createElement('div');
      tip.style.cssText = 'font-size:12px;color:#1a4d2e;opacity:.75;margin:4px 0 8px 0;';
      tip.textContent = initDate ? `Tip: Enter the balance as of ${initDisplay}.` : 'Tip: Enter the balance as of your initialization date.';
      content.appendChild(tip);
      const list = document.createElement('div');
      list.className = 'tb-acc-list';
      (accsByCat[cid] || []).forEach(a => {
        const row = document.createElement('div');
        row.className = 'tb-acc-row';
        row.style.cssText = 'display:flex;align-items:center;gap:8px;margin:4px 0;';
        row.dataset.id = a.id;
        const savedDate = balanceDates[a.id] || initDate;
        row.innerHTML = `<div style=\"flex:1;\">${a.name}</div>
                         <input type=\"number\" step=\"0.01\" value=\"${(balances[a.id] ?? '')}\" style=\"width:140px;\">
                         <span class=\"tb-acc-date\" style=\"font-size:11px;color:#1a4d2e;opacity:.65;\">${savedDate ? formatDisplayDate(savedDate) : ''}</span>
                         <button class=\"icon-btn\"><i class=\"fa fa-save\"></i> Save</button>
                         <span class=\"ok\" style=\"color:#2f9e44;display:${(balances[a.id] != null ? 'inline' : 'none')};\"><i class=\"fa fa-check\"></i></span>`;
        const btn = row.querySelector('button');
        const input = row.querySelector('input');
        const ok = row.querySelector('.ok');
        const dateText = row.querySelector('.tb-acc-date');
        btn.addEventListener('click', async ()=>{
          const amt = parseFloat(input.value || '0') || 0;
          const payload = { account_id: a.id, amount: amt };
          if (initDate) payload.as_of_date = initDate;
          try{
            const res = await postJSON('/accounting/tb/opening_balance', payload);
            if (res && res.ok){
              ok.style.display = 'inline';
              window.ACC_BOOT.openingBalances[a.id] = amt;
              if (initDate) {
                balanceDates[a.id] = initDate;
                if (dateText) dateText.textContent = formatDisplayDate(initDate);
              }
              checkFolderCompletion(content, cid);
              updateCompleteVisibility();
            }
          }catch(e){ console.error(e); }
        });
        list.appendChild(row);
      });
      content.appendChild(list);
      header.addEventListener('click', () => {
        const isOpen = content.style.display === 'block';
        content.style.display = isOpen ? 'none' : 'block';
      });
      box.appendChild(header);
      box.appendChild(content);
      // Mark complete if no accounts OR if all balances exist
      const accs = accsByCat[cid] || [];
      const allSaved = accs.length === 0 || accs.every(a => (a.id in balances));
      if (allSaved){ const st = header.querySelector('[data-status]'); if (st) st.innerHTML = '<i class="fa fa-check" style="color:#2f9e44;"></i>'; }
    });
    sortTbFolderListAlpha();
    updateCompleteVisibility();
  }

  function initInitializationDateUI(){
    const input = document.getElementById('tb-init-date');
    if (!input) return;
    const state = ensureTbState();
    const current = state.initialDate || todayIso();
    input.value = current;
    if (input.dataset.bound === '1') {
      return;
    }
    input.dataset.bound = '1';
    input.addEventListener('change', () => {
      const val = (input.value || '').trim();
      state.initialDate = val || todayIso();
      if (window.ACC_BOOT) {
        window.ACC_BOOT.tbInitializedOn = state.initialDate;
      }
      document.querySelectorAll('#tb-folder-accounts .tb-folder-head + div').forEach(content => {
        const tip = content && content.querySelector('div');
        if (tip) {
          tip.textContent = state.initialDate ? `Tip: Enter the balance as of ${formatDisplayDate(state.initialDate)}.` : 'Tip: Enter the balance as of your initialization date.';
        }
      });
      document.querySelectorAll('#tb-folder-accounts .tb-acc-date').forEach(span => {
        span.textContent = state.initialDate ? formatDisplayDate(state.initialDate) : '';
      });
      refreshSummaryInitializationDate();
    });
  }

  async function finalizeTrialSetup(){
    const state = ensureTbState();
    const initDate = state.initialDate || todayIso();
    try {
      const res = await fetch('/accounting/tb/initialize', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
        },
        body: JSON.stringify({ initialized_on: initDate })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        throw new Error((data && data.error) || 'Unable to lock initialization date.');
      }
      const savedDate = data.initialized_on || initDate;
      state.initialDate = savedDate;
      if (window.ACC_BOOT) {
        window.ACC_BOOT.tbInitializedOn = savedDate;
      }
      refreshSummaryInitializationDate();
      return true;
    } catch (err) {
      console.error(err);
      const msg = (err && err.message) ? err.message : 'Unable to save initialization date.';
      alert(msg);
      return false;
    }
  }

  function bindTrialCompleteButton(){
    const completeBtn = document.getElementById('tb-complete-btn');
    if (!completeBtn || completeBtn.dataset.bound === '1') return;
    completeBtn.dataset.bound = '1';
    completeBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const saved = await finalizeTrialSetup();
      if (!saved) return;
      try { localStorage.setItem('tbSetupCompleted', '1'); } catch (_) {}
      showTrialSummaryOnly();
    });
  }

  function refreshSummaryInitializationDate(){
    const span = document.getElementById('tb-summary-init-date');
    if (!span) return;
    const state = ensureTbState();
    const iso = state.initialDate || (window.ACC_BOOT && window.ACC_BOOT.tbInitializedOn) || '';
    span.textContent = iso ? formatDisplayDate(iso) : 'Not set';
  }

  function attachTrialResetHandler(){
    const btn = document.getElementById('tb-reset-btn');
    if (!btn || btn.dataset.bound === '1') return;
    btn.dataset.bound = '1';
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const confirmed = window.confirm('Reset the trial balance setup? This clears folders, opening balances, and initialization date.');
      if (!confirmed) return;
      btn.disabled = true;
      btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Resetting...';
      try {
        const res = await fetch('/accounting/tb/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
          },
          body: JSON.stringify({})
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error((data && data.error) || 'Reset failed');
        }
        try { localStorage.removeItem('tbSetupCompleted'); } catch (_) {}
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert('Unable to reset the trial balance. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fa fa-rotate-left"></i> Reset Trial Balance';
      }
    });
  }

  function sortTbFolderListAlpha(){
    const list = document.getElementById('tb-folder-list'); if (!list) return;
    const rows = Array.from(list.querySelectorAll('.tb-folder'));
    rows.sort((a,b) => {
      const an = (a.querySelector('.folder-name,[data-name]')?.textContent || '').trim().toLowerCase();
      const bn = (b.querySelector('.folder-name,[data-name]')?.textContent || '').trim().toLowerCase();
      if (an < bn) return -1; if (an > bn) return 1; return 0;
    });
    rows.forEach(r => list.appendChild(r));
  }

  function checkFolderCompletion(contentEl, catId){
    const rows = Array.from(contentEl.querySelectorAll('.tb-acc-row'));
    const done = rows.length > 0 && rows.every(r => (r.querySelector('.ok') && r.querySelector('.ok').style.display !== 'none'));
    if (done){
      // collapse and mark green tick
      contentEl.style.display = 'none';
      const st = contentEl.previousElementSibling && contentEl.previousElementSibling.querySelector('[data-status]');
      if (st) st.innerHTML = '<i class="fa fa-check" style="color:#2f9e44;"></i>';
    }
  }

  function updateCompleteVisibility(){
    const btn = document.getElementById('tb-complete-btn');
    if (!btn) return;
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const accsByCat = (window.ACC_BOOT && window.ACC_BOOT.accountsByCategory) || {};
    const balances = (window.ACC_BOOT && window.ACC_BOOT.openingBalances) || {};
    const assigned = catsData.filter(c => ((window.TB_STATE && window.TB_STATE.categoryGroups && window.TB_STATE.categoryGroups[c.id]) || (c.tb_group || '')));
    if (!assigned.length) { btn.style.display = 'none'; return; }
    let allDone = true;
    assigned.forEach(c => {
      const accs = accsByCat[c.id] || [];
      for (const a of accs){
        if (!(a.id in balances)) { allDone = false; return; }
      }
    });
    btn.style.display = allDone ? 'inline-flex' : 'none';
  }

  // Boot only when Trial tab is shown
  document.addEventListener('DOMContentLoaded', function(){
    initSummaryToggle();
    const storedView = localStorage.getItem('accountingView') || 'folders';
    if (storedView === 'receivables' && typeof window.initReceivableDebtUI === 'function') {
      window.initReceivableDebtUI();
    }
    if (storedView === 'trial') { 
      initTrialBalanceUI();
      ensureTrialPromptState();
      // If user previously completed setup, show summary by default
      try {
       
        if (localStorage.getItem('tbSetupCompleted') === '1') { showTrialSummaryOnly(); }
      } catch(_){}
    }

    // Also init when user clicks the tab
    const tbBtn = document.getElementById('btn-view-trial');
    if (tbBtn){ tbBtn.addEventListener('click', () => setTimeout(() => {
      initTrialBalanceUI();
      ensureTrialPromptState();
    }, 0)); }
  });
</script>
<script>
  // Summary rendering and Monthly filter wiring
  function showTrialSummaryOnly(){
    const prompt = document.getElementById('tb-init-prompt');
    const assigner = document.getElementById('tb-assigner');
    const setup = document.getElementById('tb-setup');
    const summary = document.getElementById('tb-summary');
    if (prompt) prompt.style.display = 'none';
    if (assigner) assigner.style.display = 'none';
    if (setup) setup.style.display = 'none';
    if (summary) {
      renderTrialSummary();
      initMonthlyTrialUI();
    }
    setSummaryReady(true);
  }

  function hasTrialInitialization(){
    return !!(window.ACC_BOOT && (window.ACC_BOOT.tbInitializedOn || window.ACC_BOOT.tbFirstMonth));
  }

  function isTrialSetupComplete(){
    if (hasTrialInitialization()) return true;
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const accsByCat = (window.ACC_BOOT && window.ACC_BOOT.accountsByCategory) || {};
    const balances = (window.ACC_BOOT && window.ACC_BOOT.openingBalances) || {};
    const assigned = catsData.filter(c => ((window.TB_STATE && window.TB_STATE.categoryGroups && window.TB_STATE.categoryGroups[c.id]) || (c.tb_group || '')));
    if (!assigned.length) return false;
    for (const c of assigned){
      const accs = accsByCat[c.id] || [];
      for (const a of accs) { if (!(a.id in balances)) return false; }
    }
    return true;
  }

  function ensureTrialPromptState(){
    // Determine whether to prompt for initialization or show summary
    const complete = isTrialSetupComplete();
    if (complete) { try { localStorage.setItem('tbSetupCompleted','1'); } catch(_){} showTrialSummaryOnly(); return; }
    // Not complete: prompt user. Decide which step to show.
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const map = (window.TB_STATE && window.TB_STATE.categoryGroups) || {};
    const allAssigned = (catsData.length > 0) && catsData.every(c => (map[c.id] && map[c.id].length > 0) || (c.tb_group && c.tb_group.length>0));
    const prompt = document.getElementById('tb-init-prompt');
    const assigner = document.getElementById('tb-assigner');
    const setup = document.getElementById('tb-setup');
    setSummaryReady(false);
    if (allAssigned){
      if (prompt) prompt.style.display = 'none';
      if (assigner) assigner.style.display = 'none';
      if (setup) {
        setup.style.display = 'grid';
        renderTrialSetup();
        updateCompleteVisibility();
        initInitializationDateUI();
        bindTrialCompleteButton();
      }
    } else {
      if (assigner) assigner.style.display = 'grid';
      if (setup) setup.style.display = 'none';
      if (prompt) prompt.style.display = 'block';
    }
  }
  function toNumeric(value){
    if (value === null || value === undefined || value === '') return 0;
    if (typeof value === 'number') {
      return Number.isFinite(value) ? value : 0;
    }
    if (typeof value === 'string') {
      const cleaned = value.replace(/[^0-9.\-]/g, '');
      const num = parseFloat(cleaned);
      return Number.isFinite(num) ? num : 0;
    }
    const coerced = Number(value);
    return Number.isFinite(coerced) ? coerced : 0;
  }

  function formatCurrency(n){
    const num = toNumeric(n);
    try { return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); } catch(_) { return String(num); }
  }

  function ensureCurrencyEntry(target, currency){
    const code = (currency || 'KRW').toUpperCase();
    if (!target.has(code)) {
      target.set(code, { bd: 0, balance: 0, period_debit: 0, period_credit: 0, period_net: 0 });
    }
    return target.get(code);
  }

  function aggregateAccountsByCurrency(accounts){
    const map = new Map();
    (accounts || []).forEach(acc => {
      if (!acc) return;
      const entry = ensureCurrencyEntry(map, acc.currency);
      entry.bd += toNumeric(acc.bd);
      entry.balance += toNumeric(acc.balance);
      entry.period_debit += toNumeric(acc.period_debit);
      entry.period_credit += toNumeric(acc.period_credit);
      entry.period_net += toNumeric(acc.period_net);
    });
    return map;
  }

  function mergeCurrencyMaps(target, source, weight = 1){
    if (!source) return target;
    if (!target) target = new Map();
    source.forEach((vals, currency) => {
      const entry = ensureCurrencyEntry(target, currency);
      entry.bd += weight * toNumeric(vals.bd);
      entry.balance += weight * toNumeric(vals.balance);
      entry.period_debit += weight * toNumeric(vals.period_debit);
      entry.period_credit += weight * toNumeric(vals.period_credit);
      entry.period_net += weight * toNumeric(vals.period_net);
    });
    return target;
  }

  function aggregateGroupCurrencyTotals(items){
    let result = new Map();
    (items || []).forEach(it => {
      const map = aggregateAccountsByCurrency(it && it.accounts);
      result = mergeCurrencyMaps(result, map);
    });
    return result;
  }

  function cloneCurrencyMap(source){
    if (!source) return new Map();
    const copy = new Map();
    source.forEach((vals, currency) => {
      copy.set((currency || 'KRW').toUpperCase(), {
        bd: toNumeric(vals.bd),
        balance: toNumeric(vals.balance),
        period_debit: toNumeric(vals.period_debit),
        period_credit: toNumeric(vals.period_credit),
        period_net: toNumeric(vals.period_net)
      });
    });
    return copy;
  }

  function formatCurrencyByMap(map, field, fallback){
    if (!map || map.size === 0){
      return formatCurrency(fallback || 0);
    }
    const parts = [];
    map.forEach((vals, currency) => {
      let amount = 0;
      if (field === 'period_net') {
        const netVal = (vals && vals.period_net != null) ? toNumeric(vals.period_net) : (toNumeric(vals.period_debit) - toNumeric(vals.period_credit));
        amount = netVal;
      } else {
        amount = toNumeric(vals[field]);
      }
      if (Math.abs(amount) < 0.0005) return;
      parts.push(`${currency} ${formatCurrency(amount)}`);
    });
    if (!parts.length){
      return formatCurrency(fallback || 0);
    }
    return parts.join(' • ');
  }

  function roundToTwo(n){
    const num = toNumeric(n);
    return Math.round(num * 100) / 100;
  }

  function formatAmountInput(n){
    return roundToTwo(n).toFixed(2);
  }

  function sanitizePaymentDatesInput(value){
    if (!value) return [];
    return value.split(/[\n,]+/).map(v => v.trim()).filter(Boolean);
  }

  function normalizeContactName(value){
    return (value || '').trim().toLowerCase();
  }

  function ensureReceivableState(){
    if (!window.RECEIVABLE_STATE){
      window.RECEIVABLE_STATE = {
        initialized: false,
        rows: [],
        savedRows: [],
        unsavedRows: [],
        contactGroups: [],
        rowsMap: new Map(),
        pending: new Map(),
        dirty: new Set(),
        currencies: [],
        filters: { type: 'all', currency: '' },
        loading: false,
        summary: { receivable: 0, debt: 0, saved: 0, unsaved: 0 },
        lastFilteredCount: 0,
        lastFilteredRange: { start: 0, end: 0, page: 1, pageCount: 1 },
        justSavedId: null,
        viewMode: 'saved',
        pageSize: 50,
        savedPage: 1,
        unsavedPage: 1,
        initCutoff: null,
        loanGroupCache: new Map(),
        loanGroupSuggestions: new Map(),
        loanGroupLoading: new Set(),
        contactViewMode: 'cards',
        contactSort: 'alpha'
      };
    }
    return window.RECEIVABLE_STATE;
  }

  const RECEIVABLE_FLOW_COMPAT = {
    'loan_provided': ['loan_repaid'],
    'loan_repaid': ['loan_provided'],
    'debt_received': ['debt_paid'],
    'debt_paid': ['debt_received']
  };
  const RECEIVABLE_BASE_FLOWS = new Set(['loan_provided', 'debt_received']);
  const RECEIVABLE_SETTLEMENT_FLOWS = new Set(['loan_repaid', 'debt_paid']);

  function getReceivableAccountList(kind){
    const boot = window.ACC_BOOT || {};
    const source = kind === 'debt' ? (boot.debtAccounts || []) : (boot.receivableAccounts || []);
    return source.slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  }

  function lookupAccountCurrency(accountId){
    if (!accountId) return null;
    const boot = window.ACC_BOOT || {};
    const pools = [
      ...(boot.receivableAccounts || []),
      ...(boot.debtAccounts || []),
      ...(boot.allAccounts || [])
    ];
    const targetId = Number(accountId);
    for (const acc of pools){
      if (Number(acc.id) === targetId){
        return (acc.currency_code || 'KRW').toUpperCase();
      }
    }
    return null;
  }

  function updateReceivableCreateAccountSelect(kind){
    const select = document.getElementById('rd-create-account');
    const submit = document.getElementById('rd-create-submit');
    if (!select) return;
    const previous = select.value;
    const options = getReceivableAccountList(kind);
    if (!options.length){
      select.innerHTML = '<option value=\"\">No eligible accounts found</option>';
      select.disabled = true;
      if (submit) submit.disabled = true;
      syncReceivableCreateCurrency();
      return;
    }
    let html = '<option value=\"\">Select account…</option>';
    options.forEach(acc => {
      html += `<option value=\"${acc.id}\">${escapeHtml(acc.name || 'Account')}</option>`;
    });
    select.innerHTML = html;
    select.disabled = false;
    if (submit) submit.disabled = false;
    const retained = previous && select.querySelector(`option[value='${previous}']`);
    select.value = retained ? previous : String(options[0].id);
    syncReceivableCreateCurrency();
  }

  function syncReceivableCreateCurrency(){
    const currencyInput = document.getElementById('rd-create-currency');
    const accountSelect = document.getElementById('rd-create-account');
    if (!currencyInput || !accountSelect) return;
    const accId = parseInt(accountSelect.value || '0', 10);
    const inferred = lookupAccountCurrency(accId);
    if (inferred) {
      currencyInput.value = inferred;
    } else if (!currencyInput.value) {
      currencyInput.value = 'KRW';
    }
  }

  function resetReceivableCreateForm(){
    const typeSelect = document.getElementById('rd-create-type');
    if (typeSelect) {
      typeSelect.value = typeSelect.value || 'receivable';
      updateReceivableCreateAccountSelect(typeSelect.value);
    } else {
      updateReceivableCreateAccountSelect('receivable');
    }
    const dateInput = document.getElementById('rd-create-date');
    if (dateInput) dateInput.value = todayIso();
    const amountInput = document.getElementById('rd-create-amount');
    if (amountInput) amountInput.value = '';
    const currencyInput = document.getElementById('rd-create-currency');
    if (currencyInput && !currencyInput.value){
      const acctSelect = document.getElementById('rd-create-account');
      const inferred = acctSelect ? lookupAccountCurrency(parseInt(acctSelect.value || '0', 10)) : null;
      currencyInput.value = inferred || 'KRW';
    }
    const descInput = document.getElementById('rd-create-description');
    if (descInput) descInput.value = '';
    const refInput = document.getElementById('rd-create-reference');
    if (refInput) refInput.value = '';
    const memoInput = document.getElementById('rd-create-memo');
    if (memoInput) memoInput.value = '';
    const contactInput = document.getElementById('rd-create-contact');
    if (contactInput) contactInput.value = '';
    const dueInput = document.getElementById('rd-create-due');
    if (dueInput) dueInput.value = '';
    const payments = document.getElementById('rd-create-payments');
    if (payments) payments.value = '';
    const notes = document.getElementById('rd-create-notes');
    if (notes) notes.value = '';
    const feedback = document.getElementById('rd-create-feedback');
    if (feedback){
      feedback.style.color = '#1a4d2e';
      feedback.textContent = '';
    }
  }

  function openReceivableCreateModal(){
    const modal = document.getElementById('rd-create-modal');
    if (!modal) return;
    resetReceivableCreateForm();
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    const dialog = modal.querySelector('.rd-modal-dialog');
    if (dialog){
      dialog.scrollTop = 0;
      try { dialog.focus(); } catch (_) {}
    }
  }

  function closeReceivableCreateModal(){
    const modal = document.getElementById('rd-create-modal');
    if (!modal) return;
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  }

  async function submitReceivableCreateForm(ev){
    ev.preventDefault();
    const typeSelect = document.getElementById('rd-create-type');
    const accountSelect = document.getElementById('rd-create-account');
    const currencyInput = document.getElementById('rd-create-currency');
    const amountInput = document.getElementById('rd-create-amount');
    const descInput = document.getElementById('rd-create-description');
    const dateInput = document.getElementById('rd-create-date');
    const feedback = document.getElementById('rd-create-feedback');
    const submitBtn = document.getElementById('rd-create-submit');
    if (!typeSelect || !accountSelect || !currencyInput || !amountInput || !descInput || !dateInput){
      return;
    }
    const direction = (typeSelect.value || 'receivable').toLowerCase();
    const accountId = parseInt(accountSelect.value || '0', 10);
    const amount = parseFloat(amountInput.value || '0');
    if (feedback){
      feedback.style.color = '#1a4d2e';
      feedback.textContent = 'Saving entry…';
    }
    if (submitBtn) submitBtn.disabled = true;
    try {
      const payload = {
        direction,
        account_id: accountId,
        amount,
        currency: (currencyInput.value || 'KRW').toUpperCase(),
        description: descInput.value || '',
        date: dateInput.value || '',
        reference: (document.getElementById('rd-create-reference')?.value || '').trim(),
        memo: (document.getElementById('rd-create-memo')?.value || '').trim(),
        contact_name: (document.getElementById('rd-create-contact')?.value || '').trim(),
        due_date: document.getElementById('rd-create-due')?.value || null,
        payment_dates: sanitizePaymentDatesInput(document.getElementById('rd-create-payments')?.value || ''),
        notes: (document.getElementById('rd-create-notes')?.value || '').trim(),
        transaction_value: amount
      };
      const res = await fetch('/accounting/receivables/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Unable to create entry.');
      }
      closeReceivableCreateModal();
      await loadReceivableData(data.row ? data.row.line_id : null);
    } catch (err){
      console.error(err);
      if (feedback){
        feedback.style.color = '#b22222';
        feedback.textContent = err && err.message ? err.message : 'Unable to create entry.';
      }
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  function setupReceivableCreateModal(){
    const form = document.getElementById('rd-create-form');
    if (!form || form.dataset.bound === 'true') return;
    form.dataset.bound = 'true';
    form.addEventListener('submit', submitReceivableCreateForm);
    const typeSelect = document.getElementById('rd-create-type');
    if (typeSelect){
      typeSelect.addEventListener('change', () => updateReceivableCreateAccountSelect(typeSelect.value));
    }
    const accountSelect = document.getElementById('rd-create-account');
    if (accountSelect){
      accountSelect.addEventListener('change', syncReceivableCreateCurrency);
    }
    const closeBtn = document.getElementById('rd-create-close');
    if (closeBtn) closeBtn.addEventListener('click', closeReceivableCreateModal);
    const cancelBtn = document.getElementById('rd-create-cancel');
    if (cancelBtn) cancelBtn.addEventListener('click', closeReceivableCreateModal);
    const modal = document.getElementById('rd-create-modal');
    if (modal){
      const backdrop = modal.querySelector('.rd-modal-backdrop');
      if (backdrop) backdrop.addEventListener('click', closeReceivableCreateModal);
    }
    updateReceivableCreateAccountSelect(typeSelect ? typeSelect.value : 'receivable');
    resetReceivableCreateForm();
  }

  function buildLinkLabel(summary){
    if (!summary) return '';
    const parts = [];
    if (summary.contact_name) parts.push(summary.contact_name);
    if (summary.currency) parts.push(summary.currency);
    if (summary.amount !== undefined && summary.amount !== null) parts.push(formatCurrency(summary.amount));
    if (summary.flow_label) parts.push(summary.flow_label);
    if (summary.date) parts.push(summary.date);
    return parts.filter(Boolean).join(' • ');
  }

  function buildReceivableLinkOptions(row){
    const state = ensureReceivableState();
    const compat = RECEIVABLE_FLOW_COMPAT[row.flow] || [];
    if (!compat.length) return [];
    const currentContact = (row.contact_name || '').trim().toLowerCase();
    const linkedIds = new Set((Array.isArray(row.linked_entries) ? row.linked_entries : []).map(le => le && le.line_id).filter(Boolean));
    const isBaseFlow = RECEIVABLE_BASE_FLOWS.has(row.flow);
    const options = [];
    state.rows.forEach(candidate => {
      if (!candidate || candidate.line_id === row.line_id) return;
      if (candidate.ignored) return;
      if (row.type !== candidate.type) return;
      if (!compat.includes(candidate.flow)) return;
      const candidateContact = (candidate.contact_name || '').trim().toLowerCase();
      if (currentContact && candidateContact && candidateContact !== currentContact) return;
      if (row.currency && candidate.currency && row.currency !== candidate.currency) return;
      if (isBaseFlow && linkedIds.has(candidate.line_id)) return;
      const info = {
        contact_name: candidate.contact_name,
        currency: candidate.currency,
        amount: candidate.amount,
        flow_label: candidate.flow_label,
        date: candidate.date_iso || candidate.entry_date
      };
      let label = buildLinkLabel(info);
      if (!label) {
        label = `Entry #${candidate.line_id}`;
      }
      const dateStr = candidate.date_iso || candidate.entry_date || '';
      const sortKey = dateStr ? Date.parse(dateStr) || 0 : 0;
      options.push({ id: candidate.line_id, label, sortKey });
    });
    options.sort((a, b) => {
      if (b.sortKey !== a.sortKey) return b.sortKey - a.sortKey;
      return a.label.localeCompare(b.label);
    });
    return options;
  }

  function loanDirectionFromRow(row){
    return (row && row.type === 'receivable') ? 'receivable' : 'payable';
  }

  function loanGroupCacheKey(row){
    const direction = loanDirectionFromRow(row);
    const currency = (row && row.currency ? row.currency : '').toUpperCase();
    const contact = normalizeContactName(row && row.contact_name);
    return `${direction}::${currency}::${contact}`;
  }

  function populateLoanThreadList(container, groups, defaultCurrency){
    if (!container) return;
    if (!Array.isArray(groups) || !groups.length){
      container.innerHTML = '<div class="rd-loan-thread-empty">No loan thread allocations yet.</div>';
      return;
    }
    const html = groups.map(lg => {
      const status = (lg.status || lg.summary?.status || '').toLowerCase();
      const statusLabel = (lg.status || lg.summary?.status || 'OPEN').toUpperCase();
      const currency = escapeHtml(lg.currency || defaultCurrency || 'KRW');
      const amount = formatCurrency(toNumeric(lg.linked_amount || 0));
      const remaining = lg.summary && lg.summary.remaining !== undefined
        ? `${currency} ${formatCurrency(toNumeric(lg.summary.remaining || 0))}`
        : '';
      const metaParts = [];
      if (remaining) metaParts.push(`Remaining ${remaining}`);
      if (lg.counterparty && lg.counterparty.trim()) metaParts.push(lg.counterparty);
      const statusClass = status === 'closed'
        ? 'rd-status-chip-paid'
        : (status === 'overpaid' ? 'rd-status-chip-overpaid' : 'rd-status-chip-open');
      return `<span class="rd-thread-chip" data-thread-id="${escapeHtml(lg.loan_group_id || lg.id || '')}">
                <span class="rd-thread-chip-main"><strong>${escapeHtml(lg.name || 'Loan thread')}</strong> • ${currency} ${amount}</span>
                <span class="rd-thread-chip-status rd-status-chip ${statusClass}">${escapeHtml(statusLabel)}</span>
                ${metaParts.length ? `<span class="rd-thread-chip-sub">${escapeHtml(metaParts.join(' • '))}</span>` : ''}
              </span>`;
    }).join('');
    container.innerHTML = html;
  }

  function populateLoanThreadSelect(select, row, options){
    if (!select) return;
    const seen = new Set();
    let html = '<option value="">Select thread…</option>';
    const appendOption = (id, label) => {
      if (!id || seen.has(id)) return;
      seen.add(id);
      html += `<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`;
    };
    (Array.isArray(row.loan_groups) ? row.loan_groups : []).forEach(lg => {
      const id = lg.loan_group_id || lg.id;
      const currency = lg.currency || row.currency || 'KRW';
      const amount = formatCurrency(toNumeric(lg.linked_amount || 0));
      const label = `${lg.name || 'Loan thread'} • ${currency} ${amount}`;
      appendOption(id, label);
    });
    (Array.isArray(options) ? options : []).forEach(group => {
      const currency = group.currency || row.currency || 'KRW';
      const remaining = group.summary && group.summary.remaining !== undefined
        ? formatCurrency(toNumeric(group.summary.remaining || 0))
        : null;
      const labelParts = [group.name || 'Loan thread', currency];
      if (remaining !== null) labelParts.push(`Remaining ${currency} ${remaining}`);
      appendOption(group.id, labelParts.join(' • '));
    });
    select.innerHTML = html;
  }

  async function fetchLoanGroupOptionsForRow(row){
    const state = ensureReceivableState();
    const key = loanGroupCacheKey(row);
    if (state.loanGroupCache.has(key)){
      return state.loanGroupCache.get(key);
    }
    if (state.loanGroupLoading.has(key)){
      return state.loanGroupCache.get(key) || [];
    }
    state.loanGroupLoading.add(key);
    try {
      const params = new URLSearchParams({ include_summary: 'true', status: 'open' });
      const direction = loanDirectionFromRow(row);
      if (direction) params.set('direction', direction);
      const currency = (row.currency || '').toUpperCase();
      if (currency) params.set('currency', currency);
      const contact = (row.contact_name || '').trim();
      if (contact) params.set('counterparty', contact);
      const res = await fetch(`/accounting/loan-groups?${params.toString()}`);
      const data = await res.json();
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Unable to load loan threads.');
      }
      const groups = Array.isArray(data.groups) ? data.groups : [];
      state.loanGroupCache.set(key, groups);
      return groups;
    } catch (err){
      state.loanGroupCache.delete(key);
      throw err;
    } finally {
      state.loanGroupLoading.delete(key);
    }
  }

  function invalidateLoanGroupCacheForRow(row){
    const state = ensureReceivableState();
    const key = loanGroupCacheKey(row);
    state.loanGroupCache.delete(key);
  }

  function setLoanThreadFeedback(feedbackEl, message, tone = 'info'){
    if (!feedbackEl) return;
    feedbackEl.textContent = message || '';
    feedbackEl.classList.remove('rd-error', 'rd-success');
    if (tone === 'error') feedbackEl.classList.add('rd-error');
    if (tone === 'success') feedbackEl.classList.add('rd-success');
  }

  function isReceivableOverdue(row){
    if (!row || !row.due_date) return false;
    let outstanding = true;
    if (Array.isArray(row.loan_groups) && row.loan_groups.length){
      outstanding = row.loan_groups.some(lg => {
        if (!lg) return false;
        const remaining = (lg.summary && lg.summary.remaining !== undefined)
          ? toNumeric(lg.summary.remaining)
          : toNumeric(lg.remaining);
        return Math.abs(remaining) > 0.005;
      });
    }
    if (!outstanding) return false;
    try {
      const due = new Date(row.due_date);
      if (Number.isNaN(due.getTime())) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      due.setHours(0,0,0,0);
      return due < today;
    } catch (_) {
      return false;
    }
  }

  function getEffectiveReceivableRow(baseRow){
    const state = ensureReceivableState();
    const pending = state.pending.get(baseRow.line_id);
    let row = { ...baseRow };
    if (pending){
      row = {
        ...row,
        contact_name: pending.contact_name,
        transaction_value: pending.transaction_value,
        due_date: pending.due_date || '',
        payment_dates: pending.payment_dates
      };
    }
    if (!Array.isArray(row.payment_dates)) {
      row.payment_dates = Array.isArray(baseRow.payment_dates) ? baseRow.payment_dates : [];
    }
    return row;
  }

  function getFilteredReceivableRows(state){
    const source = state.viewMode === 'saved' ? state.savedRows : state.unsavedRows;
    return source.filter(baseRow => {
      if (state.filters.type !== 'all' && baseRow.type !== state.filters.type) return false;
      if (state.filters.currency && baseRow.currency !== state.filters.currency) return false;
      return true;
    });
  }

  function populateReceivableCurrencyFilter(){
    const state = ensureReceivableState();
    const select = document.getElementById('rd-currency-filter');
    if (!select) return;
    const current = state.filters.currency || '';
    const unique = new Set((state.currencies || []).map(ccy => (ccy || '').toUpperCase()).filter(Boolean));
    let html = '<option value="">All</option>';
    unique.forEach(ccy => {
      html += `<option value="${ccy}">${ccy}</option>`;
    });
    if (current && !unique.has(current)) {
      html += `<option value="${current}">${current}</option>`;
    }
    select.innerHTML = html;
    select.value = current;
  }

  function refreshReceivableSummary(summaryOverride){
    const state = ensureReceivableState();
    if (summaryOverride) {
      state.summary = summaryOverride;
    }
    const el = document.getElementById('rd-summary');
    if (!el) return;
    if (!state.rows.length){
      el.innerHTML = '';
      return;
    }
    const totals = state.summary || { receivable: 0, debt: 0, saved: 0, unsaved: 0 };
    const filteredCount = state.lastFilteredCount || 0;
    const savedCount = totals.saved != null ? totals.saved : state.savedRows.length;
    const unsavedCount = totals.unsaved != null ? totals.unsaved : state.unsavedRows.length;
    const range = state.lastFilteredRange || { start: 0, end: 0, page: 1, pageCount: 1 };
    const cutoffDisplay = (() => {
      if (!state.initCutoff) return '';
      try {
        const dt = new Date(state.initCutoff);
        if (!Number.isNaN(dt.getTime())) {
          return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
      } catch (err) {}
      return state.initCutoff;
    })();
    const displayedText = filteredCount ? `${range.start}-${range.end} of ${filteredCount}` : '0';
    const pageText = filteredCount ? `Page ${range.page} of ${range.pageCount}` : '';
    const cutoffNote = cutoffDisplay ? ` (since ${cutoffDisplay})` : '';
    const parts = [
      `<span><strong>Receivable entries:</strong> ${totals.receivable || 0}</span>`,
      `<span><strong>Short-term debt entries:</strong> ${totals.debt || 0}</span>`,
      `<span><strong>Saved:</strong> ${savedCount}</span>`,
      `<span><strong>Needs info:</strong> ${unsavedCount}</span>`,
      `<span><strong>Displayed:</strong> ${displayedText}${pageText ? ' (' + pageText + ')' : ''}${cutoffNote}</span>`
    ];
    el.innerHTML = parts.join(' • ');
  }

  function renderReceivablePagination(total, page, pageCount, start, end){
    const state = ensureReceivableState();
    const container = document.getElementById('rd-pagination');
    if (!container) return;
    if (!total){
      container.innerHTML = '';
      return;
    }
    if (pageCount <= 1 && total <= (state.pageSize || 50)){
      container.innerHTML = '';
      return;
    }
    const disablePrev = page <= 1;
    const disableNext = page >= pageCount;
    const pageInfo = `Showing ${start}-${end} of ${total}`;
    container.innerHTML = `
      <button type="button" class="icon-btn rd-page-btn" id="rd-page-prev" ${disablePrev ? 'disabled' : ''}><i class="fa fa-chevron-left"></i> Prev</button>
      <span class="rd-page-info">${pageInfo}</span>
      <button type="button" class="icon-btn rd-page-btn" id="rd-page-next" ${disableNext ? 'disabled' : ''}>Next <i class="fa fa-chevron-right"></i></button>`;
    const prevBtn = document.getElementById('rd-page-prev');
    const nextBtn = document.getElementById('rd-page-next');
    if (prevBtn && !prevBtn.disabled){
      prevBtn.addEventListener('click', () => changeReceivablePage(-1));
    }
    if (nextBtn && !nextBtn.disabled){
      nextBtn.addEventListener('click', () => changeReceivablePage(1));
    }
  }

  function changeReceivablePage(delta){
    const state = ensureReceivableState();
    const modeSaved = state.viewMode === 'saved';
    const current = modeSaved ? state.savedPage : state.unsavedPage;
    const totalPages = state.lastFilteredRange ? (state.lastFilteredRange.pageCount || 1) : 1;
    const next = Math.min(Math.max(current + delta, 1), Math.max(totalPages, 1));
    if (modeSaved) state.savedPage = next; else state.unsavedPage = next;
    renderReceivableTable();
  }

  function updateReceivableTabButtons(){
    const state = ensureReceivableState();
    const savedBtn = document.getElementById('rd-tab-saved');
    const unsavedBtn = document.getElementById('rd-tab-unsaved');
    const savedCountEl = document.getElementById('rd-count-saved');
    const unsavedCountEl = document.getElementById('rd-count-unsaved');
    if (savedBtn){
      savedBtn.classList.toggle('active', state.viewMode === 'saved');
      if (savedCountEl) savedCountEl.textContent = `${state.savedRows.length}`;
    }
    if (unsavedBtn){
      unsavedBtn.classList.toggle('active', state.viewMode === 'unsaved');
      if (unsavedCountEl) unsavedCountEl.textContent = `${state.unsavedRows.length}`;
    }
  }

  function contactReceivableNet(group){
    if (!group || !group.flow_totals) return 0;
    return toNumeric(group.flow_totals.loan_provided) - toNumeric(group.flow_totals.loan_repaid);
  }

  function contactDebtNet(group){
    if (!group || !group.flow_totals) return 0;
    return toNumeric(group.flow_totals.debt_received) - toNumeric(group.flow_totals.debt_paid);
  }

  function summarizeContactCurrencies(group, key){
    const items = [];
    (group && group.currencies ? group.currencies : []).forEach(cur => {
      const val = key === 'receivable' ? toNumeric(cur.receivable_net) : toNumeric(cur.debt_net);
      if (Math.abs(val) > 0.005){
        items.push(`${escapeHtml(cur.currency || 'KRW')} ${formatCurrency(val)}`);
      }
    });
    return items.length ? items.join(' • ') : '—';
  }

  function sortContactGroups(groups, sortKey){
    const copy = (groups || []).slice();
    copy.sort((a, b) => {
      if (sortKey === 'receivable'){
        const diff = Math.abs(contactReceivableNet(b)) - Math.abs(contactReceivableNet(a));
        if (Math.abs(diff) > 0.0005) return diff;
      } else if (sortKey === 'debt'){
        const diff = Math.abs(contactDebtNet(b)) - Math.abs(contactDebtNet(a));
        if (Math.abs(diff) > 0.0005) return diff;
      }
      const nameA = (a && a.contact_name ? a.contact_name : '').toLowerCase();
      const nameB = (b && b.contact_name ? b.contact_name : '').toLowerCase();
      return nameA.localeCompare(nameB);
    });
    return copy;
  }

  function updateContactViewControls(){
    const state = ensureReceivableState();
    const cardsBtn = document.getElementById('rd-contact-view-cards');
    const listBtn = document.getElementById('rd-contact-view-list');
    const sortSelect = document.getElementById('rd-group-sort-select');
    if (cardsBtn) cardsBtn.classList.toggle('active', state.contactViewMode === 'cards');
    if (listBtn) listBtn.classList.toggle('active', state.contactViewMode === 'list');
    if (sortSelect) sortSelect.value = state.contactSort || 'alpha';
  }

  function renderReceivableContactList(groups, container){
    const list = document.createElement('div');
    list.className = 'rd-group-list';
    const header = document.createElement('div');
    header.className = 'rd-group-row rd-group-row-head';
    header.innerHTML = '<div>Contact</div><div>Status</div><div>Receivable</div><div>Payable</div><div>Open items</div>';
    list.appendChild(header);
    groups.forEach(group => {
      const row = document.createElement('div');
      row.className = 'rd-group-row';
      const contactName = group.contact_name || 'Contact';
      const status = (group.status || 'OPEN').toUpperCase();
      const statusClass = status === 'PAID' ? 'rd-status-chip-paid' : 'rd-status-chip-open';
      const receivableText = summarizeContactCurrencies(group, 'receivable');
      const debtText = summarizeContactCurrencies(group, 'debt');
      row.innerHTML = `
        <div class="rd-group-cell rd-group-cell-name"><strong>${escapeHtml(contactName)}</strong></div>
        <div class="rd-group-cell rd-group-cell-status"><span class="rd-status-chip ${statusClass}">${escapeHtml(status)}</span></div>
        <div class="rd-group-cell rd-group-cell-money">${receivableText}</div>
        <div class="rd-group-cell rd-group-cell-money">${debtText}</div>
        <div class="rd-group-cell rd-group-cell-open">${group.open_items || 0}</div>
      `;
      const contactKey = group.key || normalizeContactName(group.contact_name);
      row.dataset.contactKey = contactKey || '';
      row.tabIndex = 0;
      const openModal = () => openReceivableContactModal(contactKey || group.contact_name || '');
      row.addEventListener('click', openModal);
      row.addEventListener('keydown', ev => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          openModal();
        }
      });
      list.appendChild(row);
    });
    container.appendChild(list);
  }

  function renderReceivableContactGroups(){
    const state = ensureReceivableState();
    const container = document.getElementById('rd-groups');
    const titleEl = document.getElementById('rd-groups-title');
    const controls = document.getElementById('rd-group-controls');
    if (!container) return;
    container.innerHTML = '';
    if (titleEl){
      titleEl.style.display = state.savedRows.length ? 'block' : 'none';
    }
    if (controls){
      controls.style.display = state.savedRows.length ? 'flex' : 'none';
    }
    updateContactViewControls();
    if (!state.savedRows.length){
      container.innerHTML = '<div class="rd-groups-empty">Add a contact name and save to start tracking balances by person.</div>';
      return;
    }
    if (!state.contactGroups.length){
      container.innerHTML = '<div class="rd-groups-empty">Saved entries will appear here grouped by contact once data is available.</div>';
      return;
    }
    const sortedGroups = sortContactGroups(state.contactGroups, state.contactSort);
    if (state.contactViewMode === 'list'){
      renderReceivableContactList(sortedGroups, container);
      return;
    }
    sortedGroups.forEach(group => {
      const card = document.createElement('div');
      card.className = 'rd-group-card';
      const statusClass = group.status === 'PAID' ? 'rd-status-chip-paid' : 'rd-status-chip-open';
      const header = document.createElement('div');
      header.className = 'rd-group-header';
      header.innerHTML = `<div class="rd-group-name"><i class="fa fa-user"></i> ${escapeHtml(group.contact_name || 'Contact')}</div>
                          <div class="rd-status-chip ${statusClass}">${group.status || 'OPEN'}</div>`;
      card.appendChild(header);
      const meta = document.createElement('div');
      meta.className = 'rd-group-meta';
      const openLabel = group.open_items ? `${group.open_items} open` : 'All paid';
      meta.textContent = `${group.entries || 0} entr${group.entries === 1 ? 'y' : 'ies'} • ${openLabel}`;
      card.appendChild(meta);

      const list = document.createElement('div');
      list.className = 'rd-group-currencies';
      (group.currencies || []).forEach(cur => {
        const currencyLabel = escapeHtml(cur.currency || 'KRW');
        const receivableParts = [];
        if (Math.abs(cur.receivable_origin || 0) > 0.005) receivableParts.push(`Origin ${formatCurrency(cur.receivable_origin || 0)}`);
        if (Math.abs(cur.receivable_settlement || 0) > 0.005) receivableParts.push(`Collected ${formatCurrency(cur.receivable_settlement || 0)}`);
        if (Math.abs(cur.receivable_net || 0) > 0.005) receivableParts.push(`Net ${formatCurrency(cur.receivable_net || 0)}`);
        if (receivableParts.length){
          const line = document.createElement('div');
          line.className = 'rd-group-line';
          line.innerHTML = `<strong>${currencyLabel}</strong> • Receivable ${receivableParts.join(' • ')}`;
          list.appendChild(line);
        }
        const debtParts = [];
        if (Math.abs(cur.debt_origin || 0) > 0.005) debtParts.push(`Origin ${formatCurrency(cur.debt_origin || 0)}`);
        if (Math.abs(cur.debt_settlement || 0) > 0.005) debtParts.push(`Repaid ${formatCurrency(cur.debt_settlement || 0)}`);
        if (Math.abs(cur.debt_net || 0) > 0.005) debtParts.push(`Net ${formatCurrency(cur.debt_net || 0)}`);
        if (debtParts.length){
          const debtLine = document.createElement('div');
          debtLine.className = 'rd-group-line';
          debtLine.innerHTML = `<strong>${currencyLabel}</strong> • Debt ${debtParts.join(' • ')}`;
          list.appendChild(debtLine);
        }
        const flows = cur.flows || {};
        const flowParts = [];
        if (flows.loan_provided && Math.abs(flows.loan_provided) > 0.0005) flowParts.push(`Loaned ${formatCurrency(flows.loan_provided)}`);
        if (flows.loan_repaid && Math.abs(flows.loan_repaid) > 0.0005) flowParts.push(`Collected ${formatCurrency(flows.loan_repaid)}`);
        if (flows.debt_received && Math.abs(flows.debt_received) > 0.0005) flowParts.push(`Borrowed ${formatCurrency(flows.debt_received)}`);
        if (flows.debt_paid && Math.abs(flows.debt_paid) > 0.0005) flowParts.push(`Repaid ${formatCurrency(flows.debt_paid)}`);
        if (flowParts.length){
          const flowLine = document.createElement('div');
          flowLine.className = 'rd-group-subline';
          flowLine.textContent = flowParts.join(' • ');
          list.appendChild(flowLine);
        }
      });
      card.appendChild(list);
      const contactKey = group.key || normalizeContactName(group.contact_name);
      card.dataset.contactKey = contactKey || '';
      card.setAttribute('tabindex', '0');
      card.addEventListener('click', () => openReceivableContactModal(contactKey || group.contact_name || ''));
      card.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          openReceivableContactModal(contactKey || group.contact_name || '');
        }
      });
      container.appendChild(card);
    });
  }

  function ensureReceivableContactModal(){
    if (window.RECEIVABLE_CONTACT_MODAL) return window.RECEIVABLE_CONTACT_MODAL;
    let modal = document.getElementById('rd-contact-modal');
    if (!modal){
      modal = document.createElement('div');
      modal.id = 'rd-contact-modal';
      modal.className = 'rd-modal';
      modal.setAttribute('aria-hidden', 'true');
      modal.innerHTML = `
        <div class="rd-modal-backdrop"></div>
        <div class="rd-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="rd-modal-title" tabindex="-1">
          <div class="rd-modal-header">
            <h3 id="rd-modal-title">Contact Overview</h3>
            <div class="rd-modal-header-right">
              <button type="button" class="rd-modal-download" data-format="png" title="Download PNG"><i class="fa fa-download"></i> PNG</button>
              <button type="button" class="rd-modal-close" aria-label="Close dialog"><i class="fa fa-xmark"></i></button>
            </div>
          </div>
          <div class="rd-modal-summary"></div>
          <div class="rd-modal-controls">
            <label><input type="checkbox" id="rd-modal-toggle-origin" checked> Show origin</label>
            <label><input type="checkbox" id="rd-modal-toggle-settlement" checked> Show payments</label>
          </div>
          <div class="rd-modal-section" data-section="origin">
            <h4><i class="fa fa-hand-holding-dollar"></i> Debt Created &amp; Loan Provided</h4>
            <div class="rd-modal-list" id="rd-modal-origin"></div>
          </div>
          <div class="rd-modal-section" data-section="settlement">
            <h4><i class="fa fa-credit-card"></i> Debt Repaid &amp; Loan Repaid</h4>
            <div class="rd-modal-list" id="rd-modal-settlement"></div>
          </div>
          <div class="rd-modal-section" data-section="threads">
            <h4><i class="fa fa-diagram-project"></i> Loan Threads</h4>
            <div class="rd-modal-group-create">
              <button type="button" class="icon-btn rd-modal-group-toggle"><i class="fa fa-plus"></i> New Loan Thread</button>
              <form class="rd-modal-group-form" style="display:none;">
                <div class="rd-group-form-grid">
                  <label>
                    <span>Name</span>
                    <input type="text" name="name" class="rd-input" required>
                  </label>
                  <label>
                    <span>Direction</span>
                    <select name="direction" class="rd-input">
                      <option value="receivable">Receivable</option>
                      <option value="payable">Payable</option>
                    </select>
                  </label>
                  <label>
                    <span>Currency</span>
                    <input type="text" name="currency" class="rd-input" maxlength="6" placeholder="KRW">
                  </label>
                  <label>
                    <span>Principal</span>
                    <input type="number" step="0.01" min="0.01" name="principal" class="rd-input" required>
                  </label>
                  <label>
                    <span>Start date</span>
                    <input type="date" name="start_date" class="rd-input">
                  </label>
                </div>
                <div class="rd-group-form-actions">
                  <button type="submit" class="icon-btn rd-modal-group-save"><i class="fa fa-floppy-disk"></i> Save</button>
                  <button type="button" class="icon-btn rd-modal-group-cancel"><i class="fa fa-xmark"></i> Cancel</button>
                </div>
                <div class="rd-modal-group-feedback"></div>
              </form>
            </div>
            <div class="rd-modal-groups" id="rd-modal-groups"></div>
          </div>
          <div class="rd-modal-footer">
            <button type="button" class="rd-modal-dismiss"><i class="fa fa-check"></i> Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }
    const modalState = {
      modal,
      dialog: modal.querySelector('.rd-modal-dialog'),
      summary: modal.querySelector('.rd-modal-summary'),
      title: modal.querySelector('#rd-modal-title'),
      originList: modal.querySelector('#rd-modal-origin'),
      settlementList: modal.querySelector('#rd-modal-settlement'),
      toggleOrigin: modal.querySelector('#rd-modal-toggle-origin'),
      toggleSettlement: modal.querySelector('#rd-modal-toggle-settlement'),
      downloadButtons: Array.from(modal.querySelectorAll('.rd-modal-download')),
      originSection: modal.querySelector('[data-section="origin"]'),
      settlementSection: modal.querySelector('[data-section="settlement"]'),
      groupsSection: modal.querySelector('[data-section="threads"]'),
      groupsList: modal.querySelector('#rd-modal-groups'),
      groupToggle: modal.querySelector('.rd-modal-group-toggle'),
      groupForm: modal.querySelector('.rd-modal-group-form'),
      groupFormName: modal.querySelector('.rd-modal-group-form input[name="name"]'),
      groupFormDirection: modal.querySelector('.rd-modal-group-form select[name="direction"]'),
      groupFormCurrency: modal.querySelector('.rd-modal-group-form input[name="currency"]'),
      groupFormPrincipal: modal.querySelector('.rd-modal-group-form input[name="principal"]'),
      groupFormStart: modal.querySelector('.rd-modal-group-form input[name="start_date"]'),
      groupFeedback: modal.querySelector('.rd-modal-group-feedback'),
      groupCache: new Map(),
      activeContact: null,
      lastCurrency: null,
      groupListenersBound: false,
      groupFormMode: 'create',
      editingGroupId: null,
      lastActive: null
    };
    const closeBtn = modal.querySelector('.rd-modal-close');
    const backdrop = modal.querySelector('.rd-modal-backdrop');
    const dismissBtn = modal.querySelector('.rd-modal-dismiss');
    const close = () => closeReceivableContactModal();
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (dismissBtn) dismissBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);
    if (modalState.toggleOrigin) modalState.toggleOrigin.addEventListener('change', toggleReceivableModalSections);
    if (modalState.toggleSettlement) modalState.toggleSettlement.addEventListener('change', toggleReceivableModalSections);
    if (modalState.downloadButtons.length){
      modalState.downloadButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          downloadContactOverview();
        });
      });
    }
    if (modalState.groupToggle && modalState.groupForm && !modalState.groupListenersBound){
      modalState.groupToggle.addEventListener('click', () => toggleLoanGroupForm(modalState, true));
      const cancelBtn = modalState.groupForm.querySelector('.rd-modal-group-cancel');
      if (cancelBtn){
        cancelBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          toggleLoanGroupForm(modalState, false);
        });
      }
      modalState.groupForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (!modalState.activeContact){
          if (modalState.groupFeedback){
            modalState.groupFeedback.style.color = '#b22222';
            modalState.groupFeedback.textContent = 'Open a contact overview first.';
          }
          return;
        }
        const name = modalState.groupFormName ? modalState.groupFormName.value.trim() : '';
        const directionRaw = modalState.groupFormDirection ? modalState.groupFormDirection.value : 'receivable';
        const direction = (directionRaw || '').toLowerCase() === 'payable' ? 'payable' : 'receivable';
        const currency = modalState.groupFormCurrency ? (modalState.groupFormCurrency.value || 'KRW').toUpperCase() : 'KRW';
        const principalVal = modalState.groupFormPrincipal ? parseFloat(modalState.groupFormPrincipal.value || '0') : 0;
        const startDate = modalState.groupFormStart ? (modalState.groupFormStart.value || '') : '';
        if (!name){
          if (modalState.groupFeedback){
            modalState.groupFeedback.style.color = '#b22222';
            modalState.groupFeedback.textContent = 'Name is required.';
          }
          return;
        }
        if (Number.isNaN(principalVal) || principalVal <= 0){
          if (modalState.groupFeedback){
            modalState.groupFeedback.style.color = '#b22222';
            modalState.groupFeedback.textContent = 'Principal must be greater than zero.';
          }
          return;
        }
        const payload = {
          name,
          direction,
          currency,
          principal_amount: principalVal,
          start_date: startDate || new Date().toISOString().slice(0, 10),
          counterparty: modalState.activeContact
        };
        modalState.lastDirection = direction;
        modalState.lastCurrency = currency;
        if (modalState.groupFeedback){
          modalState.groupFeedback.style.color = '#1a4d2e';
          const verb = modalState.groupFormMode === 'edit' && modalState.editingGroupId ? 'Updating…' : 'Saving…';
          modalState.groupFeedback.textContent = verb;
        }
        try {
          const state = ensureReceivableState();
          state.loanGroupCache.clear();
          state.loanGroupSuggestions.clear();
          if (modalState.groupFormMode === 'edit' && modalState.editingGroupId){
            const csrf = (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '';
            const res = await fetch(`/accounting/loan-groups/${encodeURIComponent(modalState.editingGroupId)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf },
              body: JSON.stringify(payload)
            });
            const respData = await res.json().catch(() => ({}));
            if (!res.ok || respData.ok === false){
              throw new Error((respData && respData.error) || 'Unable to update loan thread.');
            }
          } else {
            const resp = await postJSON('/accounting/loan-groups', payload);
            if (!resp || resp.ok === false){
              throw new Error((resp && resp.error) || 'Unable to save loan thread.');
            }
          }
          if (modalState.groupCache) modalState.groupCache.clear();
          toggleLoanGroupForm(modalState, false);
          resetLoanGroupForm(modalState);
          loadContactLoanGroups(modalState, modalState.activeContact, modalState.lastDirection, modalState.lastCurrency);
          await loadReceivableData();
          if (modalState.groupFeedback){
            modalState.groupFeedback.style.color = '#1a4d2e';
            modalState.groupFeedback.textContent = modalState.groupFormMode === 'edit' ? 'Loan thread updated.' : 'Loan thread saved.';
          }
        } catch (err){
          console.error(err);
          if (modalState.groupFeedback){
            modalState.groupFeedback.style.color = '#b22222';
            modalState.groupFeedback.textContent = err && err.message ? err.message : 'Unable to save loan thread.';
          }
        }
      });
      modalState.groupListenersBound = true;
    }
    document.addEventListener('keydown', (evt) => {
      if (evt.key === 'Escape' && modal.classList.contains('open')) {
        closeReceivableContactModal();
      }
    });
    window.RECEIVABLE_CONTACT_MODAL = modalState;
    return modalState;
  }

  function toggleReceivableModalSections(){
    const modalState = ensureReceivableContactModal();
    if (!modalState) return;
    if (modalState.originSection){
      modalState.originSection.style.display = modalState.toggleOrigin && !modalState.toggleOrigin.checked ? 'none' : '';
    }
    if (modalState.settlementSection){
      modalState.settlementSection.style.display = modalState.toggleSettlement && !modalState.toggleSettlement.checked ? 'none' : '';
    }
  }

  function closeReceivableContactModal(){
    const existing = document.getElementById('rd-contact-modal');
    if (!existing) return;
    const modalState = ensureReceivableContactModal();
    if (!modalState) return;
    modalState.modal.classList.remove('open');
    modalState.modal.setAttribute('aria-hidden', 'true');
    if (modalState.lastActive && typeof modalState.lastActive.focus === 'function'){
      try { modalState.lastActive.focus(); } catch (_) {}
    }
    modalState.lastActive = null;
    modalState.currentReport = null;
    modalState.activeContact = null;
    modalState.lastCurrency = null;
    if (modalState.groupCache && typeof modalState.groupCache.clear === 'function'){
      modalState.groupCache.clear();
    }
    if (modalState.groupsList){
      modalState.groupsList.innerHTML = '';
    }
    toggleLoanGroupForm(modalState, false);
  }

  function buildCurrencyMapFromGroup(group, key){
    const totals = new Map();
    if (!group || !Array.isArray(group.currencies)) return totals;
    group.currencies.forEach(cur => {
      const currency = (cur.currency || 'KRW').toUpperCase();
      const amount = toNumeric(cur[key]);
      if (!Number.isFinite(amount) || Math.abs(amount) < 0.0005) return;
      totals.set(currency, (totals.get(currency) || 0) + amount);
    });
    return totals;
  }

  function accumulateCurrency(totalMap, currency, amount){
    if (!Number.isFinite(amount) || Math.abs(amount) < 0.0005) return;
    const key = (currency || 'KRW').toUpperCase();
    totalMap.set(key, (totalMap.get(key) || 0) + amount);
  }

  function addCurrencyMaps(mapA, mapB){
    const result = new Map(mapA);
    mapB.forEach((val, key) => {
      result.set(key, (result.get(key) || 0) + val);
    });
    return result;
  }

  function subtractCurrencyMaps(mapA, mapB){
    const result = new Map(mapA);
    mapB.forEach((val, key) => {
      result.set(key, (result.get(key) || 0) - val);
    });
    return result;
  }

  function buildSummaryLines(totals){
    if (!totals || totals.size === 0){
      return { primary: '—', breakdown: [] };
    }
    const sorted = Array.from(totals.entries()).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
    const [first, ...rest] = sorted;
    return {
      primary: `${first[0]} ${formatCurrency(first[1])}`,
      breakdown: rest.map(([ccy, val]) => `${ccy} ${formatCurrency(val)}`)
    };
  }

  function renderSummaryCard(icon, title, metric, subtitle){
    const primaryClass = metric.primary === '—' ? 'rd-modal-summary-metric rd-metric-empty' : 'rd-modal-summary-metric';
    const breakdownHtml = metric.breakdown && metric.breakdown.length
      ? `<div class="rd-modal-summary-breakdown">${metric.breakdown.map(line => `<div>${escapeHtml(line)}</div>`).join('')}</div>`
      : '';
    return `
      <div class="rd-modal-summary-card">
        <div class="rd-modal-summary-title"><i class="fa ${icon}"></i> ${escapeHtml(title)}</div>
        <div class="${primaryClass}">${escapeHtml(metric.primary)}</div>
        <div class="rd-modal-summary-sub">${escapeHtml(subtitle)}</div>
        ${breakdownHtml}
      </div>
    `;
  }

  function computeReceivableContactMetrics(originRows, settlementRows, group){
    let receivableOriginTotals = buildCurrencyMapFromGroup(group, 'receivable_origin');
    let receivableSettlementTotals = buildCurrencyMapFromGroup(group, 'receivable_settlement');
    let debtOriginTotals = buildCurrencyMapFromGroup(group, 'debt_origin');
    let debtSettlementTotals = buildCurrencyMapFromGroup(group, 'debt_settlement');

    if (!receivableOriginTotals.size && !receivableSettlementTotals.size && !debtOriginTotals.size && !debtSettlementTotals.size){
      receivableOriginTotals = new Map();
      receivableSettlementTotals = new Map();
      debtOriginTotals = new Map();
      debtSettlementTotals = new Map();

      originRows.forEach(row => {
        const amount = Math.abs(toNumeric(row.amount != null ? row.amount : row.transaction_value));
        if (!Number.isFinite(amount)) return;
        if (row.flow === 'loan_provided') {
          accumulateCurrency(receivableOriginTotals, row.currency, amount);
        } else if (row.flow === 'debt_received') {
          accumulateCurrency(debtOriginTotals, row.currency, amount);
        }
      });
      settlementRows.forEach(row => {
        const amount = Math.abs(toNumeric(row.amount != null ? row.amount : row.transaction_value));
        if (!Number.isFinite(amount)) return;
        if (row.flow === 'loan_repaid') {
          accumulateCurrency(receivableSettlementTotals, row.currency, amount);
        } else if (row.flow === 'debt_paid') {
          accumulateCurrency(debtSettlementTotals, row.currency, amount);
        }
      });
    }

    const receivableNetTotals = subtractCurrencyMaps(receivableOriginTotals, receivableSettlementTotals);
    const debtNetTotals = subtractCurrencyMaps(debtOriginTotals, debtSettlementTotals);
    const outstandingTotals = subtractCurrencyMaps(receivableNetTotals, debtNetTotals);
    const settlementTotals = addCurrencyMaps(receivableSettlementTotals, debtSettlementTotals);

    const receivableOriginCount = originRows.filter(r => r.flow === 'loan_provided').length;
    const debtOriginCount = originRows.filter(r => r.flow === 'debt_received').length;
    const receivableSettlementCount = settlementRows.filter(r => r.flow === 'loan_repaid').length;
    const debtSettlementCount = settlementRows.filter(r => r.flow === 'debt_paid').length;

    const computedOpenItems = Array.from(outstandingTotals.values()).filter(val => Math.abs(val) > 0.005).length;

    return {
      receivableOriginTotals,
      receivableSettlementTotals,
      receivableNetTotals,
      debtOriginTotals,
      debtSettlementTotals,
      debtNetTotals,
      outstandingTotals,
      settlementTotals,
      originCount: originRows.length,
      settlementCount: settlementRows.length,
      totalCount: originRows.length + settlementRows.length,
      receivableOriginCount,
      debtOriginCount,
      receivableSettlementCount,
      debtSettlementCount,
      openItems: group && Number.isFinite(group.open_items) ? group.open_items : computedOpenItems
    };
  }

  function renderReceivableContactSummary(modalState, group, metrics){
    if (!modalState || !modalState.summary) return;
    const container = modalState.summary;
    const statusLabel = (group && group.status) ? group.status.toUpperCase() : (metrics.openItems ? 'OPEN' : 'PAID');
    const statusClass = statusLabel === 'PAID' ? 'rd-badge-paid' : (statusLabel === 'OPEN' ? 'rd-badge-open' : 'rd-badge-empty');
    const overallMetric = buildSummaryLines(metrics.outstandingTotals);
    const receivableMetric = buildSummaryLines(metrics.receivableNetTotals);
    const debtMetric = buildSummaryLines(metrics.debtNetTotals);
    const settlementEntryCount = (metrics.receivableSettlementCount || 0) + (metrics.debtSettlementCount || 0);
    const metaParts = [
      `${metrics.totalCount || 0} entr${metrics.totalCount === 1 ? 'y' : 'ies'}`,
      `${metrics.receivableOriginCount || 0} receivable origin`,
      `${metrics.debtOriginCount || 0} debt origin`,
      `${settlementEntryCount} settlement${settlementEntryCount === 1 ? '' : 's'}`
    ];
    if (group && Array.isArray(group.currencies) && group.currencies.length){
      metaParts.push(`${group.currencies.length} currenc${group.currencies.length === 1 ? 'y' : 'ies'}`);
    }
    if (metrics.openItems) {
      metaParts.push(`${metrics.openItems} open item${metrics.openItems === 1 ? '' : 's'}`);
    }
    const receivableSubtitle = `${metrics.receivableOriginCount || 0} origin • ${metrics.receivableSettlementCount || 0} settlements`;
    const debtSubtitle = `${metrics.debtOriginCount || 0} origin • ${metrics.debtSettlementCount || 0} repayments`;
    const overallSubtitle = 'Net receivable minus debt outstanding';
    container.innerHTML = `
      <div class="rd-modal-summary-meta">
        <span class="rd-badge ${statusClass}"><i class="fa fa-circle"></i> ${escapeHtml(statusLabel)}</span>
        <span>${escapeHtml(metaParts.join(' • '))}</span>
      </div>
      <div class="rd-modal-summary-grid">
        ${renderSummaryCard('fa-scale-balanced', 'Net exposure', overallMetric, overallSubtitle)}
        ${renderSummaryCard('fa-hand-holding-dollar', 'Receivable outstanding', receivableMetric, receivableSubtitle)}
        ${renderSummaryCard('fa-file-invoice-dollar', 'Debt outstanding', debtMetric, debtSubtitle)}
      </div>
    `;
  }

  function mapToSortedArray(map){
    if (!map || typeof map.forEach !== 'function') return [];
    const arr = [];
    map.forEach((value, key) => {
      if (Math.abs(value) > 0.005){
        arr.push({ currency: key, value });
      }
    });
    arr.sort((a, b) => a.currency.localeCompare(b.currency));
    return arr;
  }

  function formatSignedAmount(amount){
    const num = toNumeric(amount);
    return (num >= 0 ? '' : '-') + formatCurrency(Math.abs(num));
  }

  function buildReceiptLines(report){
    const lines = [];
    const { metrics, group } = report;
    const summaryParts = [];
    summaryParts.push(`Total entries: ${metrics.totalCount || 0}`);
    summaryParts.push(`Origin transactions: ${metrics.originCount || 0}`);
    summaryParts.push(`Settlements: ${metrics.settlementCount || 0}`);
    if (group && Array.isArray(group.currencies)){
      summaryParts.push(`Currencies: ${group.currencies.length}`);
    }

    lines.push({ type: 'title', text: `Contact Overview – ${report.displayName}` });
    lines.push({ type: 'note', text: `Generated ${report.generatedAt ? report.generatedAt.toLocaleString() : new Date().toLocaleString()}` });
    lines.push({ type: 'section', text: 'Summary' });
    summaryParts.forEach(part => lines.push({ type: 'text', text: part }));

    const receivableDetails = mapToSortedArray(metrics.receivableNetTotals);
    const debtDetails = mapToSortedArray(metrics.debtNetTotals);

    lines.push({ type: 'section', text: 'Receivable Outstanding' });
    if (receivableDetails.length){
      receivableDetails.forEach(item => {
        const origin = toNumeric(metrics.receivableOriginTotals.get(item.currency) || 0);
        const collected = toNumeric(metrics.receivableSettlementTotals.get(item.currency) || 0);
        lines.push({ type: 'text', text: `${item.currency}: ${formatSignedAmount(item.value)} (Origin ${formatSignedAmount(origin)} • Collected ${formatSignedAmount(collected)})` });
      });
    } else {
      lines.push({ type: 'note', text: 'No receivable balance recorded.' });
    }

    lines.push({ type: 'section', text: 'Debt Outstanding' });
    if (debtDetails.length){
      debtDetails.forEach(item => {
        const origin = toNumeric(metrics.debtOriginTotals.get(item.currency) || 0);
        const repaid = toNumeric(metrics.debtSettlementTotals.get(item.currency) || 0);
        lines.push({ type: 'text', text: `${item.currency}: ${formatSignedAmount(item.value)} (Origin ${formatSignedAmount(origin)} • Repaid ${formatSignedAmount(repaid)})` });
      });
    } else {
      lines.push({ type: 'note', text: 'No debt balance recorded.' });
    }

    const addEntryLines = (rows, label) => {
      lines.push({ type: 'section', text: label });
      if (!rows.length){
        lines.push({ type: 'note', text: 'No transactions in this section.' });
        return;
      }
      const sorted = [...rows].sort((a, b) => {
        const da = Date.parse(a.date_iso || a.entry_date || '');
        const db = Date.parse(b.date_iso || b.entry_date || '');
        return (da || 0) - (db || 0);
      });
      sorted.forEach(row => {
        const date = row.date_iso || row.entry_date || '(no date)';
        const amountRaw = row.amount != null ? row.amount : (row.transaction_value != null ? row.transaction_value : 0);
        const amount = formatSignedAmount(amountRaw);
        const account = row.account_name || 'Account';
        const description = row.description || row.flow_label || '';
        const parts = [`${date}`, `${row.currency || 'KRW'} ${amount}`, account];
        if (description) parts.push(description);
        lines.push({ type: 'text', text: parts.join(' • ') });
      });
    };

    addEntryLines(report.originRows || [], 'Origin Transactions');
    addEntryLines(report.settlementRows || [], 'Settlement Transactions');

    return lines;
  }

  function buildReceiptCanvas(report){
    const lines = buildReceiptLines(report);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const width = 900;
    const paddingX = 50;
    const paddingY = 60;
    const maxWidth = width - paddingX * 2;
    const styleMap = {
      title: { font: '600 30px "SF Pro Display", "Helvetica Neue", Arial, sans-serif', lineHeight: 42, color: '#145c2c' },
      section: { font: '600 22px "SF Pro Display", "Helvetica Neue", Arial, sans-serif', lineHeight: 34, color: '#1a4d2e' },
      text: { font: '400 16px "SF Pro Text", "Helvetica Neue", Arial, sans-serif', lineHeight: 26, color: '#1a4d2e' },
      note: { font: 'italic 15px "SF Pro Text", "Helvetica Neue", Arial, sans-serif', lineHeight: 24, color: '#557a68' }
    };

    const wrapText = (metric, text) => {
      const { font } = metric;
      ctx.font = font;
      const words = String(text).split(/\s+/);
      const wrapped = [];
      let current = '';
      words.forEach(word => {
        const tentative = current ? `${current} ${word}` : word;
        if (ctx.measureText(tentative).width > maxWidth && current){
          wrapped.push(current);
          current = word;
        } else {
          current = tentative;
        }
      });
      if (current) wrapped.push(current);
      return wrapped;
    };

    const renderedLines = [];
    lines.forEach(item => {
      const metric = styleMap[item.type] || styleMap.text;
      const parts = wrapText(metric, item.text);
      parts.forEach((part, idx) => {
        renderedLines.push({ font: metric.font, color: metric.color, text: part, lineHeight: metric.lineHeight, extraGap: idx === parts.length - 1 ? 4 : 0 });
      });
      renderedLines.push({ type: 'spacer', size: 6 });
    });

    const totalHeight = paddingY * 2 + renderedLines.reduce((acc, line) => {
      if (line.type === 'spacer') return acc + line.size;
      return acc + line.lineHeight + (line.extraGap || 0);
    }, 0);

    canvas.width = width;
    canvas.height = Math.ceil(totalHeight);

    const draw = canvas.getContext('2d');
    draw.fillStyle = '#ffffff';
    draw.fillRect(0, 0, canvas.width, canvas.height);

    let cursorY = paddingY;
    renderedLines.forEach(line => {
      if (line.type === 'spacer') {
        cursorY += line.size;
        return;
      }
      draw.font = line.font;
      draw.fillStyle = line.color;
      draw.textBaseline = 'top';
      draw.fillText(line.text, paddingX, cursorY);
      cursorY += line.lineHeight + (line.extraGap || 0);
    });

    return canvas;
  }

  function downloadContactOverview(){
    const modalState = ensureReceivableContactModal();
    if (!modalState || !modalState.currentReport){
      console.warn('No contact data available for export.');
      return;
    }
    const canvas = buildReceiptCanvas(modalState.currentReport);
    try {
      canvas.toBlob((blob) => {
        const link = document.createElement('a');
        link.style.display = 'none';
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        link.download = `contact-overview-${timestamp}.png`;
        if (blob){
          const url = URL.createObjectURL(blob);
          link.href = url;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setTimeout(() => URL.revokeObjectURL(url), 0);
        } else {
          link.href = canvas.toDataURL('image/png');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }, 'image/png');
    } catch (err){
      console.error('Download failed, attempting fallback', err);
      const link = document.createElement('a');
      link.style.display = 'none';
      link.download = `contact-overview-${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }

  function renderReceivableModalEntries(container, entries, role){
    if (!container) return;
    container.innerHTML = '';
    if (!entries || !entries.length){
      container.innerHTML = '<div class="rd-modal-empty">No transactions in this section yet.</div>';
      return;
    }
    entries.forEach(row => {
      const el = document.createElement('div');
      el.className = 'rd-modal-entry';
      const currencyCode = (row.currency || 'KRW').toUpperCase();
      const amountBase = row.amount != null ? row.amount : (row.transaction_value != null ? row.transaction_value : 0);
      const amountPrimary = Math.abs(toNumeric(amountBase));
      const amountLabel = `${currencyCode} ${formatCurrency(Number.isFinite(amountPrimary) ? amountPrimary : 0)}`;
      const title = row.description || row.flow_label || row.account_name || (role === 'origin' ? 'Origin entry' : 'Payment');
      const dateLabel = row.date_iso || row.entry_date || '';
      const tags = [];
      if (role === 'origin') {
        tags.push('<span class="rd-tag rd-tag-origin"><i class="fa fa-seedling"></i> Origin</span>');
      } else {
        tags.push('<span class="rd-tag rd-tag-payment"><i class="fa fa-arrow-up-right-from-square"></i> Payment</span>');
      }
      if (role === 'origin' && row.due_date){
        tags.push(`<span class="rd-tag rd-tag-due"><i class="fa fa-clock"></i> Due ${escapeHtml(row.due_date)}</span>`);
      }
      const detailLines = [];
      detailLines.push(`<span><i class="fa fa-building-columns"></i> ${escapeHtml(row.account_name || 'Account')}</span>`);
      if (row.reference) detailLines.push(`<span><i class="fa fa-hashtag"></i> Ref ${escapeHtml(row.reference)}</span>`);
      const payments = Array.isArray(row.payment_dates) ? row.payment_dates : [];
      if (payments.length){
        detailLines.push(`<span><i class="fa fa-calendar-check"></i> Payments ${escapeHtml(payments.join(', '))}</span>`);
      }
      const linked = Array.isArray(row.linked_entries) ? row.linked_entries : [];
      const targets = role === 'origin'
        ? linked.filter(le => le && le.flow_group === 'settlement')
        : linked.filter(le => le && le.flow_group === 'origin');
      let linkedHtml = '';
      if (targets.length){
        const heading = role === 'origin' ? 'Linked payments' : 'Linked origin';
        const items = targets.map(le => {
          const linkAmount = toNumeric(le.amount);
          const parts = [];
          if (le.contact_name) parts.push(le.contact_name);
          if (le.flow_label) parts.push(le.flow_label);
          if (Number.isFinite(linkAmount)) parts.push(`${(le.currency || currencyCode)} ${formatCurrency(linkAmount)}`);
          if (le.date) parts.push(le.date);
          const descriptor = parts.length ? parts.join(' • ') : `Entry #${le.line_id}`;
          return `<div class="rd-modal-linked-item"><span>${escapeHtml(descriptor)}</span></div>`;
        }).join('');
        linkedHtml = `<div class="rd-modal-linked"><div class="rd-modal-linked-title"><i class="fa fa-link"></i> ${escapeHtml(heading)}</div>${items}</div>`;
      }
      el.innerHTML = `
        <div class="rd-modal-entry-header">
          <div class="rd-modal-entry-info">
            <div class="rd-modal-entry-title">${escapeHtml(title)}</div>
            <div class="rd-modal-entry-sub"><i class="fa fa-calendar"></i> ${escapeHtml(dateLabel || 'Date not set')}</div>
          </div>
          <div class="rd-modal-entry-amount">${escapeHtml(amountLabel)}</div>
        </div>
        ${tags.length ? `<div class="rd-modal-entry-tags">${tags.join('')}</div>` : ''}
        <div class="rd-modal-entry-body">${detailLines.join('')}</div>
        ${linkedHtml}
      `;
      container.appendChild(el);
    });
  }

  function toggleLoanGroupForm(modalState, show, preserveValues = false){
    if (!modalState || !modalState.groupForm) return;
    const form = modalState.groupForm;
    const toggle = modalState.groupToggle;
    if (show){
      form.style.display = 'block';
      if (toggle) toggle.style.display = 'none';
      if (!preserveValues){
        resetLoanGroupForm(modalState);
      }
      const nameInput = modalState.groupFormName;
      if (nameInput){
        try { nameInput.focus(); } catch (_) {}
      }
    } else {
      form.style.display = 'none';
      if (toggle) toggle.style.display = '';
      resetLoanGroupForm(modalState);
      if (modalState.groupFeedback){
        modalState.groupFeedback.textContent = '';
        modalState.groupFeedback.style.color = '#1a4d2e';
      }
    }
  }

  function resetLoanGroupForm(modalState){
    if (!modalState || !modalState.groupForm) return;
    modalState.groupFormMode = 'create';
    modalState.editingGroupId = null;
    const saveBtn = modalState.groupForm.querySelector('.rd-modal-group-save');
    if (saveBtn) saveBtn.innerHTML = '<i class="fa fa-floppy-disk"></i> Save';
    const today = new Date();
    const iso = today.toISOString().slice(0, 10);
    if (modalState.groupFormStart) modalState.groupFormStart.value = iso;
    if (modalState.groupFormDirection){
      const dir = modalState.lastDirection || 'receivable';
      modalState.groupFormDirection.value = dir;
    }
    if (modalState.groupFormCurrency){
      modalState.groupFormCurrency.value = (modalState.lastCurrency || 'KRW').toUpperCase();
    }
    if (modalState.groupFormPrincipal){
      modalState.groupFormPrincipal.value = '';
    }
    if (modalState.groupFormName){
      const suffix = modalState.lastDirection === 'payable' ? 'Borrowing' : 'Loan';
      const base = modalState.activeContact ? `${modalState.activeContact} ${suffix}` : 'Loan Thread';
      modalState.groupFormName.value = base;
    }
  }

  async function loadContactLoanGroups(modalState, contactName, directionHint, currencyHint){
    if (!modalState || !modalState.groupsList) return;
    const container = modalState.groupsList;
    container.innerHTML = '<div class="rd-modal-groups-empty">Loading loan threads…</div>';
    const params = new URLSearchParams({ include_summary: 'true' });
    if (contactName) params.set('counterparty', contactName);
    if (directionHint) params.set('direction', directionHint);
    if (currencyHint) params.set('currency', currencyHint);
    try {
      const res = await fetch(`/accounting/loan-groups?${params.toString()}`);
      const data = await res.json();
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Unable to load loan threads.');
      }
      if (modalState.groupCache) modalState.groupCache.clear();
      renderContactLoanGroupCards(modalState, Array.isArray(data.groups) ? data.groups : []);
    } catch (err){
      console.error(err);
      container.innerHTML = `<div class="rd-modal-groups-error">${escapeHtml(err && err.message ? err.message : 'Unable to load loan threads.')}</div>`;
    }
  }

  function renderContactLoanGroupCards(modalState, groups){
    if (!modalState || !modalState.groupsList) return;
    const container = modalState.groupsList;
    container.innerHTML = '';
    if (!groups.length){
      container.innerHTML = '<div class="rd-modal-groups-empty">No loan threads yet.</div>';
      return;
    }
    groups.forEach(group => {
      const card = document.createElement('div');
      card.className = 'rd-thread-card';
      card.dataset.groupId = group.id;
      const summary = group.summary || {};
      const statusValue = (summary.status || group.status || 'open').toLowerCase();
      const statusText = statusValue.toUpperCase();
      const statusClass = statusValue === 'closed' ? 'rd-status-chip-paid'
                        : statusValue === 'overpaid' ? 'rd-status-chip-open rd-status-chip-overpaid'
                        : 'rd-status-chip-open';
      const currency = (group.currency || 'KRW').toUpperCase();
      const principal = Number.isFinite(summary.principal) ? summary.principal : group.principal_amount || 0;
      const repaid = Number.isFinite(summary.repaid) ? summary.repaid : 0;
      const remaining = Number.isFinite(summary.remaining) ? summary.remaining : principal - repaid;
      card.innerHTML = `
        <div class="rd-thread-header">
          <div class="rd-thread-headline">
            <div class="rd-thread-name">${escapeHtml(group.name || 'Loan Thread')}</div>
            <div class="rd-thread-meta">${escapeHtml(currency)} • ${escapeHtml((group.direction || 'receivable').toUpperCase())}${group.counterparty ? ` • ${escapeHtml(group.counterparty)}` : ''}</div>
          </div>
          <div class="rd-status-chip ${statusClass}">${escapeHtml(statusText)}</div>
        </div>
        <div class="rd-thread-summary">
          <span><strong>Principal</strong> ${escapeHtml(currency)} ${formatCurrency(toNumeric(principal))}</span>
          <span><strong>Repaid</strong> ${escapeHtml(currency)} ${formatCurrency(toNumeric(repaid))}</span>
          <span><strong>Remaining</strong> ${escapeHtml(currency)} ${formatCurrency(toNumeric(remaining))}</span>
        </div>
        <div class="rd-thread-actions">
          <button type="button" class="icon-btn rd-thread-toggle" data-group-id="${escapeHtml(group.id)}" aria-expanded="false"><i class="fa fa-chart-line"></i> Timeline</button>
          <div class="rd-thread-actions-right">
            <button type="button" class="icon-btn rd-thread-edit" data-group-id="${escapeHtml(group.id)}"><i class="fa fa-pen"></i> Edit</button>
            <button type="button" class="icon-btn rd-thread-delete" data-group-id="${escapeHtml(group.id)}"><i class="fa fa-trash"></i> Delete</button>
          </div>
        </div>
        <div class="rd-thread-timeline" data-group-id="${escapeHtml(group.id)}" style="display:none;" aria-hidden="true"></div>
      `;
      const toggleBtn = card.querySelector('.rd-thread-toggle');
      const timeline = card.querySelector('.rd-thread-timeline');
      if (toggleBtn && timeline){
        toggleBtn.addEventListener('click', () => toggleLoanGroupTimeline(modalState, group, toggleBtn, timeline));
      }
      const editBtn = card.querySelector('.rd-thread-edit');
      if (editBtn){
        editBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          startLoanGroupEdit(modalState, group);
        });
      }
      const deleteBtn = card.querySelector('.rd-thread-delete');
      if (deleteBtn){
        deleteBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          deleteLoanGroup(modalState, group);
        });
      }
      container.appendChild(card);
    });
  }

  function startLoanGroupEdit(modalState, group){
    if (!modalState || !group) return;
    if (!modalState.groupForm) return;
    modalState.groupFormMode = 'edit';
    modalState.editingGroupId = group.id;
    modalState.lastDirection = (group.direction || modalState.lastDirection || 'receivable');
    modalState.lastCurrency = (group.currency || modalState.lastCurrency || 'KRW').toUpperCase();
    toggleLoanGroupForm(modalState, true, true);
    if (modalState.groupFormName) modalState.groupFormName.value = group.name || '';
    if (modalState.groupFormDirection) modalState.groupFormDirection.value = (group.direction || 'receivable');
    if (modalState.groupFormCurrency) modalState.groupFormCurrency.value = (group.currency || 'KRW').toUpperCase();
    if (modalState.groupFormPrincipal) modalState.groupFormPrincipal.value = formatAmountInput(group.principal_amount || 0);
    if (modalState.groupFormStart) modalState.groupFormStart.value = group.start_date || '';
    const saveBtn = modalState.groupForm.querySelector('.rd-modal-group-save');
    if (saveBtn) saveBtn.innerHTML = '<i class="fa fa-floppy-disk"></i> Update';
    if (modalState.groupFeedback){
      modalState.groupFeedback.textContent = '';
      modalState.groupFeedback.style.color = '#1a4d2e';
    }
  }

  async function deleteLoanGroup(modalState, group){
    if (!modalState || !group) return;
    if (!confirm('Delete this loan thread? Allocations linked to it will also be removed.')) return;
    const csrf = (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '';
    try {
      const res = await fetch(`/accounting/loan-groups/${encodeURIComponent(group.id)}`, {
        method: 'DELETE',
        headers: { 'X-CSRF-Token': csrf }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false){
        throw new Error((data && data.error) || 'Unable to delete loan thread.');
      }
      const state = ensureReceivableState();
      state.loanGroupCache.clear();
      state.loanGroupSuggestions.clear();
      if (modalState.groupCache) modalState.groupCache.clear();
      if (modalState.editingGroupId === group.id){
        toggleLoanGroupForm(modalState, false);
      }
      loadContactLoanGroups(modalState, modalState.activeContact, modalState.lastDirection, modalState.lastCurrency);
      await loadReceivableData();
      if (modalState.groupFeedback){
        modalState.groupFeedback.style.color = '#1a4d2e';
        modalState.groupFeedback.textContent = 'Loan thread deleted.';
      }
    } catch (err){
      console.error(err);
      if (modalState && modalState.groupFeedback){
        modalState.groupFeedback.style.color = '#b22222';
        modalState.groupFeedback.textContent = err && err.message ? err.message : 'Unable to delete loan thread.';
      }
    }
  }

  async function toggleLoanGroupTimeline(modalState, group, toggleBtn, timeline){
    if (!timeline || !group) return;
    const expanded = timeline.getAttribute('data-open') === 'true';
    if (expanded){
      timeline.style.display = 'none';
      timeline.setAttribute('data-open', 'false');
      toggleBtn.setAttribute('aria-expanded', 'false');
      return;
    }
    toggleBtn.disabled = true;
    toggleBtn.setAttribute('aria-busy', 'true');
    timeline.innerHTML = '<div class="rd-thread-timeline-empty">Loading timeline…</div>';
    try {
      let cached = modalState && modalState.groupCache ? modalState.groupCache.get(group.id) : null;
      if (!cached){
        const res = await fetch(`/accounting/loan-groups/${encodeURIComponent(group.id)}/entries`);
        const data = await res.json();
        if (!res.ok || !data || data.ok === false){
          throw new Error((data && data.error) || 'Unable to load timeline.');
        }
        cached = data;
        if (modalState && modalState.groupCache){
          modalState.groupCache.set(group.id, cached);
        }
      }
      renderLoanGroupTimeline(timeline, cached.entries || [], cached.summary || group.summary || {}, group.currency || 'KRW');
      timeline.style.display = 'block';
      timeline.setAttribute('data-open', 'true');
      toggleBtn.setAttribute('aria-expanded', 'true');
    } catch (err){
      console.error(err);
      timeline.innerHTML = `<div class="rd-thread-timeline-error">${escapeHtml(err && err.message ? err.message : 'Unable to load timeline.')}</div>`;
      timeline.style.display = 'block';
      timeline.setAttribute('data-open', 'true');
    } finally {
      toggleBtn.disabled = false;
      toggleBtn.removeAttribute('aria-busy');
    }
  }

  function renderLoanGroupTimeline(container, entries, summary, currency){
    if (!container) return;
    container.innerHTML = '';
    const list = document.createElement('div');
    list.className = 'rd-thread-timeline-list';
    const data = Array.isArray(entries) ? entries : [];
    if (!data.length){
      container.innerHTML = '<div class="rd-thread-timeline-empty">No allocations recorded yet.</div>';
      return;
    }
    data.forEach(entry => {
      const flow = (entry.flow || '').toLowerCase();
      const flowLabel = flow === 'origin' ? 'Origin' : 'Repayment';
      const rowCurrency = (entry.currency || currency || 'KRW').toUpperCase();
      const amount = formatCurrency(toNumeric(entry.linked_amount || 0));
      const balance = formatCurrency(toNumeric(entry.balance_after || 0));
      const row = document.createElement('div');
      row.className = `rd-thread-row rd-thread-row-${flow}`;
      row.innerHTML = `
        <div class="rd-thread-row-left">
          <div class="rd-thread-date"><i class="fa fa-calendar"></i> ${escapeHtml(entry.date || 'Date not set')}</div>
          <div class="rd-thread-label">${escapeHtml(flowLabel)}</div>
          ${entry.description ? `<div class="rd-thread-desc">${escapeHtml(entry.description)}</div>` : ''}
        </div>
        <div class="rd-thread-row-right">
          <div class="rd-thread-amount">${escapeHtml(rowCurrency)} ${amount}</div>
          <div class="rd-thread-balance">${escapeHtml(rowCurrency)} ${balance}</div>
        </div>
      `;
      list.appendChild(row);
    });
    container.appendChild(list);
    if (summary && summary.remaining !== undefined){
      const footer = document.createElement('div');
      footer.className = 'rd-thread-footer';
      footer.innerHTML = `<strong>Remaining:</strong> ${escapeHtml((currency || 'KRW').toUpperCase())} ${formatCurrency(toNumeric(summary.remaining))}`;
      container.appendChild(footer);
    }
  }

  function openReceivableContactModal(contactKey){
    const modalState = ensureReceivableContactModal();
    if (!modalState) return;
    const state = ensureReceivableState();
    modalState.lastActive = document.activeElement;
    const normalized = normalizeContactName(contactKey);
    const rows = state.rows.filter(r => normalizeContactName(r.contact_name) === normalized);
    rows.sort((a, b) => {
      const da = Date.parse(a.date_iso || a.entry_date || '') || 0;
      const db = Date.parse(b.date_iso || b.entry_date || '') || 0;
      return db - da;
    });
    const group = (state.contactGroups || []).find(g => normalizeContactName(g.key || g.contact_name) === normalized);
    const displayName = group && group.contact_name ? group.contact_name : (rows[0] && rows[0].contact_name ? rows[0].contact_name : 'Contact');
    if (modalState.title) modalState.title.textContent = `Contact: ${displayName}`;
    const originRows = rows.filter(r => RECEIVABLE_BASE_FLOWS.has(r.flow));
    const settlementRows = rows.filter(r => RECEIVABLE_SETTLEMENT_FLOWS.has(r.flow));
    const metrics = computeReceivableContactMetrics(originRows, settlementRows, group);
    renderReceivableModalEntries(modalState.originList, originRows, 'origin');
    renderReceivableModalEntries(modalState.settlementList, settlementRows, 'settlement');
    renderReceivableContactSummary(modalState, group, metrics);
    modalState.currentReport = {
      displayName,
      metrics,
      originRows,
      settlementRows,
      group,
      generatedAt: new Date()
    };
    modalState.activeContact = displayName;
    const receivableCount = rows.filter(r => (r.type || '') === 'receivable').length;
    const debtCount = rows.filter(r => (r.type || '') === 'debt').length;
    const directionHint = debtCount > receivableCount ? 'payable' : 'receivable';
    modalState.lastDirection = directionHint;
    const firstCurrencyRow = rows.find(r => r && r.currency);
    const groupCurrency = group && Array.isArray(group.currencies) && group.currencies.length
      ? (group.currencies[0].currency || 'KRW')
      : null;
    const currencyHint = (firstCurrencyRow && firstCurrencyRow.currency) || groupCurrency || 'KRW';
    modalState.lastCurrency = (currencyHint || 'KRW').toUpperCase();
    toggleLoanGroupForm(modalState, false);
    resetLoanGroupForm(modalState);
    loadContactLoanGroups(modalState, displayName, directionHint, modalState.lastCurrency);
    if (modalState.toggleOrigin) modalState.toggleOrigin.checked = true;
    if (modalState.toggleSettlement) modalState.toggleSettlement.checked = true;
    toggleReceivableModalSections();
    modalState.modal.classList.add('open');
    modalState.modal.setAttribute('aria-hidden', 'false');
    if (modalState.dialog) {
      modalState.dialog.scrollTop = 0;
      try { modalState.dialog.focus(); } catch (_) {}
    }
  }



  function renderReceivableTable(){
    const state = ensureReceivableState();
    const list = document.getElementById('rd-list');
    const statusEl = document.getElementById('rd-status');
    if (!list) return;
    list.innerHTML = '';
    updateReceivableTabButtons();

    const viewingSaved = state.viewMode === 'saved';
    const sourceTotal = viewingSaved ? state.savedRows.length : state.unsavedRows.length;
    const filteredFull = getFilteredReceivableRows(state);
    const total = filteredFull.length;
    const pageSize = state.pageSize || 50;
    let page = viewingSaved ? state.savedPage : state.unsavedPage;
    const pageCount = total ? Math.max(1, Math.ceil(total / pageSize)) : 1;
    if (page > pageCount) page = pageCount;
    if (page < 1) page = 1;
    if (viewingSaved) state.savedPage = page; else state.unsavedPage = page;
    const startIndex = total ? (page - 1) * pageSize + 1 : 0;
    const endIndex = total ? Math.min(total, startIndex + pageSize - 1) : 0;
    const pagedRows = total ? filteredFull.slice(startIndex - 1, startIndex - 1 + pageSize) : [];

    state.lastFilteredCount = total;
    state.lastFilteredRange = { start: startIndex, end: endIndex, page, pageCount };
    state.lastFilteredMode = state.viewMode;

    if (!pagedRows.length){
      const empty = document.createElement('div');
      empty.className = 'rd-empty';
      let message;
      const cutoffDisplay = state.initCutoff ? new Date(state.initCutoff).toLocaleDateString() : '';
      if (!sourceTotal){
        message = state.rows.length
          ? (viewingSaved ? 'No saved entries yet.' : 'All entries are already saved.')
          : 'No receivable or short-term debt activity found yet.';
        if (cutoffDisplay) {
          message += ` on or after ${cutoffDisplay}`;
        }
      } else {
        message = viewingSaved ? 'No saved entries match your current filters.' : 'No entries needing info match your current filters.';
      }
      empty.textContent = message;
      list.appendChild(empty);
      if (statusEl) {
        statusEl.style.color = '#1a4d2e';
        statusEl.textContent = message;
      }
      renderReceivablePagination(total, page, pageCount, startIndex, endIndex);
      state.justSavedId = null;
      refreshReceivableSummary();
      renderReceivableContactGroups();
      return;
    }

    pagedRows.forEach(baseRow => {
      const row = getEffectiveReceivableRow(baseRow);
      const entry = document.createElement('div');
      entry.className = 'rd-entry';
      if (!row.is_saved) entry.classList.add('rd-entry-unsaved');
      const isManual = !!row.is_manual;
      if (isManual) entry.classList.add('rd-entry-manual');
      entry.dataset.lineId = baseRow.line_id;
      const typeTitle = row.type === 'receivable' ? 'Receivable' : 'Short-Term Debt';
      const typeClass = row.type === 'receivable' ? 'rd-chip rd-chip-receivable' : 'rd-chip rd-chip-debt';
      const accountName = escapeHtml(baseRow.account_name || 'Account');
      const description = escapeHtml(baseRow.description || '(No description)');
      const dateLabel = escapeHtml(row.date_iso || row.entry_date || '');
      const reference = baseRow.reference ? ` • Ref: ${escapeHtml(baseRow.reference)}` : '';
      const amountLabel = `${row.currency} ${formatCurrency(baseRow.amount || 0)}`;
      const unsavedHtml = row.is_saved ? '' : '<span class="rd-unsaved-chip">Needs info</span>';
      const flowLabel = escapeHtml(row.flow_label || '');
      const flowHtml = flowLabel ? `<div class="rd-meta rd-flow-meta">${flowLabel}</div>` : '';
      const linkedEntries = Array.isArray(row.linked_entries) ? row.linked_entries : [];
      const linkedCounts = linkedEntries.reduce((acc, item) => {
        const group = (item && item.flow_group) || 'other';
        acc[group] = (acc[group] || 0) + 1;
        return acc;
      }, { origin: 0, settlement: 0, other: 0 });
      const isBaseFlow = RECEIVABLE_BASE_FLOWS.has(row.flow);
      const isSettlementFlow = RECEIVABLE_SETTLEMENT_FLOWS.has(row.flow);
      const primaryLinked = linkedEntries.find(le => (isSettlementFlow && le.flow_group === 'origin') || (isBaseFlow && le.flow_group === 'settlement')) || linkedEntries[0] || null;
      const linkedLabel = primaryLinked ? (buildLinkLabel(primaryLinked) || `entry #${primaryLinked.line_id}`) : '';
      let linkedMetaHtml = '';
      if (linkedEntries.length === 1 && linkedLabel){
        linkedMetaHtml = `<div class="rd-meta rd-linked-meta"><i class="fa fa-link"></i> Linked to ${escapeHtml(linkedLabel)}</div>`;
      } else if (linkedEntries.length > 1){
        const parts = [];
        if (linkedCounts.origin) parts.push(`${linkedCounts.origin} origin`);
        if (linkedCounts.settlement) parts.push(`${linkedCounts.settlement} payment${linkedCounts.settlement === 1 ? '' : 's'}`);
        if (linkedCounts.other) parts.push(`${linkedCounts.other} other`);
        const summaryText = parts.length ? parts.join(' • ') : `${linkedEntries.length} linked`;
        linkedMetaHtml = `<div class="rd-meta rd-linked-meta"><i class="fa fa-link"></i> Linked: ${escapeHtml(summaryText)}</div>`;
      }
      const headerLinkText = isManual ? '' : (linkedEntries.length === 1 ? linkedLabel : (linkedEntries.length > 1 ? `${linkedEntries.length} linked` : ''));
      const manualChipHtml = isManual ? '<span class="rd-chip rd-chip-manual"><i class="fa fa-bookmark"></i> Tracker only</span>' : '';
      const linkOptions = isManual ? [] : buildReceivableLinkOptions(row);
      let linkOptionsHtml = linkOptions.length ? '<option value="">Select transaction…</option>' : '<option value="">No available transactions</option>';
      linkOptions.forEach(opt => {
        linkOptionsHtml += `<option value="${opt.id}">${escapeHtml(opt.label || 'Entry')}</option>`;
      });
      const clearLabel = isBaseFlow ? 'Clear All' : 'Clear';
      const clearTitle = isBaseFlow ? 'Remove all linked transactions' : 'Remove link';
      const clearButtonDisabled = linkedEntries.length ? '' : ' disabled';
      const linkSelectDisabledAttr = linkOptions.length ? '' : ' disabled';
      const linkChipsHtml = (linkedEntries.length && !isManual) ? linkedEntries.map(le => {
        const badge = le.flow_group === 'origin' ? 'Origin' : (le.flow_group === 'settlement' ? 'Payment' : 'Linked');
        const amountValue = (le.amount || le.amount === 0) ? toNumeric(le.amount) : null;
        const amountPart = (le.currency && amountValue !== null && !Number.isNaN(amountValue)) ? `${le.currency} ${formatCurrency(amountValue)}` : '';
        const parts = [];
        if (le.contact_name) parts.push(le.contact_name);
        if (le.flow_label) parts.push(le.flow_label);
        if (amountPart) parts.push(amountPart);
        if (le.date) parts.push(le.date);
        const descriptor = parts.length ? parts.join(' • ') : `Entry #${le.line_id}`;
        return `<span class="rd-link-chip rd-link-${le.flow_group || 'other'}" data-linked-id="${le.line_id}">
                  <span class="rd-link-chip-label"><strong>${escapeHtml(badge)}</strong> • ${escapeHtml(descriptor)}</span>
                  <button type="button" class="rd-link-remove" data-linked-id="${le.line_id}" title="Remove link"><i class="fa fa-xmark"></i></button>
                </span>`;
      }).join('') : (isManual ? '<div class="rd-link-empty">Manual tracker entries do not link to GL.</div>' : '<div class="rd-link-empty">No linked transactions yet.</div>');
      const linkingBlockHtml = isManual
        ? `<div class="rd-field-group">
              <label>Linked Transactions</label>
              ${linkChipsHtml}
            </div>`
        : `<div class="rd-field-group">
              <label>Linked Transactions</label>
              <div class="rd-link-list">${linkChipsHtml}</div>
              <div class="rd-link-control">
                <select class="rd-input rd-link-select"${linkSelectDisabledAttr}>${linkOptionsHtml}</select>
                <button type="button" class="icon-btn rd-link-add" title="Add link" disabled><i class="fa fa-plus"></i> Link</button>
                <button type="button" class="icon-btn rd-link-clear" title="${clearTitle}"${clearButtonDisabled}><i class="fa fa-unlink"></i> ${clearLabel}</button>
              </div>
            </div>`;
      const loanThreadBlockHtml = isManual ? '' : `<div class="rd-field-group rd-loan-thread-block">
                <label>Loan Threads</label>
                <div class="rd-loan-thread-list">${
                  (Array.isArray(row.loan_groups) && row.loan_groups.length)
                    ? row.loan_groups.map(lg => {
                        const status = (lg.status || '').toLowerCase();
                        const statusLabel = (lg.status || 'open').toUpperCase();
                        const currency = escapeHtml(lg.currency || row.currency || 'KRW');
                        const amount = formatCurrency(toNumeric(lg.linked_amount || 0));
                        const subtitleParts = [];
                        if (lg.summary && lg.summary.remaining !== undefined){
                          subtitleParts.push(`Remaining ${currency} ${formatCurrency(toNumeric(lg.summary.remaining || 0))}`);
                        }
                        if (lg.counterparty && lg.counterparty !== row.contact_name){
                          subtitleParts.push(lg.counterparty);
                        }
                        return `<span class="rd-thread-chip" data-thread-id="${escapeHtml(lg.loan_group_id || lg.id || '')}">
                                  <span class="rd-thread-chip-main"><strong>${escapeHtml(lg.name || 'Loan thread')}</strong> • ${currency} ${amount}</span>
                                  <span class="rd-thread-chip-status rd-status-chip ${status === 'closed' ? 'rd-status-chip-paid' : (status === 'overpaid' ? 'rd-status-chip-overpaid' : 'rd-status-chip-open')}">${escapeHtml(statusLabel)}</span>
                                  ${subtitleParts.length ? `<span class="rd-thread-chip-sub">${escapeHtml(subtitleParts.join(' • '))}</span>` : ''}
                                </span>`;
                      }).join('')
                    : '<div class="rd-loan-thread-empty">No loan thread allocations yet.</div>'
                }</div>
                <div class="rd-loan-thread-control">
                  <select class="rd-input rd-loan-thread-select"><option value="">Select thread…</option></select>
                  <input type="number" class="rd-input rd-loan-thread-amount" step="0.01" min="0" placeholder="Amount">
                  <div class="rd-loan-thread-buttons">
                    <button type="button" class="icon-btn rd-loan-thread-assign"><i class="fa fa-share-from-square"></i> Assign</button>
                    <button type="button" class="icon-btn rd-loan-thread-suggest"><i class="fa fa-lightbulb"></i> Suggest</button>
                    <button type="button" class="icon-btn rd-loan-thread-apply" style="display:none;"><i class="fa fa-check-double"></i> Apply suggestion</button>
                  </div>
                </div>
                <div class="rd-loan-thread-feedback"></div>
              </div>`;
      entry.innerHTML = `
        <div class="rd-entry-header">
          <div class="rd-header-main">
            <div class="rd-header-top">
              <span class="${typeClass}">${typeTitle}</span>
              ${manualChipHtml}
              ${unsavedHtml}
            </div>
            <div class="rd-header-title">${accountName}</div>
            <div class="rd-header-sub">${dateLabel}${reference}</div>
            ${flowHtml}
            ${linkedMetaHtml}
          </div>
          <div class="rd-header-right">
            <div class="rd-header-amount">${row.currency} ${formatCurrency(row.amount || 0)}</div>
            ${!isManual && headerLinkText ? `<div class="rd-header-link"><i class="fa fa-link"></i> ${escapeHtml(headerLinkText)}</div>` : ''}
            <div class="rd-header-actions">
              <button type="button" class="icon-btn rd-save-btn"><i class="fa fa-floppy-disk"></i> Save</button>
              <button type="button" class="icon-btn rd-reset-btn" title="Reset"><i class="fa fa-rotate-left"></i></button>
              <button type="button" class="icon-btn rd-delete-btn" title="Remove"><i class="fa fa-trash"></i></button>
              <button type="button" class="icon-btn rd-toggle-btn" aria-expanded="false"><i class="fa fa-chevron-down"></i></button>
            </div>
          </div>
        </div>
        <div class="rd-entry-details" style="display:none;">
          <div class="rd-detail-grid">
            <div class="rd-detail-column">
              <div class="rd-field-group">
                <label>Contact</label>
                <input type="text" class="rd-input rd-contact" placeholder="Name">
              </div>
              ${linkingBlockHtml}
              ${loanThreadBlockHtml}
            </div>
            <div class="rd-detail-column">
              <div class="rd-field-group">
                <label>Value</label>
                <div class="rd-input-group">
                  <span class="rd-currency-pill">${row.currency}</span>
                  <input type="number" class="rd-input rd-transaction-value" step="0.01" min="0">
                </div>
              </div>
            </div>
            <div class="rd-detail-column">
              <div class="rd-field-group">
                <label>Due Date</label>
                <input type="date" class="rd-input rd-due-date">
              </div>
              <div class="rd-field-group">
                <label>Payment Dates</label>
                <textarea class="rd-input rd-payment-dates" rows="2" placeholder="YYYY-MM-DD"></textarea>
              </div>
            </div>
          </div>
          <div class="rd-feedback"></div>
        </div>
      `;
     list.appendChild(entry);
     bindReceivableRow(entry, baseRow, row);
     if (state.dirty.has(baseRow.line_id)){
       entry.classList.add('rd-row-dirty');
       const fb = entry.querySelector('.rd-feedback');
       if (fb) fb.textContent = 'Unsaved changes';
     }
     if (state.justSavedId === baseRow.line_id){
       entry.classList.add('rd-row-saved');
       const fb = entry.querySelector('.rd-feedback');
       if (fb){
         fb.style.color = '#1a4d2e';
         fb.textContent = 'Saved';
         setTimeout(() => {
           const latest = document.querySelector(`.rd-entry[data-line-id='${baseRow.line_id}'] .rd-feedback`);
           if (latest && latest.textContent === 'Saved') latest.textContent = '';
         }, 2500);
       }
       setTimeout(() => {
         const current = document.querySelector(`.rd-entry[data-line-id='${baseRow.line_id}']`);
         if (current) current.classList.remove('rd-row-saved');
       }, 1200);
        const detail = entry.querySelector('.rd-entry-details');
        const toggleBtn = entry.querySelector('.rd-toggle-btn');
        entry.classList.add('expanded');
        if (detail) detail.style.display = 'block';
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
      }
    });
    state.justSavedId = null;
    renderReceivablePagination(total, page, pageCount, startIndex, endIndex);
    if (statusEl) {
      const suffix = pageCount > 1 ? ` (Page ${page}/${pageCount})` : '';
      statusEl.style.color = '#1a4d2e';
      const cutoffNote = state.initCutoff ? ` since ${state.initCutoff}` : '';
      statusEl.textContent = `Showing ${startIndex}-${endIndex} of ${total} entries${suffix}${cutoffNote}.`;
    }
    refreshReceivableSummary();
    renderReceivableContactGroups();
  }
  function captureReceivableSnapshot(lineId){
    const state = ensureReceivableState();
    const entry = document.querySelector(`.rd-entry[data-line-id='${lineId}']`);
    if (!entry) return null;
    const baseRow = state.rowsMap.get(lineId);
    if (!baseRow) return null;
    const contact = entry.querySelector('.rd-contact')?.value || '';
    const txnValue = toNumeric(entry.querySelector('.rd-transaction-value')?.value);
    const dueDate = entry.querySelector('.rd-due-date')?.value || '';
    const paymentDates = sanitizePaymentDatesInput(entry.querySelector('.rd-payment-dates')?.value || '');
    return {
      contact_name: contact,
      transaction_value: roundToTwo(txnValue),
      due_date: dueDate,
      payment_dates: paymentDates
    };
  }

  function markReceivableRowDirty(lineId, dirty){
    const state = ensureReceivableState();
    const entry = document.querySelector(`.rd-entry[data-line-id='${lineId}']`);
    if (!entry) return;
    const feedback = entry.querySelector('.rd-feedback');
    if (dirty){
      const snapshot = captureReceivableSnapshot(lineId);
      if (snapshot) {
        state.pending.set(lineId, snapshot);
        state.dirty.add(lineId);
      }
      entry.classList.add('rd-row-dirty');
      if (feedback) {
        feedback.style.color = '#1a4d2e';
        feedback.textContent = 'Unsaved changes';
      }
    } else {
      state.pending.delete(lineId);
      state.dirty.delete(lineId);
      entry.classList.remove('rd-row-dirty');
      if (feedback) feedback.textContent = '';
    }
  }

  function collectReceivablePayload(lineId){
    const state = ensureReceivableState();
    const baseRow = state.rowsMap.get(lineId);
    if (!baseRow) return null;
    const snapshot = captureReceivableSnapshot(lineId);
    if (!snapshot) return null;
    const payload = {
      line_id: lineId,
      contact_name: snapshot.contact_name,
      transaction_value: snapshot.transaction_value,
      currency: baseRow.currency,
      due_date: snapshot.due_date || null,
      payment_dates: snapshot.payment_dates
    };
    return { payload, snapshot };
  }

function bindReceivableRow(entry, baseRow, row){
    const state = ensureReceivableState();
    const contactInput = entry.querySelector('.rd-contact');
    const valueInput = entry.querySelector('.rd-transaction-value');
    const dueInput = entry.querySelector('.rd-due-date');
    const payDatesInput = entry.querySelector('.rd-payment-dates');
    const saveBtn = entry.querySelector('.rd-save-btn');
    const resetBtn = entry.querySelector('.rd-reset-btn');
    const deleteBtn = entry.querySelector('.rd-delete-btn');
    const linkSelect = entry.querySelector('.rd-link-select');
    const linkClear = entry.querySelector('.rd-link-clear');
    const linkAddBtn = entry.querySelector('.rd-link-add');
    const linkRemoveBtns = entry.querySelectorAll('.rd-link-remove');
    const threadBlock = entry.querySelector('.rd-loan-thread-block');
    const threadList = threadBlock?.querySelector('.rd-loan-thread-list');
    const threadSelect = threadBlock?.querySelector('.rd-loan-thread-select');
    const threadAmount = threadBlock?.querySelector('.rd-loan-thread-amount');
    const threadAssign = threadBlock?.querySelector('.rd-loan-thread-assign');
    const threadSuggest = threadBlock?.querySelector('.rd-loan-thread-suggest');
    const threadApply = threadBlock?.querySelector('.rd-loan-thread-apply');
    const threadFeedback = threadBlock?.querySelector('.rd-loan-thread-feedback');
    const isBaseFlow = RECEIVABLE_BASE_FLOWS.has(row.flow);
    const toggleBtn = entry.querySelector('.rd-toggle-btn');
    const header = entry.querySelector('.rd-entry-header');
    const detail = entry.querySelector('.rd-entry-details');

    if (contactInput) contactInput.value = row.contact_name || '';
    if (valueInput) valueInput.value = formatAmountInput(row.transaction_value || row.amount || 0);
    if (dueInput) {
      dueInput.value = row.due_date || '';
      dueInput.classList.toggle('rd-overdue', isReceivableOverdue(row));
    }
    if (payDatesInput) payDatesInput.value = (row.payment_dates || []).join('\n');
    if (threadList){
      populateLoanThreadList(threadList, Array.isArray(row.loan_groups) ? row.loan_groups : [], row.currency);
    }
    if (threadSelect){
      threadSelect.disabled = true;
      fetchLoanGroupOptionsForRow(row)
        .then(groups => {
          populateLoanThreadSelect(threadSelect, row, groups);
        })
        .catch(err => {
          setLoanThreadFeedback(threadFeedback, err && err.message ? err.message : 'Unable to load loan threads.', 'error');
        })
        .finally(() => {
          threadSelect.disabled = false;
        });
    }
    const existingSuggestion = state.loanGroupSuggestions.get(baseRow.line_id);
    if (existingSuggestion && threadApply){
      threadApply.style.display = '';
      threadApply.disabled = false;
      const currency = existingSuggestion.currency || row.currency || 'KRW';
      const lines = (existingSuggestion.suggestions || []).map(s => `${s.name || s.loan_group_id}: ${currency} ${formatCurrency(toNumeric(s.proposed_amount || 0))}`);
      if (existingSuggestion.unused_amount && Math.abs(existingSuggestion.unused_amount) > 0.005){
        lines.push(`Unused: ${currency} ${formatCurrency(toNumeric(existingSuggestion.unused_amount || 0))}`);
      }
      setLoanThreadFeedback(threadFeedback, lines.join(' • '));
    } else if (threadApply){
      threadApply.style.display = 'none';
    }

    const handleDirty = () => {
      markReceivableRowDirty(baseRow.line_id, true);
    };

    if (contactInput) contactInput.addEventListener('input', handleDirty);
    if (valueInput) valueInput.addEventListener('input', handleDirty);
    if (dueInput) dueInput.addEventListener('change', () => {
      const simulated = {
        ...row,
        due_date: dueInput.value || ''
      };
      dueInput.classList.toggle('rd-overdue', isReceivableOverdue(simulated));
      handleDirty();
    });
    if (payDatesInput) payDatesInput.addEventListener('input', handleDirty);
    if (saveBtn) saveBtn.addEventListener('click', (e) => { e.stopPropagation(); saveReceivableRow(baseRow.line_id); });
    if (resetBtn) resetBtn.addEventListener('click', (e) => { e.stopPropagation(); resetReceivableRow(baseRow.line_id); });
    if (deleteBtn) deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteReceivableRow(baseRow.line_id, deleteBtn); });
    if (linkSelect) {
      const updateAddState = () => {
        if (linkAddBtn) {
          linkAddBtn.disabled = !(linkSelect.value && linkSelect.value.trim());
        }
      };
      linkSelect.dataset.previousValue = linkSelect.value || '';
      linkSelect.addEventListener('focus', () => {
        linkSelect.dataset.previousValue = linkSelect.value || '';
      });
      linkSelect.addEventListener('change', () => {
        updateAddState();
      });
      updateAddState();
    }
    if (linkAddBtn) {
      linkAddBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!linkSelect) return;
        const raw = linkSelect.value || '';
        if (!raw.trim()) return;
        const val = parseInt(raw, 10);
        if (!Number.isFinite(val)) return;
        const prev = linkSelect.dataset.previousValue || '';
        linkAddBtn.disabled = true;
        linkSelect.disabled = true;
        try {
          await linkReceivableRow(baseRow.line_id, val, row.flow, linkSelect, prev, 'add');
          linkSelect.value = '';
          linkSelect.dataset.previousValue = '';
        } finally {
          linkSelect.disabled = false;
          linkAddBtn.disabled = true;
        }
      });
    }
    if (linkClear) {
      linkClear.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (linkClear.disabled) return;
        if (isBaseFlow) {
          const confirmClear = confirm('Remove all linked transactions from this entry?');
          if (!confirmClear) return;
        }
        linkClear.disabled = true;
        if (linkSelect) linkSelect.disabled = true;
        try {
          await linkReceivableRow(baseRow.line_id, null, row.flow, linkSelect, linkSelect ? (linkSelect.value || '') : '', 'clear');
          if (linkSelect) {
            linkSelect.value = '';
            linkSelect.dataset.previousValue = '';
          }
        } finally {
          if (linkSelect) linkSelect.disabled = false;
          if (linkAddBtn) linkAddBtn.disabled = true;
          linkClear.disabled = false;
        }
      });
    }
    linkRemoveBtns.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const targetId = parseInt(btn.dataset.linkedId || '0', 10);
        if (!targetId) return;
        btn.disabled = true;
        if (linkSelect) linkSelect.disabled = true;
        try {
          await linkReceivableRow(baseRow.line_id, targetId, row.flow, linkSelect, linkSelect ? (linkSelect.value || '') : '', 'remove');
        } finally {
          if (linkSelect) linkSelect.disabled = false;
          if (linkAddBtn) linkAddBtn.disabled = true;
          btn.disabled = false;
        }
      });
    });
    if (threadAssign){
      threadAssign.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!threadSelect || !threadAmount){
          return;
        }
        const groupId = (threadSelect.value || '').trim();
        if (!groupId){
          setLoanThreadFeedback(threadFeedback, 'Select a loan thread first.', 'error');
          return;
        }
        const rawAmount = parseFloat(threadAmount.value || '0');
        if (!Number.isFinite(rawAmount) || rawAmount <= 0){
          setLoanThreadFeedback(threadFeedback, 'Enter an amount greater than zero.', 'error');
          return;
        }
        threadAssign.disabled = true;
        if (threadSuggest) threadSuggest.disabled = true;
        if (threadApply) threadApply.disabled = true;
        setLoanThreadFeedback(threadFeedback, 'Assigning to loan thread…');
        try {
          await postJSON('/accounting/transaction-links', {
            journal_line_id: baseRow.line_id,
            mode: 'append',
            links: [{ loan_group_id: groupId, linked_amount: rawAmount }]
          });
          state.loanGroupSuggestions.delete(baseRow.line_id);
          invalidateLoanGroupCacheForRow(row);
          setLoanThreadFeedback(threadFeedback, 'Assignment saved.', 'success');
          if (threadAmount) threadAmount.value = '';
          if (threadSelect) threadSelect.value = '';
          await loadReceivableData(baseRow.line_id);
        } catch (err){
          console.error(err);
          setLoanThreadFeedback(threadFeedback, err && err.message ? err.message : 'Unable to assign to loan thread.', 'error');
        } finally {
          if (threadAssign) threadAssign.disabled = false;
          if (threadSuggest) threadSuggest.disabled = false;
        }
      });
    }
    if (threadSuggest){
      threadSuggest.addEventListener('click', async (e) => {
        e.stopPropagation();
        threadSuggest.disabled = true;
        if (threadAssign) threadAssign.disabled = true;
        if (threadApply) threadApply.disabled = true;
        setLoanThreadFeedback(threadFeedback, 'Requesting suggestion…');
        try {
          const data = await postJSON('/accounting/allocation/suggest', { journal_line_id: baseRow.line_id });
          if (!data || data.ok === false){
            throw new Error((data && data.error) || 'Unable to fetch suggestion.');
          }
          const suggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
          if (!suggestions.length){
            state.loanGroupSuggestions.delete(baseRow.line_id);
            if (threadApply){
              threadApply.style.display = 'none';
            }
            setLoanThreadFeedback(threadFeedback, data.note || 'No suggestion available right now.', 'error');
          } else {
            state.loanGroupSuggestions.set(baseRow.line_id, data);
            if (threadApply){
              threadApply.style.display = '';
              threadApply.disabled = false;
            }
            const currency = data.currency || row.currency || 'KRW';
            const lines = suggestions.map(s => `${s.name || s.loan_group_id}: ${currency} ${formatCurrency(toNumeric(s.proposed_amount || 0))}`);
            if (data.unused_amount && Math.abs(data.unused_amount) > 0.005){
              lines.push(`Unused: ${currency} ${formatCurrency(toNumeric(data.unused_amount || 0))}`);
            }
            setLoanThreadFeedback(threadFeedback, lines.join(' • '));
          }
        } catch (err){
          console.error(err);
          state.loanGroupSuggestions.delete(baseRow.line_id);
          if (threadApply){
            threadApply.style.display = 'none';
          }
          setLoanThreadFeedback(threadFeedback, err && err.message ? err.message : 'Unable to fetch suggestion.', 'error');
        } finally {
          if (threadSuggest) threadSuggest.disabled = false;
          if (threadAssign) threadAssign.disabled = false;
        }
      });
    }
    if (threadApply){
      threadApply.addEventListener('click', async (e) => {
        e.stopPropagation();
        const suggestion = state.loanGroupSuggestions.get(baseRow.line_id);
        const items = suggestion && Array.isArray(suggestion.suggestions) ? suggestion.suggestions : [];
        if (!items.length){
          setLoanThreadFeedback(threadFeedback, 'Fetch a suggestion before applying.', 'error');
          return;
        }
        threadApply.disabled = true;
        if (threadAssign) threadAssign.disabled = true;
        if (threadSuggest) threadSuggest.disabled = true;
        setLoanThreadFeedback(threadFeedback, 'Applying suggestion…');
        try {
          const links = items.map(s => ({
            loan_group_id: s.loan_group_id,
            linked_amount: s.proposed_amount
          }));
          await postJSON('/accounting/transaction-links', {
            journal_line_id: baseRow.line_id,
            mode: 'replace',
            links
          });
          state.loanGroupSuggestions.delete(baseRow.line_id);
          invalidateLoanGroupCacheForRow(row);
          setLoanThreadFeedback(threadFeedback, 'Suggestion applied.', 'success');
          threadApply.style.display = 'none';
          await loadReceivableData(baseRow.line_id);
        } catch (err){
          console.error(err);
          setLoanThreadFeedback(threadFeedback, err && err.message ? err.message : 'Unable to apply suggestion.', 'error');
          threadApply.disabled = false;
        } finally {
          if (threadAssign) threadAssign.disabled = false;
          if (threadSuggest) threadSuggest.disabled = false;
        }
      });
    }

    const toggle = () => {
      const expanded = entry.classList.toggle('expanded');
      if (detail) detail.style.display = expanded ? 'block' : 'none';
      if (toggleBtn) toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    };
    if (toggleBtn) {
      toggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggle();
      });
    }
    if (header) {
      header.addEventListener('click', (e) => {
        if (e.target.closest('.rd-header-actions')) return;
        toggle();
      });
    }
  }

  function resetReceivableRow(lineId){
    const state = ensureReceivableState();
    state.pending.delete(lineId);
    state.dirty.delete(lineId);
    state.justSavedId = null;
    renderReceivableTable();
    refreshReceivableSummary();
  }

  async function loadReceivableData(highlightId = null){
    const state = ensureReceivableState();
    if (state.loading) return;
    state.loading = true;
    const statusEl = document.getElementById('rd-status');
    if (statusEl) {
      statusEl.style.color = '#1a4d2e';
      statusEl.textContent = 'Loading receivables…';
    }
    try {
      const res = await fetch('/accounting/receivables/data');
      const data = await res.json();
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Unable to load receivables.');
      }
      state.rows = data.rows || [];
      state.savedRows = data.saved_rows || [];
      state.unsavedRows = data.unsaved_rows || [];
      state.contactGroups = data.contact_groups || [];
      state.rowsMap = new Map(state.rows.map(r => [r.line_id, r]));
      state.pending.clear();
      state.dirty.clear();
      state.currencies = data.currencies || [];
      state.summary = data.summary || { receivable: 0, debt: 0, saved: 0, unsaved: 0 };
      state.initCutoff = data.init_cutoff || null;
      state.justSavedId = highlightId || null;
      if (highlightId){
        const highlighted = state.rowsMap.get(highlightId);
        if (highlighted){
          state.viewMode = highlighted.is_saved ? 'saved' : 'unsaved';
          const collection = highlighted.is_saved ? state.savedRows : state.unsavedRows;
          const idx = collection.findIndex(r => r.line_id === highlightId);
          if (idx >= 0){
            const targetPage = Math.floor(idx / (state.pageSize || 50)) + 1;
            if (highlighted.is_saved) state.savedPage = targetPage;
            else state.unsavedPage = targetPage;
          }
        }
      } else if (state.viewMode === 'saved' && !state.savedRows.length && state.unsavedRows.length){
        state.viewMode = 'unsaved';
        state.unsavedPage = 1;
      }
      const validIds = new Set(state.rows.map(r => r.line_id));
      state.loanGroupSuggestions.forEach((_, key) => {
        if (!validIds.has(key)) {
          state.loanGroupSuggestions.delete(key);
        }
      });
      populateReceivableCurrencyFilter();
      renderReceivableTable();
    } catch (err){
      console.error(err);
      if (statusEl){
        statusEl.style.color = '#b22222';
        statusEl.textContent = err && err.message ? err.message : 'Unable to load receivables.';
      }
    } finally {
      state.loading = false;
    }
  }

  async function saveReceivableRow(lineId){
    const state = ensureReceivableState();
    const entry = document.querySelector(`.rd-entry[data-line-id='${lineId}']`);
    if (!entry) return;
    const result = collectReceivablePayload(lineId);
    if (!result) return;
    const { payload } = result;
    const saveBtn = entry.querySelector('.rd-save-btn');
    const feedback = entry.querySelector('.rd-feedback');
    if (saveBtn) saveBtn.disabled = true;
    entry.classList.add('rd-row-saving');
    if (feedback){
      feedback.style.color = '#1a4d2e';
      feedback.textContent = 'Saving…';
    }
    try {
      const res = await fetch('/accounting/receivables/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Failed to save.');
      }
      const updatedRow = data.row;
      state.pending.delete(lineId);
      state.dirty.delete(lineId);
      await loadReceivableData(updatedRow ? updatedRow.line_id : lineId);
      entry.classList.remove('rd-row-saving');
      if (saveBtn) saveBtn.disabled = false;
    } catch (err){
      console.error(err);
      entry.classList.remove('rd-row-saving');
      if (saveBtn) saveBtn.disabled = false;
      if (feedback){
        feedback.style.color = '#b22222';
        feedback.textContent = err && err.message ? err.message : 'Save failed';
      }
    }
  }

  async function linkReceivableRow(lineId, linkedLineId, flow, control, previousValue, action = 'set'){
    const payload = { line_id: lineId, linked_line_id: linkedLineId, link_kind: flow, action };
    const entry = document.querySelector(`.rd-entry[data-line-id='${lineId}']`);
    const feedback = entry?.querySelector('.rd-feedback');
    const prior = previousValue !== undefined ? previousValue : (control ? control.value : '');
    if (control) control.disabled = true;
    if (feedback){
      feedback.style.color = '#1a4d2e';
      if (action === 'remove' || action === 'clear') {
        feedback.textContent = action === 'clear' ? 'Clearing links…' : 'Removing link…';
      } else {
        feedback.textContent = 'Linking…';
      }
    }
    try {
      const res = await fetch('/accounting/receivables/link', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data || data.ok === false){
        throw new Error((data && data.error) || 'Unable to update link.');
      }
      await loadReceivableData(lineId);
    } catch (err){
      console.error(err);
      if (feedback){
        feedback.style.color = '#b22222';
        feedback.textContent = err && err.message ? err.message : 'Unable to update link.';
      }
      if (control){
        control.value = prior || '';
      }
    } finally {
      if (control) control.disabled = false;
    }
  }

  async function deleteReceivableRow(lineId, triggerBtn){
    if (!confirm('Remove this transaction from the receivables view?')) return;
    const entry = document.querySelector(`.rd-entry[data-line-id='${lineId}']`);
    const feedback = entry?.querySelector('.rd-feedback');
    if (triggerBtn) triggerBtn.disabled = true;
    if (feedback){
      feedback.style.color = '#1a4d2e';
      feedback.textContent = 'Removing…';
    }
    try {
      const res = await fetch('/accounting/receivables/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || ''
        },
        body: JSON.stringify({ line_id: lineId })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || (data && data.ok === false)){
        throw new Error((data && data.error) || 'Unable to remove entry.');
      }
      await loadReceivableData();
    } catch (err){
      console.error(err);
      if (feedback){
        feedback.style.color = '#b22222';
        feedback.textContent = err && err.message ? err.message : 'Unable to remove entry.';
      }
      if (triggerBtn) triggerBtn.disabled = false;
    } finally {
      if (triggerBtn) triggerBtn.disabled = false;
      if (feedback && feedback.textContent === 'Removing…') feedback.textContent = '';
    }
  }

  function initReceivableDebtUI(){
    const state = ensureReceivableState();
    if (state.initialized){
      populateReceivableCurrencyFilter();
      renderReceivableTable();
      refreshReceivableSummary();
      return;
    }
    state.initialized = true;
    const typeFilter = document.getElementById('rd-type-filter');
    const currencyFilter = document.getElementById('rd-currency-filter');
    const refreshBtn = document.getElementById('rd-refresh-btn');
    if (typeFilter) typeFilter.addEventListener('change', () => {
      state.filters.type = (typeFilter.value || 'all').toLowerCase();
      state.savedPage = 1;
      state.unsavedPage = 1;
      renderReceivableTable();
    });
    if (currencyFilter) currencyFilter.addEventListener('change', () => {
      state.filters.currency = (currencyFilter.value || '').toUpperCase();
      state.savedPage = 1;
      state.unsavedPage = 1;
      renderReceivableTable();
    });
    if (refreshBtn) refreshBtn.addEventListener('click', () => loadReceivableData());
    const addBtn = document.getElementById('rd-add-entry-btn');
    if (addBtn) addBtn.addEventListener('click', () => {
      setupReceivableCreateModal();
      openReceivableCreateModal();
    });
    const tabSaved = document.getElementById('rd-tab-saved');
    if (tabSaved) tabSaved.addEventListener('click', () => {
      state.viewMode = 'saved';
      state.savedPage = 1;
      updateReceivableTabButtons();
      renderReceivableTable();
    });
    const tabUnsaved = document.getElementById('rd-tab-unsaved');
    if (tabUnsaved) tabUnsaved.addEventListener('click', () => {
      state.viewMode = 'unsaved';
      state.unsavedPage = 1;
      updateReceivableTabButtons();
      renderReceivableTable();
    });
    const cardsBtn = document.getElementById('rd-contact-view-cards');
    if (cardsBtn) cardsBtn.addEventListener('click', () => {
      state.contactViewMode = 'cards';
      updateContactViewControls();
      renderReceivableContactGroups();
    });
    const listBtn = document.getElementById('rd-contact-view-list');
    if (listBtn) listBtn.addEventListener('click', () => {
      state.contactViewMode = 'list';
      updateContactViewControls();
      renderReceivableContactGroups();
    });
    const sortSelect = document.getElementById('rd-group-sort-select');
    if (sortSelect) sortSelect.addEventListener('change', () => {
      state.contactSort = (sortSelect.value || 'alpha');
      renderReceivableContactGroups();
    });
    setupReceivableCreateModal();
    loadReceivableData();
  }

  window.initReceivableDebtUI = initReceivableDebtUI;

  function getFolderIconClass(id){
    const el = document.querySelector(`.folder-item[data-id='${id}'] .folder-icon i`);
    if (!el) return 'fa-folder';
    const cls = Array.from(el.classList).filter(c => c.startsWith('fa-') && c !== 'fa');
    return cls[0] || 'fa-folder';
  }

  function computeFolderInitialSum(catId){
    const accsByCat = (window.ACC_BOOT && window.ACC_BOOT.accountsByCategory) || {};
    const balances = (window.ACC_BOOT && window.ACC_BOOT.openingBalances) || {};
    const list = accsByCat[catId] || [];
    let sum = 0;
    list.forEach(a => { if (a && a.id in balances) { const v = parseFloat(balances[a.id] || 0) || 0; sum += v; } });
    return sum;
  }

  function ensureTbUiPrefs(){
    if (!window.TB_UI_PREFS) {
      window.TB_UI_PREFS = {};
      try {
        window.TB_UI_PREFS.summaryVisible = localStorage.getItem('tbSummaryVisible') === '1';
      } catch (_) {
        window.TB_UI_PREFS.summaryVisible = false;
      }
      window.TB_UI_PREFS.summaryReady = false;
    }
    if (typeof window.TB_UI_PREFS.summaryVisible !== 'boolean') {
      window.TB_UI_PREFS.summaryVisible = false;
    }
    if (typeof window.TB_UI_PREFS.summaryReady !== 'boolean') {
      window.TB_UI_PREFS.summaryReady = false;
    }
    return window.TB_UI_PREFS;
  }

  function applySummaryVisibility(){
    const state = ensureTbUiPrefs();
    const summary = document.getElementById('tb-summary');
    const btn = document.getElementById('tb-summary-toggle');
    if (summary) {
      summary.style.display = (state.summaryReady && state.summaryVisible) ? 'block' : 'none';
    }
    if (btn) {
      btn.disabled = !state.summaryReady;
      btn.setAttribute('aria-pressed', (state.summaryReady && state.summaryVisible) ? 'true' : 'false');
      if (!state.summaryReady) {
        btn.innerHTML = '<i class="fa fa-eye"></i> Loading...';
      } else if (state.summaryVisible) {
        btn.innerHTML = '<i class="fa fa-eye-slash"></i> Hide Overview';
      } else {
        btn.innerHTML = '<i class="fa fa-eye"></i> Show Overview';
      }
    }
  }

  function setSummaryReady(flag){
    const state = ensureTbUiPrefs();
    state.summaryReady = !!flag;
    applySummaryVisibility();
  }

  function setSummaryVisible(flag){
    const state = ensureTbUiPrefs();
    state.summaryVisible = !!flag;
    try { localStorage.setItem('tbSummaryVisible', state.summaryVisible ? '1' : '0'); } catch (_){}
    applySummaryVisibility();
  }

  function initSummaryToggle(){
    ensureTbUiPrefs();
    const btn = document.getElementById('tb-summary-toggle');
    if (btn && btn.dataset.bound !== '1') {
      btn.dataset.bound = '1';
      btn.addEventListener('click', () => {
        const state = ensureTbUiPrefs();
        if (!state.summaryReady) return;
        setSummaryVisible(!state.summaryVisible);
      });
    }
    applySummaryVisibility();
  }

  function renderTrialSummary(){
    const cards = document.getElementById('tb-summary-cards'); if (!cards) return;
    cards.innerHTML = '';
    refreshSummaryInitializationDate();
    attachTrialResetHandler();
    const catsData = (window.ACC_BOOT && window.ACC_BOOT.categoriesData) || [];
    const accsByCat = (window.ACC_BOOT && window.ACC_BOOT.accountsByCategory) || {};
    const nameMap = (window.ACC_BOOT && window.ACC_BOOT.categoryMap) || {};
    const balances = (window.ACC_BOOT && window.ACC_BOOT.openingBalances) || {};
    const balanceDates = (window.ACC_BOOT && window.ACC_BOOT.openingBalanceDates) || {};
    const groupMap = { asset:[], liability:[], equity:[], expense:[], income:[] };
    catsData.forEach(c => {
      const g = (window.TB_STATE && window.TB_STATE.categoryGroups && window.TB_STATE.categoryGroups[c.id]) || (c.tb_group || '');
      if (g && groupMap[g]) groupMap[g].push(c.id);
    });
    let renderedSection = false;
    TB_GROUPS.forEach(g => {
      const ids = groupMap[g.key] || [];
      if (!ids.length) { return; }
      renderedSection = true;
      const section = document.createElement('div');
      section.className = 'tb-folder-section';
      const folderCount = ids.length;
      const totalAccounts = ids.reduce((sum, cid) => sum + ((accsByCat[cid] || []).length || 0), 0);
      const sectionHead = document.createElement('div');
      sectionHead.className = 'tb-folder-section-head';
      sectionHead.innerHTML = `<div class=\"tb-folder-chip\"><i class=\"fa ${g.icon}\"></i> ${g.title}</div>
        <div class=\"tb-folder-section-meta\">
          <span><i class=\"fa fa-folder-open\"></i> ${folderCount} ${folderCount === 1 ? 'Folder' : 'Folders'}</span>
          <span><i class=\"fa fa-layer-group\"></i> ${totalAccounts} ${totalAccounts === 1 ? 'Account' : 'Accounts'}</span>
        </div>`;
      section.appendChild(sectionHead);
      const grid = document.createElement('div');
      grid.className = 'tb-folder-grid';
      ids.forEach(cid => {
        const fname = nameMap[cid] || 'Folder';
        const folderAccounts = accsByCat[cid] || [];
        const savedCount = folderAccounts.filter(a => a && (a.id in balances)).length;
        let statusClass = 'missing';
        let statusText = 'Missing data';
        if (!folderAccounts.length) {
          statusClass = 'missing';
          statusText = 'No accounts';
        } else if (savedCount === folderAccounts.length) {
          statusClass = 'complete';
          statusText = 'Ready';
        } else if (savedCount > 0) {
          statusClass = 'partial';
          statusText = 'In progress';
        }
        const card = document.createElement('div');
        card.className = 'tb-folder-card';
        const color = (window.folderColorMap && window.folderColorMap[cid]) ? window.folderColorMap[cid] : g.color;
        const folderIcon = getFolderIconClass(cid);
        const folderSum = computeFolderInitialSum(cid);
        card.innerHTML = `<div class=\"tb-folder-card-head\">
            <div class=\"tb-folder-identity\">
              <div style=\"width:32px;height:32px;border-radius:12px;background:${color};display:flex;align-items:center;justify-content:center;color:#fff;\"><i class=\"fa ${folderIcon}\"></i></div>
              <div>
                <div class=\"tb-folder-name\" style=\"font-weight:600;\">${escapeHtml(fname)}</div>
                <div class=\"tb-folder-chip subtle\">${g.title}</div>
              </div>
            </div>
            <div class=\"tb-folder-total\">${formatCurrency(folderSum)}</div>
          </div>
          <div class=\"tb-folder-meta\">
            <div><strong>${folderAccounts.length || 0}</strong> ${folderAccounts.length === 1 ? 'account' : 'accounts'}</div>
            <div><strong>${savedCount}</strong> saved</div>
            <div class=\"tb-folder-status ${statusClass}\">${statusText}</div>
          </div>
          <button type=\"button\" class=\"tb-folder-toggle\"><span>View accounts</span><i class=\"fa fa-chevron-down\"></i></button>`;
        const accountList = document.createElement('div');
        accountList.className = 'tb-folder-accounts';
        if (!folderAccounts.length) {
          const empty = document.createElement('div');
          empty.className = 'tb-folder-empty-note';
          empty.textContent = 'No accounts linked to this folder yet.';
          accountList.appendChild(empty);
        } else {
          folderAccounts.forEach(a => {
            const opening = (a && (a.id in balances)) ? balances[a.id] : null;
            const savedDate = balanceDates[a.id] ? formatDisplayDate(balanceDates[a.id]) : '';
            const row = document.createElement('div');
            row.className = 'tb-account-row' + (opening != null ? '' : ' missing');
            const noteText = opening != null ? (savedDate ? `Saved ${savedDate}` : 'Saved opening balance') : 'Opening balance not set';
            row.innerHTML = `<div>
                <div class=\"tb-account-name\">${escapeHtml(a.name || 'Account')}</div>
                <div class=\"tb-account-note\">${noteText}</div>
              </div>
              <div class=\"tb-account-amount\">${opening != null ? formatCurrency(opening) : '—'}</div>`;
            accountList.appendChild(row);
          });
        }
        card.appendChild(accountList);
        const toggle = card.querySelector('.tb-folder-toggle');
        if (toggle) {
          toggle.addEventListener('click', () => {
            const isOpen = card.classList.toggle('open');
            const label = toggle.querySelector('span');
            const icon = toggle.querySelector('i');
            if (label) label.textContent = isOpen ? 'Hide accounts' : 'View accounts';
            if (icon) {
              icon.classList.toggle('fa-chevron-up', isOpen);
              icon.classList.toggle('fa-chevron-down', !isOpen);
            }
          });
        }
        grid.appendChild(card);
      });
      section.appendChild(grid);
      cards.appendChild(section);
    });
    if (!renderedSection) {
      const empty = document.createElement('div');
      empty.className = 'tb-folder-section-empty';
      empty.textContent = 'Assign folders to balance groups to see folder totals here.';
      cards.appendChild(empty);
    }
    applySummaryVisibility();
  }

  function initMonthlyTrialUI(){
    const monthSelect = document.getElementById('tb-month-select');
    const clearBtn = document.getElementById('tb-month-clear');
    const firstInput = document.getElementById('tb-first-month');
    const firstSave = document.getElementById('tb-first-month-save');
    const firstStatus = document.getElementById('tb-first-month-status');
    if (!monthSelect || !clearBtn) return;
    // Populate month options based on initialization date; fallback to last 12 months
    const initIso = (window.ACC_BOOT && window.ACC_BOOT.tbInitializedOn) ? window.ACC_BOOT.tbInitializedOn : '';
    const pad = (n) => (n < 10 ? '0' + n : '' + n);
    const now = new Date(); now.setDate(1);
    let startDate = null;
    if (initIso) {
      const dt = new Date(initIso);
      if (!isNaN(dt.getTime())) { dt.setDate(1); startDate = dt; }
    }
    if (!startDate || startDate > now) {
      // fallback to last 12 months ending this month
      startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);
    }
    const opts = [];
    for (let d = new Date(startDate.getTime()); d <= now; d.setMonth(d.getMonth() + 1)){
      const ym = `${d.getFullYear()}-${pad(d.getMonth() + 1)}`;
      const label = d.toLocaleString(undefined, { month:'long', year:'numeric' });
      opts.push(`<option value="${ym}">${label}</option>`);
    }
    monthSelect.innerHTML = '<option value="">Select month…</option>' + opts.join('');
    monthSelect.disabled = false;
    const render = () => {
      const v = monthSelect.value; // format YYYY-MM
      renderMonthlyTrialBalance(v);
    };
    monthSelect.addEventListener('change', render);
    clearBtn.addEventListener('click', () => { monthSelect.value = ''; renderMonthlyTrialBalance(''); });
    const prettyMonth = (ym) => {
      if (!ym) return '';
      try {
        const [y, m] = ym.split('-');
        return new Date(parseInt(y,10), parseInt(m,10)-1, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
      } catch (_) { return ym; }
    };
    const applyFirstMonthState = (ym) => {
      if (!firstInput || !firstSave) return;
      if (ym) {
        firstInput.value = ym;
        firstInput.disabled = true;
        firstSave.disabled = true;
        if (firstStatus) {
          firstStatus.textContent = `Locked to ${prettyMonth(ym)}`;
        }
        firstInput.title = 'First month is locked. Contact an admin to change it.';
        firstSave.title = 'First month already saved';
      } else {
        firstInput.disabled = false;
        firstSave.disabled = false;
        if (firstStatus) firstStatus.textContent = '';
        firstInput.title = '';
        firstSave.title = '';
      }
    };
    // Seed first TB month from boot and apply lock if present
    try { if (window.ACC_BOOT && window.ACC_BOOT.tbFirstMonth) { applyFirstMonthState(window.ACC_BOOT.tbFirstMonth); } } catch(_){ }
    if (firstSave && firstInput){
      firstSave.addEventListener('click', async () => {
        const ym = (firstInput.value || '').trim();
        if (!ym) return;
        try{
          const res = await fetch('/accounting/tb/set_first_month', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' }, body: JSON.stringify({ ym }) });
          if (res.ok){ try { window.ACC_BOOT.tbFirstMonth = ym; } catch(_){}; applyFirstMonthState(ym); if (monthSelect && monthSelect.value) render(); }
        }catch(e){ console.error(e); }
      });
    }
  }

    function renderMonthlyTrialBalance(monthStr){
      const box = document.getElementById('tb-monthly-results'); if (!box) return;
      if (!monthStr){
        box.innerHTML = '<div style="font-size:13px;color:#1a4d2e;opacity:.8;">Select a month to view your trial balance.</div>';
        return;
      }
      const [y, m] = monthStr.split('-');
      const monthName = (function(){ try { return new Date(parseInt(y,10), parseInt(m,10)-1, 1).toLocaleString(undefined,{month:'long', year:'numeric'}); } catch(_) { return monthStr; } })();
      // Fetch monthly TB from server
    const ccySel = document.getElementById('tb-ccy-select');
    const ccy = ccySel ? (ccySel.value || '') : '';
    const balanceContext = { month: monthStr, monthName, currency: ccy };
    const url = ccy ? `/accounting/tb/monthly?ym=${encodeURIComponent(monthStr)}&ccy=${encodeURIComponent(ccy)}` : `/accounting/tb/monthly?ym=${encodeURIComponent(monthStr)}`;
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (!data || data.ok === false) {
          const errMsg = (data && data.error) || 'Unable to load trial balance.';
          box.innerHTML = `<div style="color:#b22222;">${errMsg}</div>`;
          return;
        }
        if (data.initialized_on) {
          const state = ensureTbState();
          state.initialDate = data.initialized_on;
          if (window.ACC_BOOT) {
            window.ACC_BOOT.tbInitializedOn = data.initialized_on;
          }
          refreshSummaryInitializationDate();
        }
        if (data.message && data.groups) {
          const allEmpty = Object.keys(data.groups).every(k => !data.groups[k] || !data.groups[k].length);
          if (allEmpty) {
            try {
              if (typeof renderBalanceSheetFromMonthly === 'function') {
                renderBalanceSheetFromMonthly(data, balanceContext);
              } else {
                const state = ensureBalanceState();
                state.latestFetch = { data, context: balanceContext };
              }
            } catch (err) { console.error(err); }
            box.innerHTML = `<div style="font-size:13px;color:#1a4d2e;opacity:.8;">${data.message}</div>`;
            return;
          }
        }
        try {
          if (typeof renderBalanceSheetFromMonthly === 'function') {
            renderBalanceSheetFromMonthly(data, balanceContext);
          } else {
            const state = ensureBalanceState();
            state.latestFetch = { data, context: balanceContext };
          }
        } catch (err) { console.error(err); }
        const table = document.createElement('div');
        table.style.cssText = 'border:1px solid #eef3ee;border-radius:10px;overflow:hidden;';
        const rowStyle = 'display:grid;grid-template-columns: 120px 1fr 120px 120px 120px 120px 120px;gap:8px;align-items:center;padding:8px 10px;';
        const header = document.createElement('div');
        header.style.cssText = rowStyle + 'background:#f8fff8;font-weight:700;color:#1a4d2e;';
        header.innerHTML = '<div>Group</div><div>Folder</div><div style="text-align:right;">B/D</div><div style="text-align:right;">Period Debit</div><div style="text-align:right;">Period Credit</div><div style="text-align:right;">Net</div><div style="text-align:right;">Balance</div>';
        table.appendChild(header);
        const multiCurrency = !ccy;
        let grandCurrencyMap = multiCurrency ? new Map() : null;
        TB_GROUPS.forEach(g => {
          const items = (data && data.groups && data.groups[g.key]) || [];
          let groupCurrencyMap = multiCurrency ? new Map() : null;
          // Rows per folder
          items.forEach(it => {
            const row = document.createElement('div');
            row.style.cssText = rowStyle + 'border-top:1px solid #f1f4f1; cursor:pointer;';
            const pdeb = toNumeric(it.period_debit || 0);
            const pcred = toNumeric(it.period_credit || 0);
            const pnet = (it.period_net != null ? toNumeric(it.period_net) : (pdeb - pcred));
            const itemCurrencyMap = multiCurrency ? aggregateAccountsByCurrency(it.accounts || []) : null;
            if (multiCurrency) {
              groupCurrencyMap = mergeCurrencyMaps(groupCurrencyMap, itemCurrencyMap);
              grandCurrencyMap = mergeCurrencyMaps(grandCurrencyMap, itemCurrencyMap);
            }
            const folderName = escapeHtml(it.category_name || 'Folder');
            row.innerHTML = `<div>${g.title}</div>
                             <div>${folderName}</div>
                             <div style=\"text-align:right;\">${multiCurrency ? formatCurrencyByMap(itemCurrencyMap, 'bd', it.bd) : formatCurrency(it.bd || 0)}</div>
                             <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(itemCurrencyMap, 'period_debit', pdeb) : formatCurrency(pdeb)}</div>
                             <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(itemCurrencyMap, 'period_credit', pcred) : formatCurrency(pcred)}</div>
                             <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(itemCurrencyMap, 'period_net', pnet) : formatCurrency(pnet)}</div>
                             <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(itemCurrencyMap, 'balance', it.balance) : formatCurrency(it.balance || 0)}</div>`;
            table.appendChild(row);

            // Details: accounts within folder
            const details = document.createElement('div');
            details.style.cssText = 'display:none; padding:4px 10px 10px 32px; border-top:1px dashed #edf5ed;';
            // Header for accounts
            const accHeader = document.createElement('div');
            accHeader.style.cssText = 'display:grid;grid-template-columns: 1fr 100px 100px 100px 100px 100px; gap:8px; font-weight:700; color:#1a4d2e;';
            accHeader.innerHTML = '<div>Account</div><div style="text-align:right;">B/D</div><div style="text-align:right;">Period Dr</div><div style="text-align:right;">Period Cr</div><div style="text-align:right;">Net</div><div style="text-align:right;">Balance</div>';
            details.appendChild(accHeader);
            (it.accounts || []).forEach(a => {
              const accRow = document.createElement('div');
              accRow.style.cssText = 'display:grid;grid-template-columns: 1fr 100px 100px 100px 100px 100px; gap:8px;';
              const apnet = (a.period_net != null ? toNumeric(a.period_net) : (toNumeric(a.period_debit || 0) - toNumeric(a.period_credit || 0)));
              accRow.innerHTML = `<div>${escapeHtml(a.name)}</div>
                                  <div style=\"text-align:right;\">${formatCurrency(a.bd || 0)}</div>
                                  <div style="text-align:right;\">${formatCurrency(a.period_debit || 0)}</div>
                                  <div style="text-align:right;\">${formatCurrency(a.period_credit || 0)}</div>
                                  <div style=\"text-align:right;\">${formatCurrency(apnet)}</div>
                                  <div style="text-align:right;\">${formatCurrency(a.balance || 0)}</div>`;
              details.appendChild(accRow);
            });
            table.appendChild(details);
            row.addEventListener('click', () => {
              const open = details.style.display === 'block';
              details.style.display = open ? 'none' : 'block';
            });
          });
          // Group total row at end
          const tot = (data && data.totals && data.totals[g.key]) || { bd:0, balance:0, period_debit:0, period_credit:0, period_net:0 };
          const totalRow = document.createElement('div');
          totalRow.style.cssText = rowStyle + 'border-top:2px solid #e3eee3;background:#f9fff9;font-weight:700;';
          const totNet = (tot.period_net != null ? toNumeric(tot.period_net) : (toNumeric(tot.period_debit || 0) - toNumeric(tot.period_credit || 0)));
          totalRow.innerHTML = `<div>${g.title}</div>
                                <div>Total</div>
                                <div style=\"text-align:right;\">${multiCurrency ? formatCurrencyByMap(groupCurrencyMap, 'bd', tot.bd) : formatCurrency(tot.bd || 0)}</div>
                                <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(groupCurrencyMap, 'period_debit', tot.period_debit) : formatCurrency(tot.period_debit || 0)}</div>
                                <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(groupCurrencyMap, 'period_credit', tot.period_credit) : formatCurrency(tot.period_credit || 0)}</div>
                                <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(groupCurrencyMap, 'period_net', totNet) : formatCurrency(totNet)}</div>
                                <div style=\"text-align:right;\">${multiCurrency ? formatCurrencyByMap(groupCurrencyMap, 'balance', tot.balance) : formatCurrency(tot.balance || 0)}</div>`;
          table.appendChild(totalRow);
        });
        // Grand totals row at end
        const gtot = (data && data.grand_totals) || { bd:0, balance:0, period_debit:0, period_credit:0, period_net:0 };
        const grandRow = document.createElement('div');
        grandRow.style.cssText = rowStyle + 'border-top:3px double #dfeade;background:#f3fff3;font-weight:800;';
        const grandNet = (gtot.period_net != null ? toNumeric(gtot.period_net) : (toNumeric(gtot.period_debit || 0) - toNumeric(gtot.period_credit || 0)));
        grandRow.innerHTML = `<div></div>
                              <div>Grand Total</div>
                              <div style=\"text-align:right;\">${multiCurrency ? formatCurrencyByMap(grandCurrencyMap, 'bd', gtot.bd) : formatCurrency(gtot.bd || 0)}</div>
                              <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(grandCurrencyMap, 'period_debit', gtot.period_debit) : formatCurrency(gtot.period_debit || 0)}</div>
                              <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(grandCurrencyMap, 'period_credit', gtot.period_credit) : formatCurrency(gtot.period_credit || 0)}</div>
                              <div style="text-align:right;\">${multiCurrency ? formatCurrencyByMap(grandCurrencyMap, 'period_net', grandNet) : formatCurrency(grandNet)}</div>
                              <div style=\"text-align:right;\">${multiCurrency ? formatCurrencyByMap(grandCurrencyMap, 'balance', gtot.balance) : formatCurrency(gtot.balance || 0)}</div>`;
        table.appendChild(grandRow);
        box.innerHTML = '';
        const heading = document.createElement('div');
        heading.style.cssText = 'font-weight:700;color:#1a4d2e;margin-bottom:8px;';
        heading.textContent = `Trial Balance — ${monthName}`;
        box.appendChild(heading);
        box.appendChild(table);
        const foot = document.createElement('div');
        foot.style.cssText = 'font-size:12px;color:#1a4d2e;opacity:.75;margin-top:6px;';
        foot.textContent = 'Period columns reflect activity within the month; Balance is as-of month end.';
        box.appendChild(foot);
        if (data.message) {
          const note = document.createElement('div');
          note.style.cssText = 'font-size:12px;color:#1a4d2e;opacity:.65;margin-top:4px;';
          note.textContent = data.message;
          box.appendChild(note);
        }
      })
      .catch(err => {
        console.error(err);
        box.innerHTML = '<div style="color:#b22222;">Failed to load monthly trial balance.</div>';
      });
  }

  const JOURNAL_STATE = {
    entries: [],
    byId: new Map(),
    page: 1,
    pages: 1,
    total: 0,
    perPage: 25,
    filters: {},
    selectedId: null,
    loading: false,
    loaded: false
  };
  const JOURNAL_ACCOUNT_INDEX = (() => {
    const list = (window.ACC_BOOT && window.ACC_BOOT.allAccounts) || [];
    const map = new Map();
    list.forEach(acc => {
      if (acc && acc.name) {
        map.set(acc.name.trim().toLowerCase(), acc.id);
      }
    });
    return { list, map };
  })();

  function escapeHtml(value){
    return String(value ?? '').replace(/[&<>"']/g, ch => {
      switch (ch){
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  function setJournalFeedback(message, tone='info'){
    const el = document.getElementById('journal-feedback');
    if (!el) return;
    if (!message){
      el.style.display = 'none';
      el.textContent = '';
      el.dataset.tone = '';
      return;
    }
    el.style.display = 'block';
    el.textContent = message;
    el.dataset.tone = tone;
  }

  function getJournalFilters(){
    const filters = {};
    const search = document.getElementById('journal-search');
    const start = document.getElementById('journal-start');
    const end = document.getElementById('journal-end');
    const account = document.getElementById('journal-account');
    if (search && search.value.trim()) filters.q = search.value.trim();
    if (start && start.value) filters.start = start.value;
    if (end && end.value) filters.end = end.value;
    if (account && account.value) filters.account_id = account.value;
    return filters;
  }

  async function loadJournalEntries(page=1){
    if (JOURNAL_STATE.loading) return;
    JOURNAL_STATE.loading = true;
    const table = document.getElementById('journal-table');
    if (table) table.innerHTML = '<div class="journal-placeholder">Loading journal entries…</div>';
    const filters = getJournalFilters();
    JOURNAL_STATE.filters = filters;
    const params = new URLSearchParams();
    Object.entries(filters).forEach(([k,v]) => { if (v) params.set(k, v); });
    params.set('page', String(page));
    params.set('per_page', String(JOURNAL_STATE.perPage));
    try {
      const res = await fetch(`/accounting/journal/list?${params.toString()}`);
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok){
        throw new Error(data.error || 'Failed to load journal entries.');
      }
      JOURNAL_STATE.entries = data.entries || [];
      JOURNAL_STATE.byId = new Map(JOURNAL_STATE.entries.map(e => [e.id, e]));
      JOURNAL_STATE.page = data.page || page;
      JOURNAL_STATE.pages = data.pages || 1;
      JOURNAL_STATE.total = data.total || JOURNAL_STATE.entries.length;
      JOURNAL_STATE.loaded = true;
      if (!JOURNAL_STATE.selectedId || !JOURNAL_STATE.byId.has(JOURNAL_STATE.selectedId)){
        JOURNAL_STATE.selectedId = null;
        renderJournalEditor(null);
      }
      renderJournalTable(JOURNAL_STATE.entries);
      renderJournalPagination(JOURNAL_STATE.page, JOURNAL_STATE.pages, JOURNAL_STATE.total);
      setJournalFeedback('', 'info');
    } catch (err){
      console.error(err);
      if (table) table.innerHTML = '<div class="journal-placeholder">Failed to load journal entries.</div>';
      const pag = document.getElementById('journal-pagination'); if (pag) pag.innerHTML = '';
      setJournalFeedback(err && err.message ? err.message : 'Failed to load journal entries.', 'error');
    } finally {
      JOURNAL_STATE.loading = false;
    }
  }

  function renderJournalTable(entries){
    const table = document.getElementById('journal-table');
    if (!table) return;
    if (!entries || !entries.length){
      table.innerHTML = '<div class="journal-placeholder">No journal entries found for these filters.</div>';
      return;
    }
    const prevScroll = table.scrollTop;
    let html = '<div class="journal-row journal-header"><div>Date</div><div>Description</div><div style="text-align:right;">Debits</div><div style="text-align:right;">Credits</div><div style="text-align:center;">Lines</div><div style="text-align:right;">Actions</div></div>';
    entries.forEach(entry => {
      const active = JOURNAL_STATE.selectedId === entry.id ? ' active' : '';
      const dateLabel = escapeHtml(entry.date_iso || entry.date || '');
      const desc = escapeHtml(entry.description || '');
      const ref = entry.reference ? `<div class="journal-ref">Ref: ${escapeHtml(entry.reference)}</div>` : '';
      html += `<div class="journal-row${active}" data-id="${entry.id}">
                <div class="journal-cell date">${dateLabel}</div>
                <div class="journal-cell desc"><div>${desc || '(No description)'}</div>${ref}</div>
                <div class="journal-cell amount">${formatCurrency(entry.debit_total || 0)}</div>
                <div class="journal-cell amount">${formatCurrency(entry.credit_total || 0)}</div>
                <div class="journal-cell lines" style="text-align:center;">${entry.line_count || 0}</div>
                <div class="journal-cell actions">
                  <button type="button" class="icon-btn journal-delete-btn" data-id="${entry.id}" title="Actions"><i class="fa fa-ellipsis-vertical"></i></button>
                </div>
              </div>`;
    });
    table.innerHTML = html;
    table.scrollTop = prevScroll;
    table.querySelectorAll('.journal-row[data-id]').forEach(row => {
      const id = parseInt(row.dataset.id || '0', 10);
      row.addEventListener('click', () => openJournalEditor(id));
    });
    // Triple-dot actions menu (Delete)
    table.querySelectorAll('.journal-delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = parseInt(btn.dataset.id || '0', 10);
        document.querySelectorAll('.journal-actions-menu').forEach(m => m.remove());
        const rect = btn.getBoundingClientRect();
        const menu = document.createElement('div');
        menu.className = 'journal-actions-menu';
        menu.style.position = 'fixed';
        menu.style.top = `${Math.round(rect.bottom + 6)}px`;
        const maxLeft = Math.max(8, Math.min(rect.left, window.innerWidth - 180));
        menu.style.left = `${Math.round(maxLeft)}px`;
        menu.style.background = '#fff';
        menu.style.border = '1px solid #e6f3e6';
        menu.style.borderRadius = '10px';
        menu.style.padding = '8px';
        menu.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
        menu.style.zIndex = '1000';
        menu.innerHTML = `
          <button type="button" class="icon-btn" data-action="delete" style="background:#fff;color:#b22222;border:1px solid #f1c1c1;">Delete</button>
        `;
        document.body.appendChild(menu);
        const onAway = (ev) => {
          if (!menu.contains(ev.target) && ev.target !== btn){
            menu.remove();
            document.removeEventListener('click', onAway, true);
          }
        };
        document.addEventListener('click', onAway, true);
        menu.querySelector('[data-action="delete"]').addEventListener('click', (ev) => {
          ev.preventDefault(); ev.stopPropagation();
          menu.remove();
          deleteJournalEntry(id);
        });
      });
    });
  }

  async function deleteJournalEntry(entryId){
    if (!entryId) return;
    if (!confirm('Delete this journal entry? This cannot be undone.')) return;
    try {
      const res = await fetch(`/accounting/journal/delete/${entryId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' },
        body: JSON.stringify({})
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok){
        throw new Error(data.error || 'Failed to delete journal entry.');
      }
      JOURNAL_STATE.byId.delete(entryId);
      JOURNAL_STATE.entries = JOURNAL_STATE.entries.filter(e => e.id !== entryId);
      if (JOURNAL_STATE.selectedId === entryId){
        JOURNAL_STATE.selectedId = null;
        renderJournalEditor(null);
      }
      renderJournalTable(JOURNAL_STATE.entries);
      loadJournalEntries(JOURNAL_STATE.page);
      setJournalFeedback('Entry deleted.', 'success');
    } catch (err){
      console.error(err);
      setJournalFeedback(err && err.message ? err.message : 'Failed to delete entry.', 'error');
    }
  }

  function renderJournalPagination(page, pages, total){
    const container = document.getElementById('journal-pagination');
    if (!container) return;
    if (!pages || pages <= 1){
      const label = total === 1 ? '1 entry' : `${total} entries`;
      container.innerHTML = `<span class="journal-page-info">${label}</span>`;
      return;
    }
    const totalLabel = total === 1 ? '1 entry' : `${total} entries`;
    container.innerHTML = `<button type="button" class="journal-page-btn" data-dir="prev" ${page <= 1 ? 'disabled' : ''}><i class="fa fa-chevron-left"></i></button><span class="journal-page-info">Page ${page} of ${pages} • ${totalLabel}</span><button type="button" class="journal-page-btn" data-dir="next" ${page >= pages ? 'disabled' : ''}><i class="fa fa-chevron-right"></i></button>`;
    container.querySelectorAll('.journal-page-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const dir = btn.dataset.dir;
        if (dir === 'prev' && page > 1) loadJournalEntries(page - 1);
        if (dir === 'next' && page < pages) loadJournalEntries(page + 1);
      });
    });
  }

  function openJournalEditor(entryId){
    const entry = JOURNAL_STATE.byId.get(entryId);
    if (!entry){
      setJournalFeedback('Journal entry not found.', 'error');
      return;
    }
    JOURNAL_STATE.selectedId = entryId;
    renderJournalTable(JOURNAL_STATE.entries);
    renderJournalEditor(entry);
  }

  function renderJournalEditor(entry){
    const editor = document.getElementById('journal-editor');
    if (!editor) return;
    if (!entry){
      editor.innerHTML = '<div class="journal-editor-empty"><i class="fa fa-circle-info"></i> Select a journal entry to review or edit.</div>';
      return;
    }
    const iso = entry.date_iso || '';
    editor.innerHTML = `
      <div class="journal-editor-form">
        <div class="journal-field">
          <label for="journal-edit-date">Date</label>
          <input type="date" id="journal-edit-date" value="${iso}">
        </div>
        <div class="journal-field">
          <label for="journal-edit-description">Description</label>
          <input type="text" id="journal-edit-description" value="${escapeHtml(entry.description || '')}" placeholder="Entry description">
        </div>
        <div class="journal-field">
          <label for="journal-edit-reference">Reference</label>
          <input type="text" id="journal-edit-reference" value="${escapeHtml(entry.reference || '')}" placeholder="Optional reference">
        </div>
        <div class="journal-lines-box">
          <div class="journal-line-header"><div>Account</div><div>Type</div><div>Amount</div><div>Memo</div><div></div></div>
          <div id="journal-lines-body"></div>
          <div id="journal-lines-total" class="journal-lines-total"></div>
        </div>
        <div id="journal-editor-message" class="journal-editor-message"></div>
        <div class="journal-editor-actions">
          <button type="button" class="icon-btn" id="journal-add-line"><i class="fa fa-plus"></i> Add line</button>
          <div style="flex:1"></div>
          <button type="button" class="icon-btn" id="journal-save"><i class="fa fa-save"></i> Save Changes</button>
          <button type="button" class="icon-btn" id="journal-cancel"><i class="fa fa-circle-xmark"></i> Cancel</button>
        </div>
      </div>
    `;
    const body = editor.querySelector('#journal-lines-body');
    const lines = (entry.lines && entry.lines.length ? entry.lines : [{ dc: 'D', amount: 0, account_name: '', memo: '' }, { dc: 'C', amount: 0, account_name: '', memo: '' }]);
    lines.forEach(line => body.appendChild(createJournalLineRow(line)));
    refreshJournalLineControls();
    const addBtn = editor.querySelector('#journal-add-line');
    if (addBtn) addBtn.addEventListener('click', () => {
      body.appendChild(createJournalLineRow({ dc: 'D', amount: 0, account_name: '', memo: '' }));
      refreshJournalLineControls();
    });
    const saveBtn = editor.querySelector('#journal-save');
    if (saveBtn) saveBtn.addEventListener('click', () => submitJournalEdit(entry.id));
    const cancelBtn = editor.querySelector('#journal-cancel');
    if (cancelBtn) cancelBtn.addEventListener('click', () => {
      JOURNAL_STATE.selectedId = null;
      renderJournalTable(JOURNAL_STATE.entries);
      renderJournalEditor(null);
    });
  }

  function createJournalLineRow(line){
    const row = document.createElement('div');
    row.className = 'journal-line-row';
    const hasAmount = line.amount != null && Math.abs(Number(line.amount)) > 0;
    const amt = hasAmount ? Number(line.amount).toFixed(2) : '';
    row.innerHTML = `
      <div><input type="text" class="journal-line-account" value="${escapeHtml(line.account_name || '')}" list="journal-account-options" placeholder="Account"></div>
      <div><select class="journal-line-dc"><option value="D">Debit</option><option value="C">Credit</option></select></div>
      <div><input type="number" class="journal-line-amount" step="0.01" min="0" value="${amt}"></div>
      <div><input type="text" class="journal-line-memo" value="${escapeHtml(line.memo || '')}" placeholder="Memo (optional)"></div>
      <div style="text-align:right;"><button type="button" class="icon-btn journal-line-remove"><i class="fa fa-trash"></i></button></div>
    `;
    const dcSelect = row.querySelector('.journal-line-dc');
    dcSelect.value = (line.dc === 'C') ? 'C' : 'D';
    const removeBtn = row.querySelector('.journal-line-remove');
    removeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      row.remove();
      refreshJournalLineControls();
    });
    const amountInput = row.querySelector('.journal-line-amount');
    amountInput.addEventListener('input', updateJournalTotals);
    dcSelect.addEventListener('change', updateJournalTotals);
    return row;
  }

  function refreshJournalLineControls(){
    updateJournalTotals();
    const body = document.getElementById('journal-lines-body');
    if (!body) return;
    const rows = Array.from(body.querySelectorAll('.journal-line-row'));
    const allowRemove = rows.length > 2;
    rows.forEach(row => {
      const btn = row.querySelector('.journal-line-remove');
      if (btn){
        btn.disabled = !allowRemove;
        btn.title = allowRemove ? 'Remove line' : 'At least two lines are required';
      }
    });
  }

  function updateJournalTotals(){
    const body = document.getElementById('journal-lines-body');
    const totalsEl = document.getElementById('journal-lines-total');
    if (!body || !totalsEl) return;
    let debit = 0;
    let credit = 0;
    body.querySelectorAll('.journal-line-row').forEach(row => {
      const amountInput = row.querySelector('.journal-line-amount');
      const dcSelect = row.querySelector('.journal-line-dc');
      const val = parseFloat(amountInput.value || '0');
      if (!Number.isFinite(val) || val <= 0) return;
      if ((dcSelect.value || 'D') === 'C') credit += val;
      else debit += val;
    });
    const diff = debit - credit;
    const diffClass = Math.abs(diff) < 0.005 ? 'balanced' : 'journal-total-mismatch';
    totalsEl.innerHTML = `<span>Debits: ${formatCurrency(debit)}</span><span>Credits: ${formatCurrency(credit)}</span><span class="${diffClass}">Difference: ${formatCurrency(diff)}</span>`;
  }

  function collectJournalLines(){
    const body = document.getElementById('journal-lines-body');
    if (!body) return [];
    const rows = Array.from(body.querySelectorAll('.journal-line-row'));
    return rows.map(row => {
      const accountInput = row.querySelector('.journal-line-account');
      const amountInput = row.querySelector('.journal-line-amount');
      const memoInput = row.querySelector('.journal-line-memo');
      const dcSelect = row.querySelector('.journal-line-dc');
      const accountName = (accountInput.value || '').trim();
      const amountVal = parseFloat(amountInput.value || '0');
      const accountId = accountName ? JOURNAL_ACCOUNT_INDEX.map.get(accountName.toLowerCase()) : null;
      return {
        account: accountName,
        account_id: accountId,
        dc: (dcSelect.value || 'D'),
        amount: Number.isFinite(amountVal) ? Number(amountVal.toFixed(2)) : 0,
        memo: (memoInput.value || '').trim()
      };
    });
  }

  async function submitJournalEdit(entryId){
    const messageEl = document.getElementById('journal-editor-message');
    if (messageEl){ messageEl.textContent = ''; messageEl.dataset.tone = ''; }
    const dateInput = document.getElementById('journal-edit-date');
    const descInput = document.getElementById('journal-edit-description');
    const refInput = document.getElementById('journal-edit-reference');
    const dateVal = (dateInput && dateInput.value) ? dateInput.value.trim() : '';
    const descVal = (descInput && descInput.value) ? descInput.value.trim() : '';
    const referenceVal = refInput ? refInput.value.trim() : '';
    const lines = collectJournalLines();
    const showMessage = (text, tone='error') => {
      if (messageEl){
        messageEl.textContent = text;
        messageEl.dataset.tone = tone;
      }
    };
    if (!dateVal){ showMessage('Date is required.'); return; }
    if (!descVal){ showMessage('Description is required.'); return; }
    if (!lines || lines.length < 2){ showMessage('At least two lines are required.'); return; }
    let debit = 0;
    let credit = 0;
    for (const ln of lines){
      if (!ln.account){ showMessage('Account name is required for each line.'); return; }
      if (!Number.isFinite(ln.amount) || ln.amount <= 0){ showMessage('Amounts must be greater than zero.'); return; }
      if ((ln.dc || 'D') === 'C') credit += ln.amount;
      else debit += ln.amount;
    }
    if (Math.abs(debit - credit) > 0.005){ showMessage('Debits and credits must balance.'); return; }
    try {
      const res = await fetch(`/accounting/journal/${entryId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (window.ACC_BOOT && window.ACC_BOOT.csrfToken) || '' },
        body: JSON.stringify({ date: dateVal, description: descVal, reference: referenceVal, lines })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok){
        throw new Error(data.error || 'Failed to save journal entry.');
      }
      if (data.entry){
        JOURNAL_STATE.byId.set(data.entry.id, data.entry);
        const idx = JOURNAL_STATE.entries.findIndex(e => e.id === data.entry.id);
        if (idx !== -1){
          JOURNAL_STATE.entries[idx] = data.entry;
        } else {
          JOURNAL_STATE.entries.unshift(data.entry);
        }
        JOURNAL_STATE.selectedId = data.entry.id;
        renderJournalTable(JOURNAL_STATE.entries);
        renderJournalEditor(data.entry);
      }
      showMessage('Journal entry saved.', 'success');
      setJournalFeedback('Journal entry saved.', 'success');
    } catch (err){
      console.error(err);
      const msg = err && err.message ? err.message : 'Failed to save journal entry.';
      showMessage(msg);
      setJournalFeedback(msg, 'error');
    }
  }

  function ensureJournalLoaded(){
    if (!JOURNAL_STATE.loaded && !JOURNAL_STATE.loading){
      loadJournalEntries(1);
    }
  }
  window.ensureJournalLoaded = ensureJournalLoaded;

  document.addEventListener('DOMContentLoaded', () => {
    const applyBtn = document.getElementById('journal-apply');
    if (applyBtn) applyBtn.addEventListener('click', (e) => { e.preventDefault(); loadJournalEntries(1); });
    const resetBtn = document.getElementById('journal-reset');
    if (resetBtn) resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const search = document.getElementById('journal-search'); if (search) search.value = '';
      const start = document.getElementById('journal-start'); if (start) start.value = '';
      const end = document.getElementById('journal-end'); if (end) end.value = '';
      const account = document.getElementById('journal-account'); if (account) account.value = '';
      loadJournalEntries(1);
    });
    const search = document.getElementById('journal-search');
    if (search) search.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ e.preventDefault(); loadJournalEntries(1); }
    });
    // Initialize Trial Balance UI when switching to the tab or when stored view is 'trial'
    const trialBtn = document.getElementById('btn-view-trial');
    if (trialBtn){ trialBtn.addEventListener('click', () => { initMonthlyTrialUI(); }); }
    const storedView = localStorage.getItem('acc.view');
    if (storedView === 'trial') { setTimeout(initMonthlyTrialUI, 0); }
    const pdfBtn = document.getElementById('tb-month-pdf');
    if (pdfBtn){
      pdfBtn.addEventListener('click', () => {
        const sel = document.getElementById('tb-month-select');
        const ym = sel ? (sel.value || '') : '';
        if (!ym){ alert('Select a month first.'); return; }
        const scopeSel = document.getElementById('tb-report-scope');
        const scope = scopeSel ? (scopeSel.value || 'folders') : 'folders';
        const ccySel = document.getElementById('tb-ccy-select');
        const ccy = ccySel ? (ccySel.value || '') : '';
        const url = `/accounting/tb/pdf?ym=${encodeURIComponent(ym)}&org=${encodeURIComponent('Taeyang Finance')}&scope=${encodeURIComponent(scope)}${ccy ? ('&ccy='+encodeURIComponent(ccy)) : ''}`;
        window.open(url, '_blank');
      });
    }
  });
</script>
<script>
  // Fixed Trial Balance tab visibility and clear button functionality
  document.addEventListener('DOMContentLoaded', () => {
    const clearBtn = document.getElementById('tb-month-clear');
    const monthPicker = document.getElementById('tb-month-picker');
    const resultsBox = document.getElementById('tb-monthly-results');

    if (clearBtn && monthPicker) {
      clearBtn.addEventListener('click', () => {
        monthPicker.value = '';
        resultsBox.innerHTML = '<div style="font-size:13px;color:#1a4d2e;opacity:.8;">Select a month to view your trial balance.</div>';
      });
    }

    applySummaryVisibility();
  });
</script>

</div> {# close .acc-shell #}
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}
